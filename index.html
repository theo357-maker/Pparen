 <!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Espace Parent - CS la Colombe</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<!-- PWA Meta Tags -->
  <meta name="application-name" content="TheoV√™t">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="TheoV√™t">
  <meta name="description" content="Solution compl√®te de gestion de commerce de v√™tements">
  <meta name="format-detection" content="telephone=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="msapplication-TileColor" content="#3498db">
  <meta name="msapplication-tap-highlight" content="no">
  <meta name="theme-color" content="#3498db">

   <!-- Service Worker et mise √† jour -->
    <meta name="version" content="2.1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">


  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="icon-192x192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="icon-192x192.png">
  <link rel="apple-touch-icon" sizes="72x72" href="icon-72x72.png">
  <link rel="apple-touch-icon" sizes="167x167" href="icon-167x167.png">

  <!-- Manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- Styles et Biblioth√®ques -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<!-- Scripts de mise √† jour -->
<script src="update-system.js"></script>

<script>
// ============================================
// GESTION DES BADGES ET NOTIFICATIONS TEMPS R√âEL
// ============================================

// Configuration initiale
document.addEventListener('DOMContentLoaded', function() {
  console.log('üöÄ Initialisation syst√®me notifications temps r√©el');
  
  // Ajouter les styles pour les badges
  addNotificationStyles();
  
  // Cr√©er le badge visible
  createAppBadge();
  
  // Initialiser le Service Worker
  initializeServiceWorker();
  
  // D√©marrer la surveillance r√©seau
  startNetworkMonitoring();
});

// Ajouter les styles CSS
function addNotificationStyles() {
  const style = document.createElement('style');
  style.textContent = `
    /* Badge visible */
    .app-visible-badge {
      animation: badge-pulse 1.5s infinite;
    }
    
    @keyframes badge-pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    /* Badge dans le header */
    #notification-count {
      animation: badge-pulse 1.5s infinite;
    }
    
    /* Badge dans le menu */
    .menu-badge {
      animation: badge-pulse 1.5s infinite;
    }
    
    /* Notification toast */
    .notification-toast {
      animation: slide-in 0.3s ease;
    }
    
    @keyframes slide-in {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }
  `;
  document.head.appendChild(style);
}

// Cr√©er le badge de l'application
function createAppBadge() {
  if (document.getElementById('app-visible-badge')) return;
  
  const badge = document.createElement('div');
  badge.id = 'app-visible-badge';
  badge.className = 'app-visible-badge';
  badge.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #e74c3c;
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: none;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    z-index: 99999;
    cursor: pointer;
  `;
  badge.textContent = '0';
  
  badge.addEventListener('click', function() {
    // Ouvrir la page des notifications
    const link = document.querySelector('[data-page="notifications"]');
    if (link) link.click();
  });
  
  document.body.appendChild(badge);
}

// Initialiser le Service Worker
async function initializeServiceWorker() {
  if (!('serviceWorker' in navigator)) {
    console.warn('‚ö†Ô∏è Service Worker non support√©');
    return;
  }
  
  try {
    // Enregistrer le Service Worker unifi√©
    const registration = await navigator.serviceWorker.register('/sw.js', {
      scope: '/',
      updateViaCache: 'none'
    });
    
    console.log('‚úÖ Service Worker enregistr√©:', registration.scope);
    
    // Attendre l'activation
    if (registration.installing) {
      registration.installing.addEventListener('statechange', function() {
        if (this.state === 'activated') {
          console.log('üöÄ Service Worker activ√©');
          
          // Demander le badge initial
          setTimeout(() => {
            getInitialBadgeCount();
          }, 1000);
        }
      });
    } else if (registration.active) {
      console.log('‚úÖ Service Worker d√©j√† actif');
      getInitialBadgeCount();
    }
    
    // V√©rifier les mises √† jour
    registration.addEventListener('updatefound', () => {
      const newWorker = registration.installing;
      console.log('üîÑ Nouveau Service Worker trouv√©');
      
      newWorker.addEventListener('statechange', () => {
        if (newWorker.state === 'activated') {
          console.log('üîÑ Service Worker mis √† jour');
          window.location.reload();
        }
      });
    });
    
    // Surveiller les messages
    navigator.serviceWorker.addEventListener('message', (event) => {
      handleServiceWorkerMessage(event.data);
    });
    
  } catch (error) {
    console.error('‚ùå Erreur Service Worker:', error);
  }
}

// Obtenir le compte initial des badges
async function getInitialBadgeCount() {
  if (!('serviceWorker' in navigator) || !navigator.serviceWorker.controller) {
    return;
  }
  
  try {
    const channel = new MessageChannel();
    
    channel.port1.onmessage = (event) => {
      if (event.data.type === 'BADGE_COUNT') {
        const count = event.data.count || 0;
        updateBadgeDisplay(count);
      }
    };
    
    navigator.serviceWorker.controller.postMessage({
      type: 'GET_BADGE_COUNT'
    }, [channel.port2]);
    
  } catch (error) {
    console.error('‚ùå Erreur r√©cup√©ration badge:', error);
  }
}

// G√©rer les messages du Service Worker
function handleServiceWorkerMessage(data) {
  const { type, data: messageData } = data || {};
  
  switch (type) {
    case 'BADGE_UPDATED':
      updateBadgeDisplay(messageData.count);
      showBadgeToast(messageData.count);
      break;
      
    case 'NOTIFICATION_CLICKED':
      handleNotificationNavigation(messageData);
      break;
      
    case 'PONG':
      console.log('‚úÖ Service Worker actif');
      break;
  }
}

// Mettre √† jour l'affichage du badge
function updateBadgeDisplay(count) {
  // Badge visible
  const visibleBadge = document.getElementById('app-visible-badge');
  if (visibleBadge) {
    if (count > 0) {
      visibleBadge.textContent = count > 99 ? '99+' : count.toString();
      visibleBadge.style.display = 'flex';
    } else {
      visibleBadge.style.display = 'none';
    }
  }
  
  // Badge header
  const headerBadge = document.getElementById('notification-count');
  if (headerBadge) {
    if (count > 0) {
      headerBadge.textContent = count > 99 ? '99+' : count.toString();
      headerBadge.classList.remove('hidden');
    } else {
      headerBadge.classList.add('hidden');
    }
  }
  
  // Badge PWA
  updatePWAAppBadge(count);
  
  // Titre
  updateDocumentTitle(count);
}

// Mettre √† jour le badge PWA
async function updatePWAAppBadge(count) {
  if (!('setAppBadge' in navigator)) return;
  
  try {
    if (count > 0) {
      await navigator.setAppBadge(count);
    } else {
      await navigator.clearAppBadge();
    }
  } catch (error) {
    console.error('‚ùå Erreur badge PWA:', error);
  }
}

// Mettre √† jour le titre du document
function updateDocumentTitle(count) {
  const baseTitle = 'CS La Colombe - Espace Parent';
  document.title = count > 0 ? `(${count}) ${baseTitle}` : baseTitle;
}

// Afficher un toast pour les nouveaux badges
function showBadgeToast(count) {
  if (count <= 0 || document.hidden) return;
  
  const toast = document.createElement('div');
  toast.className = 'notification-toast info';
  toast.innerHTML = `
    <div class="notification-header">
      <div class="notification-title">
        <i class="fas fa-bell"></i> Nouvelle notification
      </div>
      <button class="notification-close">&times;</button>
    </div>
    <div class="notification-body">
      <p>Vous avez ${count} nouvelle(s) notification(s)</p>
      <div class="notification-actions" style="margin-top: 10px;">
        <button class="btn btn-primary btn-sm" id="view-notifications-btn">
          <i class="fas fa-eye"></i> Voir
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.classList.add('show');
  }, 100);
  
  // Bouton Voir
  document.getElementById('view-notifications-btn').addEventListener('click', () => {
    const link = document.querySelector('[data-page="notifications"]');
    if (link) link.click();
    toast.remove();
  });
  
  // Fermer
  toast.querySelector('.notification-close').addEventListener('click', () => {
    toast.remove();
  });
  
  // Fermer automatiquement
  setTimeout(() => {
    if (toast.parentNode) {
      toast.remove();
    }
  }, 5000);
}

// G√©rer la navigation depuis les notifications
function handleNotificationNavigation(data) {
  if (!data || !data.data) return;
  
  const page = data.data.page;
  const childId = data.data.childId;
  
  // Trouver le lien
  const link = document.querySelector(`[data-page="${page}"]`);
  if (link) {
    link.click();
    
    // S√©lectionner l'enfant si sp√©cifi√©
    if (childId) {
      setTimeout(() => {
        const selector = document.getElementById(`${page}-child-selector`);
        if (selector) {
          selector.value = childId;
          selector.dispatchEvent(new Event('change'));
        }
      }, 1000);
    }
  }
}

// D√©marrer la surveillance r√©seau
function startNetworkMonitoring() {
  let lastOnlineStatus = navigator.onLine;
  
  // V√©rifier p√©riodiquement
  setInterval(() => {
    const currentOnlineStatus = navigator.onLine;
    
    if (currentOnlineStatus !== lastOnlineStatus) {
      lastOnlineStatus = currentOnlineStatus;
      
      if (currentOnlineStatus) {
        console.log('üåê Connexion r√©tablie');
        onConnectionRestored();
      } else {
        console.log('üì¥ Perte de connexion');
      }
    }
  }, 5000);
  
  // √âv√©nements navigateur
  window.addEventListener('online', onConnectionRestored);
  window.addEventListener('offline', () => {
    showOfflineToast();
  });
}

// Quand la connexion est r√©tablie
function onConnectionRestored() {
  // Synchroniser les notifications en attente
  if (window.notificationManager) {
    window.notificationManager.syncPendingNotifications();
  }
  
  // V√©rifier les mises √† jour
  if (window.notificationManager) {
    window.notificationManager.checkAllUpdates();
  }
  
  // Reconnecter Firebase
  if (window.firebaseNotifications && window.currentParent) {
    setTimeout(() => {
      const status = window.firebaseNotifications.getStatus();
      if (!status.initialized) {
        console.log('üîÑ Reconnexion Firebase...');
        window.firebaseNotifications.initialize(window.currentParent.matricule);
      }
    }, 2000);
  }
  
  showOnlineToast();
}

// Afficher un toast de connexion
function showOnlineToast() {
  if (document.hidden) return;
  
  const toast = document.createElement('div');
  toast.className = 'notification-toast success';
  toast.innerHTML = `
    <div class="notification-header">
      <div class="notification-title">
        <i class="fas fa-wifi"></i> Connexion r√©tablie
      </div>
      <button class="notification-close">&times;</button>
    </div>
    <div class="notification-body">
      <p>Synchronisation des donn√©es en cours...</p>
    </div>
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.classList.add('show');
  }, 100);
  
  toast.querySelector('.notification-close').addEventListener('click', () => {
    toast.remove();
  });
  
  setTimeout(() => {
    if (toast.parentNode) {
      toast.remove();
    }
  }, 3000);
}

// Afficher un toast hors ligne
function showOfflineToast() {
  if (document.hidden) return;
  
  const toast = document.createElement('div');
  toast.className = 'notification-toast warning';
  toast.innerHTML = `
    <div class="notification-header">
      <div class="notification-title">
        <i class="fas fa-wifi-slash"></i> Hors ligne
      </div>
      <button class="notification-close">&times;</button>
    </div>
    <div class="notification-body">
      <p>Les notifications seront sauvegard√©es localement.</p>
    </div>
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.classList.add('show');
  }, 100);
  
  toast.querySelector('.notification-close').addEventListener('click', () => {
    toast.remove();
  });
  
  setTimeout(() => {
    if (toast.parentNode) {
      toast.remove();
    }
  }, 5000);
}

// ============================================
// FONCTIONS DE TEST
// ============================================

// Tester toutes les notifications
window.testAllNotifications = function() {
  console.log('üß™ Test complet du syst√®me');
  
  // Tester Firebase
  if (window.firebaseNotifications) {
    window.firebaseNotifications.sendTestNotification();
  }
  
  // Tester le gestionnaire
  if (window.notificationManager) {
    window.notificationManager.test();
  }
  
  // Tester le Service Worker
  if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
    navigator.serviceWorker.controller.postMessage({
      type: 'TEST_BACKGROUND'
    });
  }
};

// V√©rifier l'√©tat du syst√®me
window.checkNotificationStatus = function() {
  console.group('üîç √âtat du syst√®me de notifications');
  
  // √âtat Firebase
  if (window.firebaseNotifications) {
    console.log('Firebase:', window.firebaseNotifications.getStatus());
  }
  
  // √âtat gestionnaire
  if (window.notificationManager) {
    console.log('Manager:', window.notificationManager.getStatus());
  }
  
  // √âtat Service Worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistration().then(registration => {
      console.log('Service Worker:', registration ? 'Enregistr√©' : 'Non enregistr√©');
      if (registration) {
        console.log('Scope:', registration.scope);
        console.log('√âtat:', registration.active?.state);
      }
    });
  }
  
  // Permission
  console.log('Permission:', Notification.permission);
  
  // Badge support
  console.log('Badge support:', 'setAppBadge' in navigator);
  
  // R√©seau
  console.log('En ligne:', navigator.onLine);
  
  console.groupEnd();
};

// Nettoyer toutes les notifications
window.clearAllNotifications = function() {
  if (window.notificationManager) {
    window.notificationManager.markAllAsRead();
  }
  
  // Nettoyer le badge PWA
  if ('setAppBadge' in navigator) {
    navigator.clearAppBadge();
  }
  
  // Nettoyer l'affichage
  updateBadgeDisplay(0);
  
  console.log('‚úÖ Toutes les notifications effac√©es');
};

console.log('‚úÖ Syst√®me de badges initialis√©');
</script>

<!-- Service Worker UNIQUE -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try {
      // Enregistrer le SW UNIQUE
      const registration = await navigator.serviceWorker.register('./sw.js', {
        scope: './',
        updateViaCache: 'none'
      });
      
      console.log('‚úÖ SW enregistr√©:', registration.scope);
      
      // Forcer l'activation
      registration.addEventListener('updatefound', () => {
        const newWorker = registration.installing;
        newWorker.addEventListener('statechange', () => {
          if (newWorker.state === 'activated') {
            console.log('üöÄ SW activ√© - Notifications pr√™tes');
          }
        });
      });
      
    } catch (error) {
      console.error('‚ùå Erreur SW:', error);
    }
  });
}
</script>

  

    <style>
        :root {
            --primary: #3498db; --secondary: #2c3e50; --success: #27ae60;
            --danger: #e74c3c; --warning: #f39c12; --info: #1abc9c;
            --light: #ecf0f1; --dark: #34495e;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f5f6fa; }
        .hidden { display: none !important; }

        /* --- Styles Communs --- */
        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .login-card { background: white; padding: 2rem; border-radius: 10px; width: 90%; max-width: 400px; text-align: center; }
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: 250px; background: white; box-shadow: 2px 0 10px rgba(0,0,0,0.08); flex-shrink: 0; transition: transform 0.3s ease; }
        .sidebar.collapsed { transform: translateX(-100%); }
        .nav-menu { list-style: none; padding: 1rem 0; margin: 0; }
        .nav-menu li { position: relative; }
        .nav-menu li a { display: flex; align-items: center; gap: 12px; padding: 14px 20px; color: var(--dark); text-decoration: none; font-weight: 500; }
        .nav-menu li a.active, .nav-menu li a:hover { background: #eaf5fc; color: var(--primary); }
        .main-content { flex: 1; display: flex; flex-direction: column; }
        .app-header { background: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        .content-area { padding: 1.5rem; flex: 1; }
        .page { display: none; }
        .page.active { display: block; }

/* Styles pour les badges de notification */
.notification-dot {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 12px;
    height: 12px;
    background-color: var(--danger);
    border-radius: 50%;
    animation: pulse 1.5s infinite;
    border: 2px solid white;
}

.notification-dot.small {
    width: 8px;
    height: 8px;
    top: 5px;
    right: 5px;
}

/* Animation pour les nouvelles notifications */
@keyframes highlight {
    0% { background-color: rgba(52, 152, 219, 0.1); }
    100% { background-color: transparent; }
}

.new-notification {
    animation: highlight 2s ease-in-out;
}

/* Styles pour les notifications en plein √©cran */
.fullscreen-notification {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 99999;
    padding: 20px;
    color: white;
    text-align: center;
}

/* Ajoutez dans la section CSS de parent.html */
.communique-card.expiring-soon {
    animation: pulse-border-expiring 2s infinite;
    border-left-color: var(--warning);
}

@keyframes pulse-border-expiring {
    0% { border-left-color: var(--warning); }
    50% { border-left-color: #ff9f43; }
    100% { border-left-color: var(--warning); }
}

/* Ajoutez dans le CSS existant */

.file-preview {
    margin: 1rem 0;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid var(--info);
}



/* Styles pour les notifications de mise √† jour */
.update-toast {
  position: fixed;
  top: 20px;
  right: 20px;
  background: white;
  border-left: 4px solid #3498db;
  border-radius: 8px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.15);
  padding: 15px 20px;
  min-width: 300px;
  max-width: 400px;
  z-index: 9999;
  transform: translateX(120%);
  transition: transform 0.3s ease;
}

.update-toast.show {
  transform: translateX(0);
}

.update-toast.success {
  border-left-color: #27ae60;
}

.update-toast.warning {
  border-left-color: #f39c12;
}

.update-toast.danger {
  border-left-color: #e74c3c;
}

/* Badges d'application */
.app-badge {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #e74c3c;
  color: white;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: bold;
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  z-index: 99999;
  animation: pulse 1.5s infinite;
}

/* Animation pour badges */
@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}

/* Badge dans le header */
#notification-count {
  position: absolute;
  top: -5px;
  right: -5px;
  background: #e74c3c;
  color: white;
  border-radius: 50%;
  width: 18px;
  height: 18px;
  font-size: 11px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  animation: pulse 1.5s infinite;
}

/* Badges sur les items du menu */
.nav-menu .notification-dot {
  position: absolute;
  top: 10px;
  right: 15px;
  width: 8px;
  height: 8px;
  background: #e74c3c;
  border-radius: 50%;
  border: 2px solid white;
}

.update-toast.info {
  border-left-color: #3498db;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

.update-available {
  animation: pulse 2s infinite;
}


.file-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.5rem;
}

.file-icon {
    font-size: 2rem;
    color: var(--info);
}

.file-details h5 {
    margin: 0;
    color: var(--dark);
}

.file-details small {
    color: #666;
}

.file-preview-img {
    max-width: 100%;
    max-height: 300px;
    border: 1px solid #ddd;
    border-radius: 5px;
    margin-top: 1rem;
}

.fullscreen-notification h3 {
    font-size: 1.5rem;
    margin-bottom: 1rem;
    color: white;
}

.fullscreen-notification p {
    font-size: 1.1rem;
    margin-bottom: 2rem;
    max-width: 500px;
}

/* Badge sur l'ic√¥ne de l'application */
.app-badge {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--danger);
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: bold;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    z-index: 9999;
}
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: 500; color: white; }
        .btn-primary { background: var(--primary); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        .btn-warning { background: var(--warning); }
        .btn-info { background: var(--info); }
        .btn-sm { padding: 6px 12px; font-size: 0.85rem; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 1.5rem; }
        .form-row { display: flex; gap: 1rem; }
        .alert { padding: 1rem; border-radius: 5px; margin-bottom: 1rem; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-error { background: #f8d7da; color: #721c24; }
        .alert-info { background: #d1ecf1; color: #0c5460; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 1.5rem; border-radius: 10px; width: 90%; max-width: 400px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .close-modal { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 500; }
        .badge-success { background-color: var(--success); color: white; }
        .badge-warning { background-color: var(--warning); color: white; }
        .badge-danger { background-color: var(--danger); color: white; }
        
        /* --- Styles pour le profil --- */
        .parent-profile { display: flex; align-items: center; gap: 1rem; }
        .parent-photo { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }
        .parent-photo-placeholder { width: 40px; height: 40px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; color: #999; }
        .photo-upload { text-align: center; margin: 1rem 0; }
        .photo-preview { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); margin: 0 auto 1rem; display: block; }
        .photo-placeholder { width: 100px; height: 100px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; color: #999; }
        .file-input { display: none; }
        .upload-btn { background: var(--info); color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; }
        
        /* --- Styles pour le re√ßu --- */
        .receipt { max-width: 500px; margin: 0 auto; background: white; padding: 1.5rem; border: 1px solid #ddd; font-family: Arial, sans-serif; font-size: 0.9rem; }
        .receipt-header { text-align: center; margin-bottom: 1.5rem; }
        .receipt-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 0.5rem; }
        .receipt-details { margin-bottom: 1.5rem; }
        .receipt-row { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        .receipt-divider { border-top: 1px solid #ddd; margin: 1rem 0; }
        .receipt-footer { text-align: center; margin-top: 1.5rem; font-size: 0.8rem; color: #666; }
        
        /* --- Styles pour l'activation de compte --- */
        .activation-steps { display: flex; justify-content: space-between; margin-bottom: 2rem; position: relative; }
        .activation-steps::before { content: ''; position: absolute; top: 20px; left: 0; right: 0; height: 2px; background: #ddd; z-index: 1; }
        .step { text-align: center; position: relative; z-index: 2; flex: 1; }
        .step-number { width: 40px; height: 40px; border-radius: 50%; background: #ddd; display: flex; align-items: center; justify-content: center; margin: 0 auto 0.5rem; font-weight: bold; }
        .step.active .step-number { background: var(--primary); color: white; }
        .step.completed .step-number { background: var(--success); color: white; }
        .step-label { font-size: 0.8rem; color: #666; }
        .step.active .step-label { color: var(--primary); font-weight: 500; }
        
        .child-item { background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid var(--primary); }
        .child-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .child-actions { display: flex; gap: 0.5rem; }
        
        /* --- Styles pour le tableau des notes --- */
        .grade-red { background-color: #ffebee; color: #c62828; font-weight: bold; }
        .grade-green { background-color: #e8f5e8; color: #2e7d32; font-weight: bold; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.9rem; }
        th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; font-weight: 600; }
        tr:hover { background-color: #f8f9fa; }

        /* --- Styles pour les pr√©sences et incidents --- */
        .presence-section { margin-bottom: 2rem; }
        .presence-controls { background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; }
        .presence-controls-row { display: flex; gap: 1rem; align-items: end; flex-wrap: wrap; }
        .presence-controls .form-group { margin-bottom: 0; flex: 1; min-width: 150px; }
        
        .attendance-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 0.5rem; margin-top: 1rem; }
        .attendance-day { padding: 0.8rem 0.5rem; border-radius: 8px; text-align: center; font-size: 0.8rem; font-weight: 500; border: 2px solid transparent; }
        .attendance-present { background-color: #e8f5e8; color: #2e7d32; border-color: #c8e6c9; }
        .attendance-absent { background-color: #ffebee; color: #c62828; border-color: #ffcdd2; }
        .attendance-late { background-color: #fff3e0; color: #ef6c00; border-color: #ffe0b2; }
        .attendance-empty { background-color: #f8f9fa; color: #6c757d; border: 1px dashed #dee2e6; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1.5rem 0; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 8px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .stat-number { font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem; }
        .stat-label { font-size: 0.9rem; color: #666; }
        
        .incident-item { border-left: 4px solid var(--warning); padding: 1.5rem; margin-bottom: 1rem; background: white; border-radius: 0 8px 8px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .incident-item.severity-eleve { border-left-color: var(--danger); }
        .incident-item.severity-moyen { border-left-color: var(--warning); }
        .incident-item.severity-faible { border-left-color: var(--info); }
        
        .incident-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.8rem; flex-wrap: wrap; gap: 0.5rem; }
        .incident-type { font-weight: bold; color: var(--dark); font-size: 1.1rem; }
        .incident-date { color: #666; font-size: 0.9rem; background: #f8f9fa; padding: 0.3rem 0.8rem; border-radius: 15px; }
        .incident-description { margin: 1rem 0; line-height: 1.5; color: #444; }
        .incident-severity { display: inline-block; padding: 0.4rem 1rem; border-radius: 20px; font-size: 0.8rem; font-weight: bold; margin-right: 0.5rem; }
        .severity-eleve { background-color: var(--danger); color: white; }
        .severity-moyen { background-color: var(--warning); color: white; }
        .severity-faible { background-color: var(--info); color: white; }
        
        .no-data { text-align: center; padding: 3rem; color: #666; }
        .no-data i { font-size: 3rem; margin-bottom: 1rem; color: #ddd; }
        
        .loading { text-align: center; padding: 2rem; color: #666; }
        .loading i { font-size: 2rem; margin-bottom: 1rem; color: var(--primary); animation: spin 1s linear infinite; }
        
        /* --- Styles pour les horaires de classe --- */
        .class-schedule-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .class-schedule-table th, .class-schedule-table td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        .class-schedule-table th { background-color: var(--primary); color: white; font-weight: 600; }
        .class-schedule-table .hour-header { background-color: var(--info); color: white; }
        .class-schedule-table .day-header { background-color: var(--warning); color: white; }
        .schedule-controls { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .schedule-selector { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 1.5rem; }
        .no-schedule { text-align: center; padding: 2rem; color: #666; }
        .schedule-info { background: #e8f4fd; padding: 1rem; border-radius: 5px; margin-bottom: 1rem; }
        .timetable-section { margin-bottom: 2rem; }
        .timetable-section:last-child { margin-bottom: 0; }
        
        /* --- Styles pour les devoirs --- */
        .homework-list { margin-top: 1.5rem; }
        .homework-item { 
            border-left: 4px solid var(--info); 
            margin-bottom: 1rem; 
            padding: 1.5rem; 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .homework-item.overdue { border-left-color: var(--danger); }
        .homework-item.due-soon { border-left-color: var(--warning); }
        .homework-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
        .homework-title { font-size: 1.2rem; font-weight: 600; color: var(--dark); margin-bottom: 0.5rem; }
        .homework-meta { color: #666; font-size: 0.9rem; margin-bottom: 0.5rem; }
        .homework-description { margin-bottom: 1rem; line-height: 1.5; }
        .submission-status { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        .submission-pending { background-color: #fff3e0; color: #ef6c00; }
        .submission-submitted { background-color: #e8f5e8; color: #2e7d32; }
        .submission-overdue { background-color: #ffebee; color: #c62828; }
        .submission-graded { background-color: #e3f2fd; color: #1565c0; }
        
        .tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 1.5rem; }
        .tab { padding: 10px 20px; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab.active { border-bottom: 2px solid var(--primary); color: var(--primary); font-weight: 500; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* --- Styles pour les cotes primaires --- */
        .primary-grades-table th, .primary-grades-table td {
            text-align: center;
            padding: 10px;
        }



/* Styles pour le tableau de proclamation parent */
.parent-proclamation-table {
    width: 100%;
    border-collapse: collapse;
    margin: 1rem 0;
    font-size: 0.9rem;
}

.parent-proclamation-table th, 
.parent-proclamation-table td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: center;
}

.parent-proclamation-table th {
    background-color: var(--primary);
    color: white;
    font-weight: 600;
}

.parent-proclamation-table .sub-header {
    background-color: #e9ecef;
    font-weight: 500;
}

.parent-proclamation-table .grade-good {
    background-color: #e8f5e8;
    color: #2e7d32;
    font-weight: bold;
}

.parent-proclamation-table .grade-average {
    background-color: #fff3e0;
    color: #ef6c00;
    font-weight: bold;
}

.parent-proclamation-table .grade-poor {
    background-color: #ffebee;
    color: #c62828;
    font-weight: bold;
}

.parent-proclamation-table .total-row {
    background-color: #e3f2fd !important;
    font-weight: bold;
}

.parent-proclamation-table .ranking-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 50%;
    background-color: var(--primary);
    color: white;
    font-weight: bold;
    min-width: 30px;
    text-align: center;
}

.parent-proclamation-table .ranking-1 {
    background-color: #ffd700;
    color: #000;
}

.parent-proclamation-table .ranking-2 {
    background-color: #c0c0c0;
    color: #000;
}

.parent-proclamation-table .ranking-3 {
    background-color: #cd7f32;
    color: #000;
}

/* Styles pour les cellules de note */
.note-cell {
    font-weight: bold;
    font-size: 1rem;
}

/* Styles pour les r√©sum√©s */
.grades-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 15px;
    margin: 1.5rem 0;
}

.summary-card {
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    text-align: center;
    border-left: 4px solid var(--primary);
}

.summary-card h5 {
    margin-bottom: 8px;
    color: var(--dark);
    font-size: 0.9rem;
}

.summary-card .value {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--primary);
}

.summary-card .sub-value {
    font-size: 0.8rem;
    color: #666;
    margin-top: 5px;
}
        
        .primary-grades-table th {
            background-color: var(--primary);
            color: white;
        }
        
        .period-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .period-btn {
            padding: 8px 16px;
            border: 2px solid var(--primary);
            background: white;
            color: var(--primary);
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .period-btn.active {
            background: var(--primary);
            color: white;
        }
        
        .period-btn:hover {
            background: var(--primary);
            color: white;
        }
        
        /* --- Styles pour les sous-onglets --- */
        .sub-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 1.5rem;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
        }
        
        .sub-tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-weight: 500;
            transition: all 0.3s ease;
            border-radius: 8px 8px 0 0;
        }
        
        .sub-tab.active {
            border-bottom: 2px solid var(--primary);
            color: var(--primary);
            background: white;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
        }
        
        .sub-tab:hover:not(.active) {
            background: #e9ecef;
        }
        
        .sub-tab-content {
            display: none;
            padding: 1.5rem;
            background: white;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        .sub-tab-content.active {
            display: block;
        }
        
        /* --- Styles pour les devoirs primaires --- */
        .primary-homework-item {
            border-left: 4px solid var(--info);
            margin-bottom: 1rem;
            padding: 1.5rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .primary-homework-item .homework-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .primary-homework-item .homework-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }
        
        .primary-homework-item .homework-meta {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .primary-homework-item .homework-description {
            margin-bottom: 1rem;
            line-height: 1.5;
        }
        
        /* --- Styles pour les notifications --- */
        .notification-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            animation: pulse 1.5s infinite;
        }

/* --- Styles pour les communiqu√©s --- */
.communique-card {
    background: white;
    border-left: 4px solid var(--primary);
    margin-bottom: 1.5rem;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.communique-card.urgent {
    border-left-color: var(--danger);
    animation: pulse-border 2s infinite;
}

.communique-card.paid {
    border-left-color: var(--success);
    opacity: 0.8;
}

.communique-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.communique-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--dark);
    margin-bottom: 0.5rem;
}

.communique-meta {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 1rem;
}

.communique-meta span {
    margin-right: 1rem;
}

.communique-meta .badge {
    margin-right: 0.5rem;
}

.communique-content {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    margin: 1rem 0;
    font-family: 'Times New Roman', serif;
    line-height: 1.6;
}

.communique-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #eee;
    flex-wrap: wrap;
    gap: 1rem;
}

.communique-actions {
    display: flex;
    gap: 0.5rem;
}

@keyframes pulse-border {
    0% { border-left-color: var(--danger); }
    50% { border-left-color: #ff6b6b; }
    100% { border-left-color: var(--danger); }
}

/* Modal pour l'affichage complet du communiqu√© */
.communique-full-modal .modal-content {
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
}

.communique-full-content {
    font-family: 'Times New Roman', serif;
    line-height: 1.8;
}

.communique-full-header {
    text-align: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--primary);
}

.communique-full-logo {
    max-width: 120px;
    margin-bottom: 1rem;
}

.communique-full-title {
    font-size: 1.5rem;
    font-weight: bold;
    margin: 1rem 0;
    color: var(--dark);
}

.communique-full-date {
    text-align: right;
    font-style: italic;
    color: #666;
    margin-bottom: 2rem;
}

.communique-full-signature {
    margin-top: 3rem;
    text-align: right;
    padding-top: 1rem;
    border-top: 1px solid #ddd;
}

.signature-line {
    border-top: 1px solid #000;
    margin-top: 3rem;
    width: 300px;
    margin-left: auto;
}
        
        /* Notification Toast */
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-left: 4px solid var(--primary);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            padding: 15px 20px;
            min-width: 300px;
            max-width: 400px;
            z-index: 9999;
            transform: translateX(120%);
            transition: transform 0.3s ease;
        }
        
        .notification-toast.show {
            transform: translateX(0);
        }
        
        .notification-toast.success {
            border-left-color: var(--success);
        }
        
        .notification-toast.warning {
            border-left-color: var(--warning);
        }
        
        .notification-toast.danger {
            border-left-color: var(--danger);
        }
        
        .notification-toast.info {
            border-left-color: var(--info);
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .notification-title {
            font-weight: 600;
            font-size: 1rem;
        }
        
        .notification-close {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 1.2rem;
        }
        
        .notification-body {
            font-size: 0.9rem;
            color: #555;
        }
        
        .notification-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Menu mobile --- */
        .menu-toggle { display: none; background: none; border: none; font-size: 1.5rem; color: var(--dark); cursor: pointer; }
        
        @media (max-width: 768px) {
            .sidebar { position: fixed; height: 100%; z-index: 1000; }
            .menu-toggle { display: block; }
            .login-card { padding: 1.5rem; }
            .content-area { padding: 1rem; }
            .card { padding: 1rem; }
            .form-row { flex-direction: column; gap: 0.5rem; }
            .presence-controls-row { flex-direction: column; }
            .presence-controls .form-group { min-width: 100%; }
            .attendance-grid { grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); }
            .stats-grid { grid-template-columns: 1fr; }
            .incident-header { flex-direction: column; align-items: flex-start; }
            .tabs { flex-wrap: wrap; }
            .tab { flex: 1; text-align: center; min-width: 120px; }
            .period-selector { justify-content: center; }
            .period-btn { flex: 1; min-width: 120px; text-align: center; }
            .sub-tabs { flex-direction: column; }
            .sub-tab { border-radius: 8px; margin-bottom: 2px; }
            .sub-tab.active { border-bottom: 2px solid var(--primary); border-radius: 8px 8px 0 0; }
            .notification-toast {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }
    </style>

<!-- Notification System -->
<script src="firebase-notifications.js"></script>
<script src="notification-manager.js"></script>

<!-- Initialisation automatique -->
<script>
  // Initialiser apr√®s connexion
  if (window.currentParent) {
    setTimeout(() => {
      window.notificationManager.initialize();
    }, 3000);
  }
  
  // Tester les notifications (optionnel)
  window.testNotifications = function() {
    if (window.notificationManager) {
      window.notificationManager.test();
    }
    if (window.firebaseNotifications) {
      window.firebaseNotifications.testNotification();
    }
  };
</script>
</head>
<body>
    <!-- √âcran de connexion -->
    <div id="login-overlay" class="login-overlay">
        <div class="login-card">
            <h3>Espace Parent</h3>
            <p>Veuillez vous connecter pour continuer.</p>
            
            <!-- Formulaire de connexion -->
            <form id="login-form" style="margin-top: 1.5rem;">
                <div class="form-group">
                    <input type="text" id="login-matricule" class="form-control" placeholder="Matricule parent" required>
                </div>
                <div class="form-group">
                    <input type="password" id="login-password" class="form-control" placeholder="Mot de passe" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Connexion</button>
            </form>
            
            <p style="margin-top: 1rem;">
                <a href="#" id="show-activation-link">Activer mon compte</a>
            </p>
        </div>
        
        <!-- Formulaire d'activation de compte -->
        <div id="activation-card" class="login-card hidden">
            <h3>Activation du Compte Parent</h3>
            <p>Cr√©ez votre compte en associant le(s) matricule(s) de votre(vos) enfant(s)</p>
            
            <div class="activation-steps">
                <div class="step active" id="step-1">
                    <div class="step-number">1</div>
                    <div class="step-label">Informations</div>
                </div>
                <div class="step" id="step-2">
                    <div class="step-number">2</div>
                    <div class="step-label">V√©rification</div>
                </div>
                <div class="step" id="step-3">
                    <div class="step-number">3</div>
                    <div class="step-label">Compte cr√©√©</div>
                </div>
            </div>
            
            <!-- √âtape 1: Informations de base -->
            <div id="activation-step-1">
                <form id="activation-form-step1">
                    <div class="form-group">
                        <label>Votre nom complet</label>
                        <input type="text" id="parent-fullname" class="form-control" placeholder="Votre nom complet" required>
                    </div>
                    <div class="form-group">
                        <label>Votre email</label>
                        <input type="email" id="parent-email" class="form-control" placeholder="Votre adresse email" required>
                    </div>
                    <div class="form-group">
                        <label>Votre t√©l√©phone</label>
                        <input type="tel" id="parent-phone" class="form-control" placeholder="Votre num√©ro de t√©l√©phone" required>
                    </div>
                    <div class="form-group">
                        <label>Matricule de votre enfant</label>
                        <input type="text" id="child-matricule" class="form-control" placeholder="Matricule de l'√©l√®ve" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">V√©rifier le matricule</button>
                </form>
                
                <p style="margin-top: 1rem;">
                    <a href="#" id="show-login-link">Retour √† la connexion</a>
                </p>
            </div>
            
            <!-- √âtape 2: V√©rification et ajout d'enfants -->
            <div id="activation-step-2" class="hidden">
                <div class="alert alert-info">
                    <p><strong>V√©rification r√©ussie !</strong></p>
                    <p id="child-info">√âl√®ve trouv√©: <span id="child-name"></span> - <span id="child-class"></span></p>
                </div>
                
                <div id="children-list">
                    <h4>Enfants associ√©s √† votre compte</h4>
                    <div id="children-container">
                        <!-- Les enfants seront ajout√©s dynamiquement ici -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Ajouter un autre matricule (optionnel)</label>
                    <div class="form-row">
                        <input type="text" id="additional-matricule" class="form-control" placeholder="Matricule d'un autre enfant">
                        <button type="button" id="add-child-btn" class="btn btn-info">Ajouter</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Cr√©er votre mot de passe</label>
                    <input type="password" id="parent-password" class="form-control" placeholder="Votre mot de passe" required>
                </div>
                
                <div class="form-group">
                    <label>Confirmer le mot de passe</label>
                    <input type="password" id="parent-password-confirm" class="form-control" placeholder="Confirmer le mot de passe" required>
                </div>
                
                <button type="button" id="create-account-btn" class="btn btn-success" style="width: 100%;">Cr√©er mon compte</button>
                
                <p style="margin-top: 1rem;">
                    <a href="#" id="back-to-step1">Retour √† l'√©tape pr√©c√©dente</a>
                </p>
            </div>
            
            <!-- √âtape 3: Compte cr√©√© -->
            <div id="activation-step-3" class="hidden">
                <div class="alert alert-success">
                    <h4>Compte cr√©√© avec succ√®s !</h4>
                    <p>Votre compte parent a √©t√© cr√©√© avec les informations suivientes :</p>
                </div>
                
                <div style="text-align: left; margin: 1rem 0;">
                    <p><strong>Matricule parent:</strong> <span id="created-parent-matricule"></span></p>
                    <p><strong>Nom:</strong> <span id="created-parent-name"></span></p>
                    <p><strong>Email:</strong> <span id="created-parent-email"></span></p>
                    <p><strong>Enfants associ√©s:</strong> <span id="created-children-count"></span></p>
                </div>
                
                <p>Vous pouvez maintenant vous connecter avec votre matricule parent et votre mot de passe.</p>
                
                <button type="button" id="go-to-login-btn" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">Se connecter</button>
            </div>
        </div>
    </div>

    <!-- Contenu de l'application -->
    <div id="app-root" class="app-container hidden">
        <nav class="sidebar">
            <div style="padding: 1.5rem; text-align: center; border-bottom: 1px solid #eee;">
                <i class="fas fa-user-friends" style="font-size: 2rem; color: var(--primary);"></i>
                <h3 style="margin-top: 0.5rem;">Espace Parent</h3>
            </div>
            <ul class="nav-menu">
                <li><a href="#" class="active" data-page="dashboard"><i class="fas fa-tachometer-alt fa-fw"></i> Tableau de bord</a></li>
                <li><a href="#" data-page="grades"><i class="fas fa-chart-line fa-fw"></i> Cotes et Notes</a></li>
                <li><a href="#" data-page="presence-incidents"><i class="fas fa-clipboard-check fa-fw"></i> Pr√©sence & Incidents</a></li>

<li><a href="#" data-page="communiques"><i class="fas fa-newspaper fa-fw"></i> Communiqu√©s</a></li>
                <li><a href="#" data-page="payments"><i class="fas fa-money-bill-wave fa-fw"></i> Paiements</a></li>
                <li><a href="#" data-page="homework"><i class="fas fa-book-open fa-fw"></i> Devoirs</a></li>
                <li><a href="#" data-page="timetable"><i class="fas fa-clock fa-fw"></i> Temps Horaire</a></li>
                <li><a href="#" data-page="children"><i class="fas fa-child fa-fw"></i> Mes Enfants</a></li>
                <li><a href="#" data-page="profile"><i class="fas fa-user fa-fw"></i> Mon Profil</a></li>
                <li><a href="#" data-page="communication"><i class="fas fa-envelope fa-fw"></i> Messagerie</a></li>
                <li><a href="#" data-page="notifications"><i class="fas fa-bell fa-fw"></i> Notifications</a></li>
            </ul>
        </nav>
        <div class="main-content">
            <header class="app-header">
                <button class="menu-toggle" id="menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h2 id="page-title">Tableau de bord</h2>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div class="parent-profile">
                        <div id="parent-photo-container">
                            <!-- La photo sera ins√©r√©e ici dynamiquement -->
                        </div>
                        <span id="parent-name"></span>
                    </div>
                    <div style="position: relative;">
                        <button id="notification-bell" class="btn btn-info">
                            <i class="fas fa-bell"></i>
                            <span id="notification-count" class="hidden" style="position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 0.7rem; display: flex; align-items: center; justify-content: center;">0</span>
                        </button>
                    </div>
                    <button id="logout-btn" class="btn btn-danger">D√©connexion</button>
                </div>
            </header>
            <main class="content-area">
                <div id="global-alert" class="alert hidden"></div>

                <!-- Page: Tableau de bord -->
                <div id="dashboard-page" class="page active">
                    <div class="card">
                        <h3>Bienvenue dans votre espace parent</h3>
                        <p>Vous pouvez suivre la scolarit√© de vos enfants, g√©rer les paiements et communiquer avec l'√©tablissement.</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="child-selector"><strong>S√©lectionner un enfant pour voir ses informations :</strong></label>
                        <select id="child-selector" class="form-control"></select>
                    </div>
                    <div id="child-dashboard-content" class="hidden">
                        <div class="card">
                            <h3><i class="fas fa-chart-line"></i> Notes de l'Enfant</h3>
                            <div id="grades-container">
                                <div class="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>N¬∞</th>
                                                <th>Mati√®re</th>
                                                <th>Type d'√©valuation</th>
                                                <th>Points maximum</th>
                                                <th>Points obtenus</th>
                                                <th>Pourcentage</th>
                                                <th>Enseignant</th>
                                                <th>Date</th>
                                            </tr>
                                        </thead>
                                        <tbody id="child-grades-table-body">
                                            <!-- Les notes de l'enfant seront charg√©es ici -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <h3><i class="fas fa-calendar-check"></i> Derni√®res Pr√©sences</h3>
                            <div id="attendance-container"></div>
                        </div>
                        <div class="card">
                            <h3><i class="fas fa-book-open"></i> Devoirs R√©cents</h3>
                            <div id="homework-container"></div>
                        </div>
                    </div>
                </div>

<!-- Page: Communiqu√©s -->
<div id="communiques-page" class="page">
    <div class="card">
        <div class="form-row" style="justify-content: space-between; align-items: center;">
            <h3><i class="fas fa-newspaper"></i> Mes Communiqu√©s</h3>
            <button id="refresh-communiques-btn" class="btn btn-primary btn-sm">
                <i class="fas fa-sync-alt"></i> Actualiser
            </button>
        </div>
        
        <div class="form-group">
            <label for="communique-child-selector"><strong>Filtrer par enfant :</strong></label>
            <select id="communique-child-selector" class="form-control">
                <option value="all">Tous mes enfants</option>
                <!-- Les enfants seront charg√©s dynamiquement -->
            </select>
        </div>
        
        <div class="form-group">
            <label for="communique-type-filter"><strong>Filtrer par type de frais :</strong></label>
            <select id="communique-type-filter" class="form-control">
                <option value="all">Tous les frais</option>
                <option value="Frais scolaires">Frais scolaires</option>
                <option value="Frais de l'√©tat">Frais de l'√©tat</option>
                <option value="visite">Visite</option>
                <option value="achat pull">Achat pull</option>
                <option value="Frais d'inscription">Frais d'inscription</option>
                <option value="Autres">Autres</option>
            </select>
        </div>
        
        <div id="communiques-list-container">
            <!-- Liste des communiqu√©s personnalis√©s pour chaque enfant -->
        </div>
    </div>
</div>

                <!-- Page: Cotes et Notes (Regroupement) -->
                <div id="grades-page" class="page">
                    <div class="card">
                        <h3><i class="fas fa-chart-line"></i> Cotes et Notes des Enfants</h3>
                        <p>Consultez les notes et cotes publi√©es par les enseignants pour vos enfants.</p>
                    </div>
                    
                    <!-- Sous-onglets pour les diff√©rents niveaux -->
                    <div class="sub-tabs">
                        <div class="sub-tab active" data-sub-tab="secondary-grades">
                            <i class="fas fa-graduation-cap"></i> Notes Secondaire
                        </div>
                        <div class="sub-tab" data-sub-tab="primary-grades">
                            <i class="fas fa-chart-bar"></i> Cotes Primaire
                        </div>
                        <div class="sub-tab" data-sub-tab="kindergarten-grades">
                            <i class="fas fa-baby"></i> Cotes Maternelle
                        </div>
                    </div>
                    
                    <!-- Sous-onglet: Notes Secondaire -->
<div id="secondary-grades-tab" class="sub-tab-content active">
    <div class="card">
        <h4>Syst√®me de R√©ception des Cotes par P√©riode</h4>
        <p>Consultez les cotes publi√©es par les enseignants pour votre enfant, organis√©es par p√©riode scolaire.</p>
    </div>
    
    <div class="form-group">
        <label for="secondary-grades-child-selector"><strong>S√©lectionner un enfant du secondaire :</strong></label>
        <select id="secondary-grades-child-selector" class="form-control"></select>
    </div>
    
    <div id="secondary-grades-content" class="hidden">
        <!-- S√©lecteur de p√©riode -->
        <div class="period-selector" style="margin: 1.5rem 0;">
            <button class="period-btn active" data-period="P1">1√®re P√©riode</button>
            <button class="period-btn" data-period="P2">2√®me P√©riode</button>
            <button class="period-btn" data-period="EXAM_S1">Examen Semestre 1</button>
            <button class="period-btn" data-period="TOTAL_S1">Total Semestre 1</button>
            <button class="period-btn" data-period="P3">3√®me P√©riode</button>
            <button class="period-btn" data-period="P4">4√®me P√©riode</button>
            <button class="period-btn" data-period="EXAM_S2">Examen Semestre 2</button>
            <button class="period-btn" data-period="TOTAL_S2">Total Semestre 2</button>
            <button class="period-btn" data-period="TOTAL_GENERAL">Total G√©n√©ral</button>
        </div>
        
        <!-- Information sur la p√©riode -->
       <div id="period-info-card" class="card hidden" style="background: #e8f4fd; margin-bottom: 1.5rem;">
    <h4>P√©riode S√©lectionn√©e: <span id="selected-period-name"></span></h4>
    <p id="period-calculation-info"></p>
    <p id="period-auto-calc-info" class="hidden" style="color: #2e7d32; font-style: italic;">
        <i class="fas fa-calculator"></i> Calcul automatique activ√©
    </p>
</div>
        
        <div class="loading" id="secondary-grades-loading">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Chargement des cotes...</p>
        </div>
        
        <!-- Tableau de proclamation (similaire au titulaire) -->
        <div id="grades-table-container" class="hidden">
            <div class="card">
                <h4>Tableau des Cotes - <span id="child-name-header"></span></h4>
                <div class="download-options">
                    <button id="download-grades-excel-btn" class="btn btn-success btn-sm">
                        <i class="fas fa-file-excel"></i> Exporter Excel
                    </button>
                    <button id="download-grades-pdf-btn" class="btn btn-danger btn-sm">
                        <i class="fas fa-file-pdf"></i> Exporter PDF
                    </button>
                </div>
                <div id="grades-proclamation-table-container" class="table-container" style="margin-top: 1rem;"></div>
            </div>
        </div>
        
        <div id="no-grades-message" class="hidden">
            <div class="no-data">
                <i class="fas fa-chart-line"></i>
                <h3>Aucune cote disponible</h3>
                <p>Aucune cote n'a √©t√© publi√©e pour cet enfant pour la p√©riode s√©lectionn√©e.</p>
            </div>
        </div>
    </div>
</div>
                    
                    <!-- Sous-onglet: Cotes Primaire -->
                    <div id="primary-grades-tab" class="sub-tab-content">
                        <div class="form-group">
                            <label for="primary-grades-child-selector"><strong>S√©lectionner un enfant du primaire :</strong></label>
                            <select id="primary-grades-child-selector" class="form-control"></select>
                        </div>
                        
                        <div id="primary-grades-content" class="hidden">
                            <div class="period-selector">
                                <button class="period-btn active" data-period="1√®re p√©riode">1√®re P√©riode</button>
                                <button class="period-btn" data-period="2√®me p√©riode">2√®me P√©riode</button>
                                <button class="period-btn" data-period="3√®me p√©riode">3√®me P√©riode</button>
                                <button class="period-btn" data-period="4√®me p√©riode">4√®me P√©riode</button>
                                <button class="period-btn" data-period="5√®me p√©riode">5√®me P√©riode</button>
                            </div>
                            
                            <div class="loading" id="primary-grades-loading">
                                <i class="fas fa-spinner"></i>
                                <p>Chargement des cotes...</p>
                            </div>
                            
                            <div id="primary-grades-container">
                                <div class="table-container">
                                    <table class="primary-grades-table">
                                        <thead>
                                            <tr>
                                                <th>N¬∞</th>
                                                <th>Nom du cours</th>
                                                <th>Cote Maximum (CM)</th>
                                                <th>Cote Obtenue (CO)</th>
                                                <th>Date de r√©ception</th>
                                                <th>Nom de l'enseignant</th>
                                            </tr>
                                        </thead>
                                        <tbody id="primary-grades-table-body">
                                            <!-- Les cotes du primaire seront charg√©es ici -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div id="primary-grades-summary" class="card hidden" style="margin-top: 1.5rem;">
                                <h4>R√©sum√© des Cotes</h4>
                                <div id="primary-grades-stats">
                                    <!-- Les statistiques des cotes seront affich√©es ici -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sous-onglet: Cotes Maternelle -->
                    <div id="kindergarten-grades-tab" class="sub-tab-content">
                        <div class="form-group">
                            <label for="kindergarten-grades-child-selector"><strong>S√©lectionner un enfant de la maternelle :</strong></label>
                            <select id="kindergarten-grades-child-selector" class="form-control"></select>
                        </div>
                        
                        <div id="kindergarten-grades-content" class="hidden">
                            <div class="loading" id="kindergarten-grades-loading">
                                <i class="fas fa-spinner"></i>
                                <p>Chargement des cotes...</p>
                            </div>
                            
                            <div id="kindergarten-grades-container">
                                <div class="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>N¬∞</th>
                                                <th>Comp√©tence</th>
                                                <th>Niveau</th>
                                                <th>Appr√©ciation</th>
                                                <th>Date d'√©valuation</th>
                                                <th>Enseignant</th>
                                            </tr>
                                        </thead>
                                        <tbody id="kindergarten-grades-table-body">
                                            <!-- Les cotes maternelles seront charg√©es ici -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page: Pr√©sence & Incidents -->
                <div id="presence-incidents-page" class="page">
                    <div class="card">
                        <h3><i class="fas fa-clipboard-check"></i> Suivi des Pr√©sences et Incidents</h3>
                        <p>Consultez les pr√©sences publi√©es et les incidents signal√©s pour vos enfants.</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="presence-child-selector"><strong>S√©lectionner un enfant :</strong></label>
                        <select id="presence-child-selector" class="form-control"></select>
                    </div>
                    
                    <div id="presence-incidents-content" class="hidden">
                        <!-- Section Pr√©sences -->
                        <div class="card presence-section">
                            <h3><i class="fas fa-calendar-alt"></i> Pr√©sences Mensuelles</h3>
                            
                            <div class="presence-controls">
                                <div class="presence-controls-row">
                                    <div class="form-group">
                                        <label>Mois</label>
                                        <select id="presence-month" class="form-control">
                                            <option value="0">Janvier</option>
                                            <option value="1">F√©vrier</option>
                                            <option value="2">Mars</option>
                                            <option value="3">Avril</option>
                                            <option value="4">Mai</option>
                                            <option value="5">Juin</option>
                                            <option value="6">Juillet</option>
                                            <option value="7">Ao√ªt</option>
                                            <option value="8">Septembre</option>
                                            <option value="9">Octobre</option>
                                            <option value="10">Novembre</option>
                                            <option value="11">D√©cembre</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Ann√©e</label>
                                        <select id="presence-year" class="form-control">
                                            <!-- Les ann√©es seront charg√©es dynamiquement -->
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>&nbsp;</label>
                                        <button id="load-presence-btn" class="btn btn-primary" style="width: 100%;">
                                            <i class="fas fa-sync-alt"></i> Charger les pr√©sences
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="presence-stats">
                                <!-- Les statistiques seront affich√©es ici -->
                            </div>
                            
                            <div id="monthly-presence-container">
                                <div class="no-data">
                                    <i class="fas fa-calendar"></i>
                                    <p>S√©lectionnez un mois et une ann√©e pour voir les pr√©sences de votre enfant.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Section Incidents -->
                        <div class="card presence-section">
                            <h3><i class="fas fa-exclamation-triangle"></i> Incidents Signal√©s</h3>
                            <div id="incidents-list-container">
                                <div class="loading">
                                    <i class="fas fa-spinner"></i>
                                    <p>Chargement des incidents...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page: Paiements -->
                <div id="payments-page" class="page">
                    <h2>Gestion des Paiements</h2>
                    <div class="form-group">
                        <label for="payment-child-selector"><strong>S√©lectionner un enfant :</strong></label>
                        <select id="payment-child-selector" class="form-control"></select>
                    </div>
                    <div id="payment-content" class="hidden">
                        <div class="card">
                            <h3>Statut des Paiements</h3>
                            <div id="payment-status-container"></div>
                        </div>
                        <div class="card">
                            <h3>Paiement en ligne</h3>
                            <form id="online-payment-form">
                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <label>Matricule de l'√©l√®ve</label>
                                        <input type="text" id="payment-student-id" class="form-control" readonly>
                                    </div>
                                    <div class="form-group" style="flex: 2;">
                                        <label>Nom complet de l'√©l√®ve</label>
                                        <input type="text" id="payment-student-name" class="form-control" readonly>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <label>Classe</label>
                                        <input type="text" id="payment-student-class" class="form-control" readonly>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label>Mois de paiement</label>
                                        <select id="payment-month" class="form-control" required>
                                            <option value="janvier">Janvier</option>
                                            <option value="f√©vrier">F√©vrier</option>
                                            <option value="mars">Mars</option>
                                            <option value="avril">Avril</option>
                                            <option value="mai">Mai</option>
                                            <option value="juin">Juin</option>
                                            <option value="juillet">Juillet</option>
                                            <option value="ao√ªt">Ao√ªt</option>
                                            <option value="septembre">Septembre</option>
                                            <option value="octobre">Octobre</option>
                                            <option value="novembre">Novembre</option>
                                            <option value="d√©cembre">D√©cembre</option>
                                        </select>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label>Montant (FCFA)</label>
                                        <input type="number" id="payment-amount" class="form-control" placeholder="30000" required>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">Valider le paiement</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Page: Devoirs (Regroupement) -->
                <div id="homework-page" class="page">
                    <div class="card">
                        <h3>Devoirs des Enfants</h3>
                        <p>Consultez les devoirs assign√©s √† vos enfants selon leur niveau scolaire.</p>
                    </div>
                    
                    <!-- Sous-onglets pour les diff√©rents niveaux -->
                    <div class="sub-tabs">
                        <div class="sub-tab active" data-sub-tab="secondary-homework">
                            <i class="fas fa-graduation-cap"></i> Devoirs Secondaire
                        </div>
                        <div class="sub-tab" data-sub-tab="primary-homework">
                            <i class="fas fa-book"></i> Devoirs Primaire
                        </div>
                        <div class="sub-tab" data-sub-tab="kindergarten-homework">
                            <i class="fas fa-baby"></i> Devoirs Maternelle
                        </div>
                    </div>
                    
                    <!-- Sous-onglet: Devoirs Secondaire -->
                    <div id="secondary-homework-tab" class="sub-tab-content active">
                        <div class="form-group">
                            <label for="secondary-homework-child-selector"><strong>S√©lectionner un enfant du secondaire :</strong></label>
                            <select id="secondary-homework-child-selector" class="form-control"></select>
                        </div>
                        
                        <div id="secondary-homework-content" class="hidden">
                            <div class="tabs">
                                <div class="tab active" data-tab="pending">Devoirs en cours</div>
                                <div class="tab" data-tab="submitted">Devoirs rendus</div>
                            </div>
                            
                            <div id="pending-tab" class="tab-content active">
                                <div class="loading" id="pending-homework-loading">
                                    <i class="fas fa-spinner"></i>
                                    <p>Chargement des devoirs en cours...</p>
                                </div>
                                <div id="pending-homework-container">
                                    <!-- Les devoirs en cours seront charg√©s dynamiquement ici -->
                                </div>
                            </div>
                            
                            <div id="submitted-tab" class="tab-content">
                                <div class="loading" id="submitted-homework-loading">
                                    <i class="fas fa-spinner"></i>
                                    <p>Chargement des devoirs rendus...</p>
                                </div>
                                <div id="submitted-homework-container">
                                    <!-- Les devoirs rendus seront charg√©s dynamiquement ici -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sous-onglet: Devoirs Primaire -->
                    <div id="primary-homework-tab" class="sub-tab-content">
                        <div class="form-group">
                            <label for="primary-homework-child-selector"><strong>S√©lectionner un enfant du primaire :</strong></label>
                            <select id="primary-homework-child-selector" class="form-control"></select>
                        </div>
                        
                        <div id="primary-homework-content" class="hidden">
                            <div class="loading" id="primary-homework-loading">
                                <i class="fas fa-spinner"></i>
                                <p>Chargement des devoirs...</p>
                            </div>
                            <div id="primary-homework-container">
                                <!-- Les devoirs du primaire seront charg√©s dynamiquement ici -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sous-onglet: Devoirs Maternelle -->
                    <div id="kindergarten-homework-tab" class="sub-tab-content">
                        <div class="form-group">
                            <label for="kindergarten-homework-child-selector"><strong>S√©lectionner un enfant de la maternelle :</strong></label>
                            <select id="kindergarten-homework-child-selector" class="form-control"></select>
                        </div>
                        
                        <div id="kindergarten-homework-content" class="hidden">
                            <div class="loading" id="kindergarten-homework-loading">
                                <i class="fas fa-spinner"></i>
                                <p>Chargement des devoirs...</p>
                            </div>
                            <div id="kindergarten-homework-container">
                                <!-- Les devoirs de la maternelle seront charg√©s dynamiquement ici -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Page: Temps Horaire -->
                <div id="timetable-page" class="page">
                    <div class="card">
                        <h3>Temps Horaire des Enfants</h3>
                        <p>Consultez les horaires de classe de vos enfants.</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="timetable-child-selector"><strong>S√©lectionner un enfant :</strong></label>
                        <select id="timetable-child-selector" class="form-control"></select>
                    </div>
                    
                    <div id="timetable-content" class="hidden">
                        <div class="schedule-controls">
                            <div class="form-group" style="flex: 1;">
                                <label>S√©lectionner le mois</label>
                                <input type="month" id="timetable-month" class="form-control">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>S√©lectionner la semaine</label>
                                <select id="timetable-week" class="form-control">
                                    <option value="">-- Toutes les semaines --</option>
                                    <option value="1">Semaine 1</option>
                                    <option value="2">Semaine 2</option>
                                    <option value="3">Semaine 3</option>
                                    <option value="4">Semaine 4</option>
                                    <option value="5">Semaine 5</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 1; display: flex; align-items: flex-end;">
                                <button id="load-timetable-btn" class="btn btn-primary">
                                    <i class="fas fa-search"></i> Rechercher
                                </button>
                            </div>
                        </div>
                        
                        <div id="timetable-container">
                            <div class="loading" id="timetable-loading">
                                <i class="fas fa-spinner"></i>
                                <p>Chargement de l'horaire...</p>
                            </div>
                            <div id="timetable-display">
                                <!-- Le contenu de l'horaire sera charg√© dynamiquement ici -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Page: Mes Enfants -->
                <div id="children-page" class="page">
                    <div class="card">
                        <div class="form-row" style="justify-content: space-between; align-items: center;">
                            <h3>Mes Enfants</h3>
                            <button id="add-child-account-btn" class="btn btn-primary">Ajouter un enfant</button>
                        </div>
                        
                        <div id="children-list-container">
                            <!-- Liste des enfants associ√©s au compte -->
                        </div>
                    </div>
                </div>
                
                <!-- Page: Mon Profil -->
                <div id="profile-page" class="page">
                    <div class="card">
                        <h3>Mon Profil</h3>
                        
                        <!-- Photo de profil -->
                        <div class="photo-upload">
                            <div id="profile-photo-preview" class="photo-placeholder">
                                <i class="fas fa-user"></i>
                            </div>
                            <input type="file" id="profile-photo" class="file-input" accept="image/*">
                            <button type="button" class="upload-btn" onclick="document.getElementById('profile-photo').click()">
                                <i class="fas fa-upload"></i> Changer la photo
                            </button>
                        </div>
                        
                        <form id="profile-form">
                            <div class="form-group">
                                <label>Matricule Parent</label>
                                <input type="text" id="profile-matricule" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label>Nom Complet</label>
                                <input type="text" id="profile-fullname" class="form-control" required>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" id="profile-email" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label>T√©l√©phone</label>
                                    <input type="tel" id="profile-phone" class="form-control" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Nouveau mot de passe (laisser vide pour ne pas changer)</label>
                                <input type="password" id="profile-new-password" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Confirmer le nouveau mot de passe</label>
                                <input type="password" id="profile-confirm-password" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Notifications Push</label>
                                <div style="margin-top: 10px;">
                                    <button type="button" id="enable-notifications-btn" class="btn btn-info btn-sm">
                                        <i class="fas fa-bell"></i> Activer les notifications
                                    </button>
                                    <button type="button" id="test-notification-btn" class="btn btn-warning btn-sm">
                                        <i class="fas fa-paper-plane"></i> Tester une notification
                                    </button>
                                </div>
                                <div id="notification-status" style="margin-top: 10px; font-size: 0.9rem;"></div>
                            </div>
                            <button type="submit" class="btn btn-primary">Mettre √† jour le profil</button>
                        </form>
                    </div>
                </div>
                
                <!-- Page: Messagerie -->
                <div id="communication-page" class="page">
                    <div class="card">
                        <h3>Messagerie</h3>
                        <p>Module de messagerie en d√©veloppement.</p>
                    </div>
                </div>
                
                <!-- Page: Notifications -->
                <div id="notifications-page" class="page">
                    <div class="card">
                        <div class="form-row" style="justify-content: space-between; align-items: center;">
                            <h3>Mes Notifications</h3>
                            <button id="clear-all-notifications-btn" class="btn btn-danger btn-sm">Tout effacer</button>
                        </div>
                        
                        <div class="form-group">
                            <label>Filtrer par type</label>
                            <select id="notification-filter" class="form-control">
                                <option value="all">Toutes les notifications</option>
                                <option value="grades">Nouvelles notes</option>
                                <option value="homework">Devoirs</option>
                                <option value="incidents">Incidents</option>
                                <option value="payments">Paiements</option>
                                <option value="messages">Messages</option>
                                <option value="announcements">Annonces</option>
                            </select>
                        </div>
                        
                        <div id="notifications-list-container">
                            <!-- Liste des notifications -->
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modale pour le code de paiement -->
    <div id="payment-code-modal" class="modal hidden">
        <div class="modal-content" style="text-align: center; max-width: 450px;">
            <div class="modal-header">
                <h3>Code de Paiement G√©n√©r√©</h3>
                <button class="close-modal">&times;</button>
            </div>
            <p>Pr√©sentez ce code au secr√©tariat pour finaliser le paiement.</p>
            <div id="generated-code" style="font-size: 1.5rem; font-weight: bold; color: var(--primary); background: #f0f0f0; padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 2px dashed var(--primary);"></div>
            
            <div id="receipt-preview" style="text-align: left; margin: 1rem 0;">
                <!-- Pr√©visualisation du re√ßu -->
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button class="btn btn-primary" onclick="closeModal('payment-code-modal')">Fermer</button>
                <button id="download-receipt-btn" class="btn btn-success">T√©l√©charger le re√ßu</button>
            </div>
        </div>
    </div>

    <!-- Modale pour ajouter un enfant -->
    <div id="add-child-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Ajouter un enfant</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="add-child-form">
                <div class="form-group">
                    <label>Matricule de l'enfant</label>
                    <input type="text" id="new-child-matricule" class="form-control" placeholder="Matricule de l'√©l√®ve" required>
                </div>
                <div class="alert alert-info hidden" id="child-verification-result">
                    <!-- R√©sultat de la v√©rification -->
                </div>
                <div class="form-group">
                    <label>Relation avec l'enfant</label>
                    <select id="child-relation" class="form-control" required>
                        <option value="parent">Parent</option>
                        <option value="tuteur">Tuteur</option>
                        <option value="autre">Autre</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Ajouter l'enfant</button>
            </form>
        </div>
    </div>

<!-- Modal pour l'affichage complet du communiqu√© -->
<div id="communique-full-modal" class="modal hidden communique-full-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Communiqu√© de Paiement</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div id="communique-full-content" class="communique-full-content">
          html
<!-- Modifiez le bouton d'impression dans le modal -->
<div style="text-align: center; margin-top: 1.5rem;">
    <button id="print-communique-btn" class="btn btn-primary">
        <i class="fas fa-print"></i> Imprimer
    </button>
    <button class="btn btn-secondary" onclick="closeModal('communique-full-modal')">
        Fermer
    </button>
</div>

    </div>
</div>

    
    <script type="module">
// 1. INITIALISATION DE FIREBASE
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
import { getFirestore, collection, getDocs, query, where, addDoc, serverTimestamp, doc, updateDoc, orderBy, getDoc, setDoc, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
import { getMessaging, getToken, onMessage, isSupported } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-messaging.js";

const firebaseConfig = {
  apiKey: "AIzaSyBn7VIddclO7KtrXb5sibCr9SjVLjOy-qI",
  authDomain: "theo1d.firebaseapp.com",
  projectId: "theo1d",
  storageBucket: "theo1d.firebasestorage.app",
  messagingSenderId: "269629842962",
  appId: "1:269629842962:web:a80a12b04448fe1e595acb",
  measurementId: "G-TNSG1XFMDZ"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
let messaging = null;

// Remplacer la ligne 1480 environ dans votre code
const vapidKey = "BM8H6cADaP6tiA4t9Oc9D36jk1UmYoUBV3cATlJ5mvZ_-eQ5xd6HgX5twxWvZ2U2Y98HBkJ8bTph7epPJJYqBpc";

async function initializeFirebaseMessaging() {
  try {
    // Initialiser Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const messaging = firebase.messaging();
    
    // V√©rifier la permission
    const permission = await Notification.requestPermission();
    if (permission !== 'granted') {
      console.warn('‚ö†Ô∏è Permission refus√©e');
      return null;
    }
    
    // Obtenir le token FCM avec VAPID Key
    const token = await messaging.getToken({
      vapidKey: vapidKey,
      serviceWorkerRegistration: await navigator.serviceWorker.register('/firebase-messaging-sw.js')
    });
    
    console.log('‚úÖ Token FCM obtenu:', token);
    
    // ENVOYER CE TOKEN √Ä VOTRE BACKEND
    await saveFCMTokenToBackend(token);
    
    return messaging;
    
  } catch (error) {
    console.error('‚ùå Erreur Firebase Messaging:', error);
    return null;
  }
}

// Lancer au chargement
document.addEventListener('DOMContentLoaded', async () => {
  if ('serviceWorker' in navigator && 'PushManager' in window) {
    const messaging = await initializeFirebaseMessaging();
    
    if (messaging) {
      // √âcouter les messages en background
      messaging.onBackgroundMessage((payload) => {
        console.log('üì± Notification en background:', payload);
        
        // Afficher la notification syst√®me
        if (payload.notification) {
          const { title, body } = payload.notification;
          
          // Notification NATIVE du syst√®me
          if ('Notification' in window && Notification.permission === 'granted') {
            const notification = new Notification(title, {
              body: body,
              icon: '/icon-192x192.png',
              badge: '/icon-72x72.png',
              tag: 'fcm-notification',
              requireInteraction: true,
              silent: false,
              data: payload.data
            });
            
            // G√©rer le clic
            notification.onclick = () => {
              window.focus();
              notification.close();
              // Naviguer vers l'app
              if (payload.data?.url) {
                window.location.href = payload.data.url;
              }
            };
          }
        }
      });
    }
  }
});


// V√©rifier si Firebase Messaging est support√©
(async () => {
    const isMessagingSupported = await isSupported();
    if (isMessagingSupported) {
        messaging = getMessaging(app);
        console.log("‚úÖ Firebase Messaging initialis√©");
    } else {
        console.log("‚ùå Firebase Messaging n'est pas support√©");
    }
})();

// 2. CONFIGURATION CLOUDINARY
const CLOUDINARY_CONFIG = {
    cloudName: 'diwn8sxtn',
    uploadPreset: 'cs_lacolombe'
};

// 3. FONCTION UPLOAD CLOUDINARY
async function uploadToCloudinary(file, folder = 'cs-lacolombe') {
    if (!file) return null;
    
    try {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_CONFIG.uploadPreset);
        formData.append('folder', folder);
        formData.append('tags', 'school_management');
        
        const response = await fetch(
            `https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.cloudName}/image/upload`,
            { 
                method: 'POST', 
                body: formData 
            }
        );
        
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        
        const data = await response.json();
        return data.secure_url;
        
    } catch (error) {
        console.error("‚ùå Erreur upload Cloudinary:", error);
        throw new Error(`√âchec de l'upload Cloudinary: ${error.message}`);
    }
}

let currentParent = null;
let childrenList = [];
let parentPhotoFile = null;
let currentPrimaryPeriod = '1√®re p√©riode';

// Stocker les compteurs de notifications
let notificationCounts = {
    dashboard: 0,
    grades: 0,
    'presence-incidents': 0,
    payments: 0,
    homework: 0,
    timetable: 0,
    children: 0,
    profile: 0,
    communication: 0,
    notifications: 0
};

// Stocker les notifications en m√©moire
let notifications = [];

// --- GESTION DES NOTIFICATIONS PUSH ---
async function requestNotificationPermission() {
    try {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
            console.log('‚úÖ Permission de notification accord√©e');
            showToast('Notifications activ√©es avec succ√®s', 'success');
            await setupFirebaseMessaging();
            return true;
        } else {
            console.log('‚ùå Permission de notification refus√©e');
            showToast('Les notifications ont √©t√© refus√©es. Vous pouvez les activer dans les param√®tres de votre navigateur.', 'warning');
            return false;
        }
    } catch (error) {
        console.error('Erreur demande permission notifications:', error);
        showToast('Erreur lors de l\'activation des notifications', 'error');
        return false;
    }
}

async function setupFirebaseMessaging() {
  if (!('Notification' in window)) {
    console.log('‚ùå Ce navigateur ne supporte pas les notifications');
    return null;
  }

  // Demander la permission IMM√âDIATEMENT
  const permission = await Notification.requestPermission();
  if (permission !== 'granted') {
    console.log('‚ùå Permission refus√©e');
    return null;
  }

  try {
    // 1. Enregistrer le Service Worker UNIFI√â
    const registration = await navigator.serviceWorker.register('sw.js', {
      scope: './',
      updateViaCache: 'none'
    });
    
    console.log('‚úÖ Service Worker enregistr√©:', registration.scope);
    
    // Attendre l'activation
    if (registration.installing) {
      await new Promise(resolve => {
        registration.installing.addEventListener('statechange', () => {
          if (registration.active) resolve();
        });
      });
    }

    // 2. Initialiser Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBn7VIddclO7KtrXb5sibCr9SjVLjOy-qI",
      authDomain: "theo1d.firebaseapp.com",
      projectId: "theo1d",
      storageBucket: "theo1d.firebasestorage.app",
      messagingSenderId: "269629842962",
      appId: "1:269629842962:web:a80a12b04448fe1e595acb",
      measurementId: "G-TNSG1XFMDZ"
    };
    
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    
    const messaging = firebase.messaging();
    
    // 3. Obtenir le token FCM AVEC la VAPID Key correcte
    const token = await messaging.getToken({
      vapidKey: "BM8H6cADaP6tiA4t9Oc9D36jk1UmYoUBV3cATlJ5mvZ_-eQ5xd6HgX5twxWvZ2U2Y98HBkJ8bTph7epPJJYqBpc",
      serviceWorkerRegistration: await navigator.serviceWorker.ready
    });
    
    if (token) {
      console.log('‚úÖ Token FCM obtenu:', token.substring(0, 30) + '...');
      
      // Sauvegarder le token dans Firestore
      if (currentParent) {
        await updateDoc(doc(db, 'parents', currentParent.matricule), {
          fcmToken: token,
          notificationEnabled: true,
          lastTokenUpdate: serverTimestamp()
        });
        
        console.log('‚úÖ Token sauvegard√© pour le parent:', currentParent.matricule);
      }
      
      // Tester imm√©diatement
      setTimeout(() => sendTestNotification(token), 2000);
    }
    
    // 4. √âcouter les messages en temps r√©el
    messaging.onMessage((payload) => {
      console.log('üì® Message re√ßu (premier plan):', payload);
      handleIncomingNotification(payload);
      
      // Afficher une notification toast
      showLocalNotification(
        payload.notification?.title || 'Notification',
        payload.notification?.body || 'Nouveau message',
        payload.data || {}
      );
    });
    
    return messaging;
    
  } catch (error) {
    console.error('‚ùå Erreur Firebase Messaging:', error);
    return null;
  }
}

async function testCompleteNotificationSystem() {
  console.log('üß™ Test complet du syst√®me de notifications');
  
  // 1. V√©rifier Service Worker
  const registration = await navigator.serviceWorker.getRegistration();
  console.log('Service Worker:', registration ? '‚úÖ PR√âSENT' : '‚ùå ABSENT');
  
  // 2. V√©rifier permission
  const permission = await Notification.permission;
  console.log('Permission:', permission);
  
  // 3. Obtenir le token
  const messaging = await setupFirebaseMessaging();
  if (messaging) {
    const token = await messaging.getToken();
    console.log('Token FCM:', token ? '‚úÖ PR√âSENT' : '‚ùå ABSENT');
    
    // 4. Tester une notification locale
    if (Notification.permission === 'granted') {
      new Notification('‚úÖ Test r√©ussi!', {
        body: 'Le syst√®me de notifications est configur√© correctement',
        icon: 'icon-192x192.png',
        tag: 'test-success'
      });
    }
    
    return true;
  }
  
  return false;
}

// Appeler au chargement de la page
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => {
    if (window.currentParent) {
      testCompleteNotificationSystem();
    }
  }, 3000);
});

// === GESTION DES COMMUNIQU√âS ===

// Dans parent.html, modifiez loadCommuniques pour filtrer les communiqu√©s expir√©s
async function loadCommuniques() {
    const container = document.getElementById('communiques-list-container');
    container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i><p>Chargement des communiqu√©s...</p></div>';


    
    if (!currentParent || childrenList.length === 0) {
        container.innerHTML = '<div class="no-data"><i class="fas fa-newspaper"></i><p>Aucun enfant associ√© √† votre compte.</p></div>';
        return;
    }
    
    try {
        // 1. R√©cup√©rer les relations pour ce parent
        const parentCommuniquesQuery = query(
            collection(db, 'parent_communique_relations'),
            where('parentId', '==', currentParent.matricule),
            orderBy('createdAt', 'desc')
        );
        
        const parentCommuniquesSnap = await getDocs(parentCommuniquesQuery);
        
        console.log(`üìÑ ${parentCommuniquesSnap.size} relation(s) trouv√©e(s) pour le parent ${currentParent.matricule}`);
        
        if (parentCommuniquesSnap.empty) {
            container.innerHTML = '<div class="no-data"><i class="fas fa-newspaper"></i><p>Aucun communiqu√© re√ßu pour le moment.</p></div>';
            return;
        }
        
        // 2. R√©cup√©rer les d√©tails de chaque communiqu√© non expir√©
        let allCommuniques = [];
        
        for (const relationDoc of parentCommuniquesSnap.docs) {
            const relationData = relationDoc.data();
            const communiqueId = relationData.communiqueId;
            
            // V√©rifier si le communiqu√© est expir√©
            if (relationData.expirationDate) {
                const expirationDate = new Date(relationData.expirationDate);
                const now = new Date();
                
                if (expirationDate <= now) {
                    console.log(`‚ö†Ô∏è Communiqu√© ${communiqueId} expir√© le ${expirationDate.toLocaleDateString('fr-FR')}`);
                    continue; // Passer au suivant
                }
            }


            
            // R√©cup√©rer le communiqu√© principal
            const communiqueDoc = await getDoc(doc(db, 'parent_communiques', communiqueId));
            
            if (communiqueDoc.exists()) {
                const communiqueData = communiqueDoc.data();
                
                // V√©rifier aussi l'expiration dans le communiqu√© principal
                if (communiqueData.expirationDate) {
                    const expirationDate = new Date(communiqueData.expirationDate);
                    const now = new Date();
                    
                    if (expirationDate <= now) {
                        console.log(`‚ö†Ô∏è Communiqu√© principal ${communiqueId} expir√©`);
                        continue;
                    }
                }
                
                allCommuniques.push({
                    id: communiqueId,
                    ...communiqueData,
                    relationId: relationDoc.id,
                    parentRelation: relationData,
                    affectedChildren: relationData.studentIds.map((studentId, index) => ({
                        matricule: studentId,
                        name: relationData.studentNames[index] || 'Nom inconnu',
                        class: relationData.studentClasses[index] || 'Classe inconnue'
                    }))
                });
            } else {
                console.warn(`‚ö†Ô∏è Communiqu√© ${communiqueId} non trouv√© pour la relation ${relationDoc.id}`);
            }
        }
        
        if (allCommuniques.length === 0) {
            container.innerHTML = '<div class="no-data"><i class="fas fa-newspaper"></i><p>Aucun communiqu√© disponible pour le moment.</p></div>';
            return;
        }
        
        // 3. Trier par date (plus r√©cent d'abord)
        allCommuniques.sort((a, b) => {
            const dateA = a.publishedAt?.toDate() || new Date(0);
            const dateB = b.publishedAt?.toDate() || new Date(0);
            return dateB - dateA;
        });
        
        // 4. Appliquer les filtres
        const selectedChild = document.getElementById('communique-child-selector').value;
        const selectedType = document.getElementById('communique-type-filter').value;
        
        let filteredCommuniques = allCommuniques;
        
        if (selectedChild !== 'all') {
            filteredCommuniques = filteredCommuniques.filter(communique => 
                communique.parentRelation.studentIds.includes(selectedChild)
            );
        }
        
        if (selectedType !== 'all') {
            filteredCommuniques = filteredCommuniques.filter(communique => 
                communique.feeType === selectedType
            );
        }
        
        // 5. Afficher les communiqu√©s


        if (filteredCommuniques.length === 0) {
            container.innerHTML = '<div class="no-data"><i class="fas fa-filter"></i><p>Aucun communiqu√© correspondant aux filtres s√©lectionn√©s.</p></div>';
            return;
        }
        
        let html = '';
        
        filteredCommuniques.forEach((communique, index) => {
            const publishedDate = communique.publishedAt ? 
                new Date(communique.publishedAt.toDate()).toLocaleDateString('fr-FR', {
                    day: '2-digit',
                    month: 'long',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : 'Date inconnue';
            
            // V√©rifier si c'est urgent
            const deadlineDate = new Date(communique.deadline);
            const now = new Date();
            const daysDiff = Math.ceil((deadlineDate - now) / (1000 * 60 * 60 * 24));
            const isUrgent = daysDiff <= 3 && daysDiff >= 0;
            const isOverdue = daysDiff < 0;
            const isPaid = communique.parentRelation.status === 'paid';
            
            // Calculer les jours avant expiration
            const expirationDate = communique.expirationDate ? new Date(communique.expirationDate) : null;
            const daysUntilExpiration = expirationDate ? Math.ceil((expirationDate - now) / (1000 * 60 * 60 * 24)) : null;
            
            // Classes CSS
            let cardClass = 'communique-card';
            if (isOverdue) cardClass += ' urgent';
            else if (isUrgent) cardClass += ' urgent';
            if (isPaid) cardClass += ' paid';
            if (daysUntilExpiration !== null && daysUntilExpiration <= 2) {
                cardClass += ' expiring-soon';
            }
            
            // Badges
            let statusBadge = '';
            if (isOverdue) {
                statusBadge = '<span class="badge badge-danger">En retard</span>';
            } else if (isUrgent) {
                statusBadge = '<span class="badge badge-warning">Urgent</span>';
            } else if (isPaid) {
                statusBadge = '<span class="badge badge-success">Pay√©</span>';
            } else {
                statusBadge = '<span class="badge badge-info">En attente</span>';
            }
            
            // Jours restants
            let daysText = '';
            if (isOverdue) {
                daysText = `<span style="color: var(--danger);"><i class="fas fa-exclamation-circle"></i> Retard de ${Math.abs(daysDiff)} jour(s)</span>`;
            } else {
                daysText = `<span style="color: ${isUrgent ? 'var(--warning)' : 'var(--success)'};">‚è±Ô∏è ${daysDiff} jour(s) restant(s)</span>`;
            }
            
            // Info expiration
            let expirationText = '';
            if (expirationDate && daysUntilExpiration !== null) {
                if (daysUntilExpiration <= 0) {
                    expirationText = '<span style="color: var(--danger);"><i class="fas fa-hourglass-end"></i> Expir√©</span>';
                } else if (daysUntilExpiration <= 2) {
                    expirationText = `<span style="color: var(--warning);"><i class="fas fa-hourglass-half"></i> Expire dans ${daysUntilExpiration} jour(s)</span>`;
                } else {
                    expirationText = `<span style="color: var(--info);"><i class="fas fa-hourglass-start"></i> Expire le ${expirationDate.toLocaleDateString('fr-FR')}</span>`;
                }
            }
            
            // Enfants concern√©s
            const childrenListHTML = communique.affectedChildren.map(child => 
                `<span class="badge badge-secondary">${child.name} (${child.matricule})</span>`
            ).join(' ');
            
            html += `
                <div class="${cardClass}" data-communique-id="${communique.id}" data-expiration="${expirationDate ? expirationDate.toISOString() : ''}">
                    <div class="communique-header">
                        <div style="flex: 1;">
                            <div class="communique-title">
                                ${communique.feeType} - ${communique.month} ${communique.schoolYear}
                            </div>
                            <div class="communique-meta">
                                <span><i class="far fa-calendar"></i> Publi√© le: ${publishedDate}</span>
                                <span><i class="far fa-clock"></i> Date limite: ${deadlineDate.toLocaleDateString('fr-FR')}</span>
                                <span>${statusBadge}</span>
                                <span>${daysText}</span>
                                ${expirationText ? `<span>${expirationText}</span>` : ''}
                            </div>
                        </div>
                        <div>
                            <span class="badge badge-primary">
                                <i class="fas fa-money-bill-wave"></i> ${parseFloat(communique.amount).toFixed(2)} $
                            </span>
                        </div>
                    </div>
                    
                    <div class="communique-content">
                        <p><strong>Objet :</strong> Rappel concernant le paiement des frais de <strong>${communique.feeType}</strong></p>
                        <p><strong>Enfants concern√©s :</strong> ${childrenListHTML}</p>
                        ${communique.message ? `<p><strong>Message :</strong> ${communique.message}</p>` : ''}
                    </div>
                    
                    <div class="communique-footer">
                        <div>
                            <strong>Classes concern√©es :</strong> ${communique.classes.join(', ')}
                        </div>
                        <div class="communique-actions">
                            <button class="btn btn-primary btn-sm" onclick="viewFullCommunique('${communique.id}')">
                                <i class="fas fa-eye"></i> Voir en d√©tail
                            </button>
                            ${!isPaid ? `
                                <button class="btn btn-success btn-sm" onclick="markCommuniqueAsPaid('${communique.id}')">
                                    <i class="fas fa-check"></i> Marquer comme pay√©
                                </button>
                            ` : ''}
                            <button class="btn btn-info btn-sm" onclick="printCommuniqueForParent('${communique.id}')">
                                <i class="fas fa-print"></i> Imprimer
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });

setTimeout(checkClientSideExpiration, 100);
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Erreur chargement communiqu√©s:', error);
        container.innerHTML = '<div class="no-data"><i class="fas fa-exclamation-triangle"></i><p>Erreur de chargement des communiqu√©s. Veuillez r√©essayer.</p></div>';
    }
}

// Fonction pour nettoyer TOUS les communiqu√©s expir√©s (√† ex√©cuter manuellement si besoin)
async function cleanupAllExpiredCommuniques() {
    if (!confirm('√ätes-vous s√ªr de vouloir nettoyer TOUS les communiqu√©s expir√©s ? Cette action est irr√©versible.')) {
        return;
    }
    
    try {
        showAlert('Nettoyage des communiqu√©s expir√©s en cours...', 'info');
        
        const now = new Date().toISOString();
        
        // 1. Trouver tous les communiqu√©s expir√©s
        const communiquesQuery = query(
            collection(db, 'parent_communiques'),
            where('expirationDate', '<=', now)
        );
        
        const communiquesSnap = await getDocs(communiquesQuery);
        
        let totalDeleted = 0;
        
        // 2. Supprimer chaque communiqu√© expir√©
        for (const communiqueDoc of communiquesSnap.docs) {
            await deleteExpiredCommunique(communiqueDoc.id);
            totalDeleted++;
        }
        
        showAlert(`‚úÖ Nettoyage termin√©: ${totalDeleted} communiqu√©(s) expir√©(s) supprim√©(s)`, 'success');
        
    } catch (error) {
        console.error('‚ùå Erreur nettoyage communiqu√©s:', error);
        showAlert('Erreur lors du nettoyage: ' + error.message, 'error');
    }
}

// Exposez la fonction pour l'ex√©cuter depuis la console
window.cleanupAllExpiredCommuniques = cleanupAllExpiredCommuniques;

// Nouvelle version de viewFullCommunique avec filtrage par enfant
async function viewFullCommunique(communiqueId) {
    console.log('üîç Affichage communiqu√©:', communiqueId);
    
    try {
        // R√©cup√©rer le communiqu√©
        const communiqueDoc = await getDoc(doc(db, 'parent_communiques', communiqueId));
        
        if (!communiqueDoc.exists()) {
            showAlert('Communiqu√© non trouv√©.', 'error');
            return;
        }
        
        const communiqueData = communiqueDoc.data();
        
        // R√©cup√©rer la relation parent-communiqu√©
        const relationQuery = query(
            collection(db, 'parent_communique_relations'),
            where('parentId', '==', currentParent.matricule),
            where('communiqueId', '==', communiqueId)
        );
        
        const relationSnap = await getDocs(relationQuery);
        
        if (relationSnap.empty) {
            showAlert('Aucune relation trouv√©e pour ce communiqu√©.', 'error');
            return;
        }
        
        const relationData = relationSnap.docs[0].data();
        
        // V√©rifier si un enfant est s√©lectionn√© dans le filtre
        const selectedChild = document.getElementById('communique-child-selector').value;
        
        // R√©cup√©rer les d√©tails des enfants concern√©s
        const childrenDetails = [];
        for (let i = 0; i < relationData.studentIds.length; i++) {
            const studentMatricule = relationData.studentIds[i];
            
            // Si un enfant est s√©lectionn√© dans le filtre, ne garder que celui-ci
            if (selectedChild && selectedChild !== 'all' && selectedChild !== studentMatricule) {
                continue;
            }
            
            // Chercher dans les 3 collections d'√©l√®ves
            let studentDoc = await getDoc(doc(db, 'students', studentMatricule));
            let studentType = 'secondary';
            
            if (!studentDoc.exists()) {
                studentDoc = await getDoc(doc(db, 'primary_students', studentMatricule));
                studentType = 'primary';
            }
            
            if (!studentDoc.exists()) {
                studentDoc = await getDoc(doc(db, 'kindergarten_students', studentMatricule));
                studentType = 'kindergarten';
            }
            
            if (studentDoc.exists()) {
                const studentData = studentDoc.data();
                childrenDetails.push({
                    matricule: studentMatricule,
                    name: studentData.fullName,
                    class: studentData.class,
                    type: studentType
                });
            }
        }
        
        // Si aucun enfant apr√®s filtrage
        if (childrenDetails.length === 0) {
            if (selectedChild && selectedChild !== 'all') {
                showAlert('Cet enfant n\'est pas concern√© par ce communiqu√©.', 'warning');
            } else {
                showAlert('Aucun enfant trouv√© pour ce communiqu√©.', 'error');
            }
            return;
        }
        
        // Dates
        const deadlineDate = new Date(communiqueData.deadline);
        const formattedDeadline = deadlineDate.toLocaleDateString('fr-FR', {
            day: '2-digit',
            month: 'long',
            year: 'numeric'
        });
        
        const today = new Date();
        const formattedToday = today.toLocaleDateString('fr-FR', {
            day: '2-digit',
            month: 'long',
            year: 'numeric'
        });
        
        // Construire le HTML
        let childrenHTML = '';
        childrenDetails.forEach((child, index) => {
            childrenHTML += `
                <div style="margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 5px;">
                    <p><strong>Enfant ${index + 1}:</strong> ${child.name}</p>
                    <p><strong>Matricule:</strong> ${child.matricule}</p>
                    <p><strong>Classe:</strong> ${child.class} (${child.type === 'secondary' ? 'Secondaire' : child.type === 'primary' ? 'Primaire' : 'Maternelle'})</p>
                </div>
            `;
        });
        
        // Calculer le montant par enfant
        const montantParEnfant = selectedChild && selectedChild !== 'all' 
            ? parseFloat(communiqueData.amount).toFixed(2)
            : (parseFloat(communiqueData.amount) / childrenDetails.length).toFixed(2);
        
        const fullContentHTML = `
            <div class="communique-full-header">
                <img src="R.png" alt="Logo CS la Colombe" class="communique-full-logo">
                <div class="communique-full-title">COMMUNIQUE DE PAIEMENT</div>
                <div>Complexe Scolaire la Colombe</div>
                <div>Lubumbashi, R√©publique D√©mocratique du Congo</div>
                <div>T√©l: +243 XXX XXX XXX</div>
            </div>
            
            <div class="communique-full-date">
                Lubumbashi, le ${formattedToday}
            </div>
            
            <div style="margin-bottom: 2rem;">
                <p><strong>√Ä l'attention de :</strong> ${currentParent.fullName}</p>
                <p><strong>Matricule parent :</strong> ${currentParent.matricule}</p>
                <p><strong>Email :</strong> ${currentParent.email}</p>
                <p><strong>T√©l√©phone :</strong> ${currentParent.phone}</p>
            </div>
            
            <div style="margin-bottom: 2rem;">
                <h4>Enfants concern√©s par ce communiqu√© :</h4>
                ${childrenHTML}
            </div>
            
            <div>
                <p><strong>Objet :</strong> Rappel concernant le paiement des frais de <strong>${communiqueData.feeType}</strong></p>
                
                <p>Cher(s) parent(s), tuteur(s) l√©gal(aux),</p>
                
                <p>L'√©tablissement <strong>Complexe Scolaire la Colombe</strong> vous adresse ce communiqu√© concernant le r√®glement des frais de <strong>${communiqueData.feeType}</strong> pour l'ann√©e scolaire <strong>${communiqueData.schoolYear}</strong>.</p>
                
                <p>Nous vous rappelons que la date limite pour le paiement du solde des frais de <strong>${communiqueData.feeType}</strong> pour le mois de <strong>${communiqueData.month}</strong> est fix√©e au <strong>${formattedDeadline}</strong>.</p>
                
                <p><strong>D√©tail des montants dus :</strong></p>
                
                <ul>
                    ${selectedChild && selectedChild !== 'all'
                        ? `<li>Frais de ${communiqueData.feeType.toLowerCase()} pour ${childrenDetails[0].name} : <strong>$${montantParEnfant}</strong></li>`
                        : childrenDetails.map((child, index) => 
                            `<li>Frais de ${communiqueData.feeType.toLowerCase()} pour ${child.name} (${child.class}) : <strong>$${montantParEnfant}</strong></li>`
                        ).join('')
                    }
                    ${childrenDetails.length > 1 && (!selectedChild || selectedChild === 'all')
                        ? `<li><strong>TOTAL :</strong> $${parseFloat(communiqueData.amount).toFixed(2)}</li>`
                        : ''
                    }
                </ul>
                
                ${communiqueData.message ? `<p><strong>Message additionnel :</strong> ${communiqueData.message}</p>` : ''}
                
                <p>Classes concern√©es par ce communiqu√© : ${communiqueData.classes.join(', ')}</p>
                
                <p>Nous vous remercions de votre compr√©hension et de votre collaboration.</p>
                
                <p>Bonne collaboration,<br>
                La Direction</p>
            </div>
            
            <div class="communique-full-signature">
                <p>Le Directeur</p>
                <div class="signature-line"></div>
            </div>
        `;
        

        // Dans la fonction loadCommuniques() du parent.html, modifiez l'affichage :

// Dans le HTML g√©n√©r√© pour chaque communiqu√©, ajoutez :
if (communiqueData.type === 'file' && communiqueData.fileInfo) {
    let fileIcon = 'fa-file';
    if (communiqueData.fileInfo.type.includes('pdf')) fileIcon = 'fa-file-pdf';
    else if (communiqueData.fileInfo.type.includes('image')) fileIcon = 'fa-file-image';
    else if (communiqueData.fileInfo.type.includes('word')) fileIcon = 'fa-file-word';
    
    html += `
        <div style="margin: 1rem 0; padding: 1rem; background: #e3f2fd; border-radius: 5px;">
            <h5><i class="fas ${fileIcon}"></i> Fichier joint</h5>
            <p>${communiqueData.fileInfo.name || 'Document'}</p>
            <button class="btn btn-primary btn-sm" onclick="downloadParentCommuniqueFile('${communique.id}')">
                <i class="fas fa-download"></i> T√©l√©charger le fichier
            </button>
        </div>
    `;
}

// Ajoutez cette fonction au scope global
window.downloadParentCommuniqueFile = async function(communiqueId) {
    try {
        const communiqueDoc = await getDoc(doc(db, 'parent_communiques', communiqueId));
        
        if (!communiqueDoc.exists()) {
            showAlert('Communiqu√© non trouv√©.', 'error');
            return;
        }
        
        const communiqueData = communiqueDoc.data();
        
        if (!communiqueData.fileInfo || !communiqueData.fileInfo.url) {
            showAlert('Ce communiqu√© ne contient pas de fichier.', 'warning');
            return;
        }
        
        // Ouvrir le fichier dans un nouvel onglet
        window.open(communiqueData.fileInfo.url, '_blank');
        
    } catch (error) {
        console.error('Erreur ouverture fichier:', error);
        showAlert('Erreur lors de l\'ouverture du fichier: ' + error.message, 'error');
    }
};document.getElementById('communique-full-content').innerHTML = fullContentHTML;
        
        // Stocker les donn√©es pour l'impression
        window.currentCommuniqueForPrint = {
            id: communiqueId,
            data: communiqueData,
            children: childrenDetails,
            parent: currentParent,
            selectedChild: selectedChild,
            montantParEnfant: montantParEnfant
        };
        
        // Afficher le modal
        document.getElementById('communique-full-modal').classList.remove('hidden');
        
    } catch (error) {
        console.error('Erreur affichage communiqu√©:', error);
        showAlert('Erreur lors de l\'affichage du communiqu√©: ' + error.message, 'error');
    }
}

// Exposer la fonction au scope global
window.viewFullCommunique = viewFullCommunique;

// Ajoutez cette fonction pour debugger
async function debugCommuniqueLoading() {
    console.log('üîç === D√âBOGAGE COMMUNIQU√âS ===');
    
    if (!currentParent) {
        console.log('‚ùå currentParent non d√©fini');
        return;
    }
    
    console.log('Parent actuel:', currentParent.matricule);
    console.log('Enfants:', childrenList);
    
    try {
        // V√©rifier les relations
        const relationsQuery = query(
            collection(db, 'parent_communique_relations'),
            where('parentId', '==', currentParent.matricule)
        );
        
        const relationsSnap = await getDocs(relationsQuery);
        console.log(`Relations trouv√©es: ${relationsSnap.size}`);
        
        relationsSnap.forEach(doc => {
            console.log('Relation:', doc.id, doc.data());
        });
        
        // V√©rifier les communiqu√©s
        const communiquesSnap = await getDocs(collection(db, 'parent_communiques'));
        console.log(`Communiqu√©s totaux: ${communiquesSnap.size}`);
        
    } catch (error) {
        console.error('Erreur debug:', error);
    }
    
    console.log('=== FIN D√âBOGAGE ===');
}

// Appelez cette fonction dans la console navigateur pour debugger
window.debugCommuniqueLoading = debugCommuniqueLoading;

// Imprimer le communiqu√© personnalis√©
async function printCommuniqueForParent(communiqueId) {
    try {
        // R√©cup√©rer les m√™mes donn√©es que pour l'affichage complet
        const communiqueDoc = await getDoc(doc(db, 'parent_communiques', communiqueId));
        
        if (!communiqueDoc.exists()) {
            showAlert('Communiqu√© non trouv√©.', 'error');
            return;
        }
        
        const communiqueData = communiqueDoc.data();
        
        // R√©cup√©rer la relation
        const relationQuery = query(
            collection(db, 'parent_communique_relations'),
            where('parentId', '==', currentParent.matricule),
            where('communiqueId', '==', communiqueId)
        );
        
        const relationSnap = await getDocs(relationQuery);
        
      // Cherchez et corrigez :
if (relationSnap.empty) { // <-- .empty au lieu de .empty()
    showAlert('Aucune relation trouv√©e.', 'error');
    return;
}
        
        const relationData = relationSnap.docs[0].data();
        
        // R√©cup√©rer les enfants
        const childrenDetails = [];
        for (const studentMatricule of relationData.studentIds) {
            // Chercher dans les 3 collections
            let studentDoc = await getDoc(doc(db, 'students', studentMatricule));
            if (!studentDoc.exists()) {
                studentDoc = await getDoc(doc(db, 'primary_students', studentMatricule));
            }
            if (!studentDoc.exists()) {
                studentDoc = await getDoc(doc(db, 'kindergarten_students', studentMatricule));
            }
            
            if (studentDoc.exists()) {
                const studentData = studentDoc.data();
                childrenDetails.push({
                    name: studentData.fullName,
                    matricule: studentMatricule,
                    class: studentData.class
                });
            }
        }
        
        const deadlineDate = new Date(communiqueData.deadline);
        const formattedDeadline = deadlineDate.toLocaleDateString('fr-FR', {
            day: '2-digit',
            month: 'long',
            year: 'numeric'
        });
        
        const today = new Date();
        const formattedToday = today.toLocaleDateString('fr-FR', {
            day: '2-digit',
            month: 'long',
            year: 'numeric'
        });
        
        // G√©n√©rer le PDF ou l'HTML √† imprimer
        const printHTML = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>Communiqu√© de paiement - CS la Colombe</title>
                <style>
                    body { 
                        font-family: 'Times New Roman', serif; 
                        margin: 40px; 
                        font-size: 14px;
                        line-height: 1.6;
                    }
                    .header { 
                        text-align: center; 
                        margin-bottom: 30px; 
                        border-bottom: 2px solid #3498db;
                        padding-bottom: 20px;
                    }
                    .logo { 
                        max-width: 120px; 
                        margin-bottom: 10px; 
                    }
                    .title { 
                        font-size: 18px; 
                        font-weight: bold; 
                        margin: 15px 0; 
                        text-decoration: underline;
                    }
                    .date { 
                        text-align: right; 
                        margin-bottom: 30px; 
                        font-style: italic; 
                        color: #666;
                    }
                    .parent-info {
                        background: #f8f9fa;
                        padding: 15px;
                        border-radius: 5px;
                        margin-bottom: 20px;
                    }
                    .children-info {
                        margin: 20px 0;
                    }
                    .child-card {
                        background: #f1f8ff;
                        padding: 10px;
                        margin: 10px 0;
                        border-left: 4px solid #3498db;
                        border-radius: 0 5px 5px 0;
                    }
                    .signature { 
                        margin-top: 100px; 
                        text-align: right; 
                    }
                    .signature-line { 
                        border-top: 1px solid #000; 
                        margin-top: 50px; 
                        width: 300px; 
                        margin-left: auto; 
                    }
                    strong { font-weight: bold; }
                    ul { padding-left: 20px; }
                    @media print {
                        body { margin: 20px; }
                        .no-print { display: none; }
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <img src="R.png" alt="Logo CS la Colombe" class="logo">
                    <div class="title">COMMUNIQUE DE PAIEMENT</div>
                    <div>Complexe Scolaire la Colombe</div>
                    <div>Lubumbashi, R√©publique D√©mocratique du Congo</div>
                    <div>T√©l: +243 XXX XXX XXX</div>
                </div>
                
                <div class="date">
                    Lubumbashi, le ${formattedToday}
                </div>
                
                <div class="parent-info">
                    <p><strong>√Ä l'attention de :</strong> ${currentParent.fullName}</p>
                    <p><strong>Matricule parent :</strong> ${currentParent.matricule}</p>
                    <p><strong>Email :</strong> ${currentParent.email}</p>
                    <p><strong>T√©l√©phone :</strong> ${currentParent.phone}</p>
                </div>
                
                <div class="children-info">
                    <h4>Enfants concern√©s par ce communiqu√© :</h4>
                    ${childrenDetails.map((child, index) => `
                        <div class="child-card">
                            <p><strong>Enfant ${index + 1}:</strong> ${child.name}</p>
                            <p><strong>Matricule :</strong> ${child.matricule}</p>
                            <p><strong>Classe :</strong> ${child.class}</p>
                        </div>
                    `).join('')}
                </div>
                
                <div>
                    <p><strong>Objet :</strong> Rappel concernant le paiement des frais de <strong>${communiqueData.feeType}</strong></p>
                    
                    <p>Cher(s) parent(s), tuteur(s) l√©gal(aux),</p>
                    
                    <p>L'√©tablissement <strong>Complexe Scolaire la Colombe</strong> vous adresse ce communiqu√© concernant le r√®glement des frais de <strong>${communiqueData.feeType}</strong> pour l'ann√©e scolaire <strong>${communiqueData.schoolYear}</strong>.</p>
                    
                    <p>Nous vous rappelons que la date limite pour le paiement du solde des frais de <strong>${communiqueData.feeType}</strong> pour le mois de <strong>${communiqueData.month}</strong> est fix√©e au <strong>${formattedDeadline}</strong>.</p>
                    
                    <p><strong>D√©tail des montants dus :</strong></p>
                    
                    <ul>
                        <li>Frais de ${communiqueData.feeType.toLowerCase()} : <strong>$${parseFloat(communiqueData.amount).toFixed(2)}</strong></li>
                    </ul>
                    
                    ${communiqueData.message ? `<p><strong>Message additionnel :</strong> ${communiqueData.message}</p>` : ''}
                    
                    <p>Classes concern√©es par ce communiqu√© : ${communiqueData.classes.join(', ')}</p>
                    
                    <p>Nous vous remercions de votre compr√©hension et de votre collaboration.</p>
                    
                    <p>Bonne collaboration,<br>
                    La Direction</p>
                </div>
                
                <div class="signature">
                    <p>Le Directeur</p>
                    <div class="signature-line"></div>
                </div>
                
                <div class="no-print" style="text-align: center; margin-top: 50px; color: #666; font-size: 12px;">
                    <p>Document g√©n√©r√© automatiquement le ${new Date().toLocaleString('fr-FR')}</p>
                    <p>ID du communiqu√©: ${communiqueId}</p>
                </div>
                
                <script>
                    window.onload = function() {
                        window.print();
                        setTimeout(function() {
                            window.close();
                        }, 1000);
                    }
                <\/script>
            </body>
            </html>
        `;
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(printHTML);
        printWindow.document.close();
        
    } catch (error) {
        console.error('Erreur impression communiqu√©:', error);
        showAlert('Erreur lors de l\'impression: ' + error.message, 'error');
    }
}

// Fonction pour supprimer les communiqu√©s expir√©s
async function cleanupExpiredCommuniques() {
    if (!currentParent) return;
    
    try {
        const now = new Date();
        
        // 1. Supprimer les relations expir√©es
        const relationsQuery = query(
            collection(db, 'parent_communique_relations'),
            where('parentId', '==', currentParent.matricule)
        );
        
        const relationsSnap = await getDocs(relationsQuery);
        
        const batch = writeBatch(db);
        let deletedCount = 0;
        
        for (const relationDoc of relationsSnap.docs) {
            const relationData = relationDoc.data();
            
            // V√©rifier si la relation est expir√©e
            if (relationData.expirationDate) {
                const expirationDate = relationData.expirationDate.toDate();
                if (expirationDate < now) {
                    // Supprimer la relation
                    batch.delete(relationDoc.ref);
                    deletedCount++;
                    
                    // V√©rifier si d'autres relations existent pour ce communiqu√©
                    const communiqueId = relationData.communiqueId;
                    const otherRelationsQuery = query(
                        collection(db, 'parent_communique_relations'),
                        where('communiqueId', '==', communiqueId)
                    );
                    
                    const otherRelationsSnap = await getDocs(otherRelationsQuery);
                    
                    // Si aucune autre relation n'existe, supprimer aussi le communiqu√©
                    if (otherRelationsSnap.size === 1) {
                        const communiqueRef = doc(db, 'parent_communiques', communiqueId);
                        batch.delete(communiqueRef);
                    }
                }
            }
        }
        
        if (deletedCount > 0) {
            await batch.commit();
            console.log(`üßπ ${deletedCount} communiqu√©(s) expir√©(s) supprim√©(s)`);
            
            // Recharger la liste si on est sur la page des communiqu√©s
            if (document.getElementById('communiques-page').classList.contains('active')) {
                loadCommuniques();
            }
        }
        
    } catch (error) {
        console.error('Erreur nettoyage communiqu√©s:', error);
    }
}
// Fonction pour v√©rifier et masquer les communiqu√©s expir√©s c√¥t√© client
function checkClientSideExpiration() {
    const now = new Date();
    const communiqueCards = document.querySelectorAll('.communique-card');
    
    communiqueCards.forEach(card => {
        const expirationAttr = card.getAttribute('data-expiration');
        if (expirationAttr) {
            const expirationDate = new Date(expirationAttr);
            
            if (expirationDate <= now) {
                // Masquer le communiqu√© expir√©
                card.style.display = 'none';
                console.log(`üóëÔ∏è C√¥t√© client: Communiqu√© ${card.getAttribute('data-communique-id')} masqu√© (expir√©)`);
            }
        }
    });
}

// Appelez cette fonction apr√®s le chargement des communiqu√©s
// Dans loadCommuniques(), ajoutez √† la fin :
setTimeout(checkClientSideExpiration, 100);

// Appeler le nettoyage r√©guli√®rement
function scheduleCommuniqueCleanup() {
    // Nettoyer toutes les 6 heures
    setInterval(cleanupExpiredCommuniques, 6 * 60 * 60 * 1000);
    
    // Nettoyer au d√©marrage
    setTimeout(cleanupExpiredCommuniques, 5000);
}

// Marquer un communiqu√© comme pay√©
async function markCommuniqueAsPaid(communiqueId) {
    if (!confirm('Voulez-vous marquer ce communiqu√© comme pay√© ?')) {
        return;
    }
    
    try {
        // Mettre √† jour le statut dans la relation parent-communiqu√©
        const relationQuery = query(
            collection(db, 'parent_communique_relations'),
            where('parentId', '==', currentParent.matricule),
            where('communiqueId', '==', communiqueId)
        );
        
        const relationSnap = await getDocs(relationQuery);
        
        if (!relationSnap.empty) {
            const relationDoc = relationSnap.docs[0];
            await updateDoc(doc(db, 'parent_communique_relations', relationDoc.id), {
                status: 'paid',
                paidAt: serverTimestamp()
            });
        }
        
        // Marquer aussi dans la collection student_communique_relations
        for (const child of childrenList) {
            const studentRelationRef = doc(db, 'student_communique_relations', `${child.matricule}_${communiqueId}`);
            await updateDoc(studentRelationRef, {
                status: 'paid',
                paidAt: serverTimestamp()
            });
        }
        
        showAlert('Communiqu√© marqu√© comme pay√© avec succ√®s.', 'success');
        
        // Recharger la liste
        loadCommuniques();
        
    } catch (error) {
        console.error('Erreur marquage communiqu√©:', error);
        showAlert('Erreur lors du marquage: ' + error.message, 'error');
    }
}

// Initialiser les s√©lecteurs d'enfants pour les communiqu√©s
function initCommuniqueSelectors() {
    const childSelector = document.getElementById('communique-child-selector');
    
    // R√©initialiser
    childSelector.innerHTML = '<option value="all">Tous mes enfants</option>';
    
    // Ajouter chaque enfant
    childrenList.forEach(child => {
        const displayText = `${child.fullName} - ${child.class} (${child.type === 'secondary' ? 'Sec' : child.type === 'primary' ? 'Prim' : 'Mat'})`;
        childSelector.innerHTML += `<option value="${child.matricule}">${displayText}</option>`;
    });
    
    // Ajouter les √©v√©nements
    childSelector.addEventListener('change', () => loadCommuniques());
    document.getElementById('communique-type-filter').addEventListener('change', () => loadCommuniques());
    document.getElementById('refresh-communiques-btn').addEventListener('click', () => loadCommuniques());
}

// Gestionnaire d'√©v√©nement pour le bouton d'impression dans le modal
document.getElementById('print-communique-btn').addEventListener('click', function() {
    if (window.currentCommuniqueForPrint) {
        printCommuniqueForParent(window.currentCommuniqueForPrint.id);
    }
});
// Fonction optimis√©e pour les notifications en temps r√©el
async function setupRealTimeNotificationsOptimized() {
  if (!currentParent) return;
  
  // UN seul √©couteur Firestore pour toutes les notifications
  const notificationsQuery = query(
    collection(db, 'notifications'),
    where('parentId', '==', currentParent.matricule),
    where('read', '==', false),
    orderBy('createdAt', 'desc'),
    limit(20)
  );
  
  // √âcouter les nouvelles notifications
  onSnapshot(notificationsQuery, (snapshot) => {
    snapshot.docChanges().forEach(change => {
      if (change.type === 'added') {
        const notification = change.doc.data();
        
        // Afficher IMM√âDIATEMENT
        showLocalNotification(
          notification.title,
          notification.body,
          notification.data || {}
        );
        
        // Mettre √† jour le compteur
        updateNotificationCount(1);
        
        // Marquer comme vue apr√®s affichage
        setTimeout(() => {
          updateDoc(doc(db, 'notifications', change.doc.id), {
            read: true
          });
        }, 5000);
      }
    });
  });
  
  // V√©rifier toutes les 5 minutes en arri√®re-plan
  setInterval(async () => {
    await checkForNewData();
  }, 5 * 60 * 1000);
}


function showNotificationToast(notification) {
    const toast = document.createElement('div');
    toast.className = `notification-toast ${notification.type}`;
    toast.innerHTML = `
        <div class="notification-header">
            <div class="notification-title">${notification.title}</div>
            <button class="notification-close">&times;</button>
        </div>
        <div class="notification-body">${notification.body}</div>
        <div class="notification-actions">
            <button class="btn btn-primary btn-sm" onclick="window.openNotification('${notification.id}')">Voir</button>
            <button class="btn btn-secondary btn-sm" onclick="window.markNotificationAsRead('${notification.id}')">Marquer comme lu</button>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('show');
    }, 100);
    
    // Fermer le toast


    toast.querySelector('.notification-close').addEventListener('click', () => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    });
    
    // Fermer automatiquement apr√®s 10 secondes
    setTimeout(() => {
        if (toast.parentNode) {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }
    }, 10000);
}



// === FONCTIONS DE NOTIFICATIONS LOCALES AUTOMATIQUES ===

// Fonction pour sauvegarder les donn√©es dans IndexedDB
async function saveParentDataToIndexedDB() {
    if (!currentParent || !childrenList) return;
    
    const parentData = {
        matricule: currentParent.matricule,
        fullName: currentParent.fullName,
        email: currentParent.email,
        phone: currentParent.phone,
        children: childrenList.map(child => ({
            matricule: child.matricule,
            fullName: child.fullName,
            class: child.class,
            type: child.type
        })),
        lastUpdate: new Date().toISOString()
    };
    
    try {
        const request = indexedDB.open('ParentAppDB', 1);
        
        request.onupgradeneeded = function(event) {
            const db = event.target.result;
            if (!db.objectStoreNames.contains('parent')) {
                db.createObjectStore('parent', { keyPath: 'id' });
            }
            if (!db.objectStoreNames.contains('notifications')) {
                db.createObjectStore('notifications', { keyPath: 'id' });
            }
        };
        
        request.onsuccess = function(event) {
            const db = event.target.result;
            const transaction = db.transaction(['parent'], 'readwrite');
            const store = transaction.objectStore('parent');
            
            const dataToSave = {
                id: 'currentParent',
                ...parentData
            };
            
            store.put(dataToSave);
            
            transaction.oncomplete = function() {
                console.log('‚úÖ Donn√©es parent sauvegard√©es dans IndexedDB');
            };
        };
        
    } catch (error) {
        console.error('‚ùå Erreur IndexedDB:', error);
    }
}

// Fonction pour afficher une notification locale persistante
function showLocalNotification(title, body, data = {}) {
    if ('Notification' in window && Notification.permission === 'granted') {
        const notification = new Notification(title, {
            body: body,
            icon: 'icon-192x192.png',
            badge: 'icon-72x72.png',
            data: data,
            tag: data.type || 'general',
            requireInteraction: true,
            vibrate: [200, 100, 200],
            silent: false
        });
        
        // G√©rer le clic sur la notification
        notification.onclick = function(event) {
            event.preventDefault();
            window.focus();
            notification.close();
            
            // Naviguer vers la page appropri√©e
            if (data.page) {
                const link = document.querySelector(`.nav-menu a[data-page="${data.page}"]`);
                if (link) {
                    document.querySelectorAll('.nav-menu a, .page').forEach(el => el.classList.remove('active'));
                    link.classList.add('active');
                    document.getElementById(`${data.page}-page`).classList.add('active');
                    document.getElementById('page-title').textContent = link.textContent;
                    
                    // Si c'est la page des notes, charger l'enfant concern√©
                    if (data.page === 'grades' && data.childId) {
                        const selector = document.getElementById('secondary-grades-child-selector');
                        if (selector) {
                            selector.value = data.childId;
                            selector.dispatchEvent(new Event('change'));
                        }
                    }
                    
                    // Si c'est la page pr√©sence/incidents
                    if (data.page === 'presence-incidents' && data.childId) {
                        const selector = document.getElementById('presence-child-selector');
                        if (selector) {
                            selector.value = data.childId;
                            selector.dispatchEvent(new Event('change'));
                        }
                    }
                }
            }
        };
        
        // Mettre √† jour le compteur de notifications
        updateNotificationCount(1);
        
        // Ajouter √† la liste des notifications
        const notificationObj = {
            id: `local_${Date.now()}`,
            title: title,
            body: body,
            type: data.type || 'general',
            data: data,
            timestamp: new Date().toISOString(),
            read: false
        };
        
        notifications.unshift(notificationObj);
        saveNotificationsToStorage();
        
        return notification;
    }
    return null;
}

// Fonction pour stocker une notification √† afficher plus tard
function storeNotificationForLater(title, body, data = {}) {
    const pendingNotifications = JSON.parse(localStorage.getItem('pending_notifications') || '[]');
    
    pendingNotifications.push({
        title,
        body,
        data,
        timestamp: Date.now(),
        shown: false
    });
    
    // Garder seulement les 20 derni√®res
    if (pendingNotifications.length > 20) {
        pendingNotifications.shift();
    }
    
    localStorage.setItem('pending_notifications', JSON.stringify(pendingNotifications));
    
    // Mettre √† jour le badge
    updateAppBadge(pendingNotifications.filter(n => !n.shown).length);
}

// Fonction pour afficher les notifications en attente
function showPendingNotifications() {
    if (!('Notification' in window) || Notification.permission !== 'granted') {
        return;
    }
    
    const pendingNotifications = JSON.parse(localStorage.getItem('pending_notifications') || '[]');
    const unshownNotifications = pendingNotifications.filter(n => !n.shown);
    
    unshownNotifications.forEach((notification, index) => {
        // √âchelonner l'affichage pour √©viter le spam
        setTimeout(() => {
            showLocalNotification(notification.title, notification.body, notification.data);
            
            // Marquer comme affich√©e
            notification.shown = true;
            pendingNotifications[index] = notification;
            localStorage.setItem('pending_notifications', JSON.stringify(pendingNotifications));
            
        }, index * 1000); // 1 seconde entre chaque notification
    });
}

// Fonction pour mettre √† jour le badge de l'application
function updateAppBadge(count) {
    if ('setAppBadge' in navigator) {
        navigator.setAppBadge(count).catch(error => {
            console.error('Erreur badge:', error);
        });
    }
}

// Fonction pour initialiser les notifications p√©riodiques
function initializePeriodicNotifications() {
    // V√©rifier toutes les 30 minutes
    setInterval(checkForNewData, 30 * 60 * 1000);
    
    // V√©rifier aussi quand l'app reprend le focus
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
            checkForNewData();
        }
    });
    
    // V√©rifier au d√©marrage
    setTimeout(checkForNewData, 5000);
}

// Fonction pour v√©rifier les nouvelles donn√©es
async function checkForNewData() {
    if (!currentParent || childrenList.length === 0) return;
    
    console.log('üîç V√©rification des nouvelles donn√©es...');
    
    try {
        // V√©rifier les nouvelles notes
        await checkNewGrades();
        
        // V√©rifier les nouveaux incidents
        await checkNewIncidents();
        
        // V√©rifier les nouveaux devoirs
        await checkNewHomework();
        
        // V√©rifier les nouvelles pr√©sences
        await checkNewPresences();
        
    } catch (error) {
        console.error('‚ùå Erreur v√©rification donn√©es:', error);
    }
}

// V√©rifier les nouvelles notes
async function checkNewGrades() {
    for (const child of childrenList) {
        if (child.type === 'secondary') {
            try {
                const gradesQuery = query(
                    collection(db, 'published_grades'),
                    where('className', '==', child.class),
                    orderBy('publishedAt', 'desc'),
                    limit(5)
                );
                
                const gradesSnap = await getDocs(gradesQuery);
                
                gradesSnap.forEach(doc => {
                    const gradeData = doc.data();
                    const hasStudentGrade = gradeData.grades?.some(g => 
                        g.studentMatricule === child.matricule
                    );
                    
                    if (hasStudentGrade) {
                        // V√©rifier si cette note est nouvelle (moins de 24h)
                        const publishedAt = gradeData.publishedAt?.toDate() || new Date();
                        const now = new Date();
                        const hoursDiff = (now - publishedAt) / (1000 * 60 * 60);
                        
                        if (hoursDiff < 24) {
                            // V√©rifier si on a d√©j√† notifi√© cette note
                            const notificationKey = `notified_grade_${doc.id}_${child.matricule}`;
                            if (!localStorage.getItem(notificationKey)) {
                                
                                showLocalNotification(
                                    'üìä Nouvelle note publi√©e',
                                    `${child.fullName} a une nouvelle note en ${gradeData.subject}: ${gradeData.gradeType}`,
                                    {
                                        type: 'grades',
                                        page: 'grades',
                                        childId: child.matricule,
                                        childName: child.fullName,
                                        gradeId: doc.id
                                    }
                                );
                                
                                // Marquer comme notifi√©
                                localStorage.setItem(notificationKey, 'true');
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error(`Erreur v√©rification notes ${child.fullName}:`, error);
            }
        }
    }
}

// V√©rifier les nouveaux incidents
async function checkNewIncidents() {
    for (const child of childrenList) {
        try {
            const incidentsQuery = query(
                collection(db, 'incidents'),
                where('studentMatricule', '==', child.matricule),
                orderBy('createdAt', 'desc'),
                limit(5)
            );
            
            const incidentsSnap = await getDocs(incidentsQuery);
            
            incidentsSnap.forEach(doc => {
                const incident = doc.data();
                
                // V√©rifier si cet incident est nouveau (moins de 24h)
                const createdAt = incident.createdAt?.toDate() || new Date();
                const now = new Date();
                const hoursDiff = (now - createdAt) / (1000 * 60 * 60);
                
                if (hoursDiff < 24) {
                    // V√©rifier si on a d√©j√† notifi√© cet incident
                    const notificationKey = `notified_incident_${doc.id}_${child.matricule}`;
                    if (!localStorage.getItem(notificationKey)) {
                        
                        showLocalNotification(
                            '‚ö†Ô∏è Nouvel incident signal√©',
                            `${child.fullName}: ${incident.type || 'Incident'}`,
                            {
                                type: 'incidents',
                                page: 'presence-incidents',
                                childId: child.matricule,
                                childName: child.fullName,
                                incidentId: doc.id
                            }
                        );
                        
                        // Marquer comme notifi√©
                        localStorage.setItem(notificationKey, 'true');
                    }
                }
            });
            
        } catch (error) {
            console.error(`Erreur v√©rification incidents ${child.fullName}:`, error);
        }
    }
}

// V√©rifier les nouveaux devoirs
async function checkNewHomework() {
    for (const child of childrenList) {
        if (child.type === 'secondary') {
            try {
                const homeworkQuery = query(
                    collection(db, 'homework'),
                    where('className', '==', child.class),
                    orderBy('createdAt', 'desc'),
                    limit(5)
                );
                
                const homeworkSnap = await getDocs(homeworkQuery);
                
                homeworkSnap.forEach(doc => {
                    const homework = doc.data();
                    
                    // V√©rifier si ce devoir est nouveau (moins de 24h)
                    const createdAt = homework.createdAt?.toDate() || new Date();
                    const now = new Date();
                    const hoursDiff = (now - createdAt) / (1000 * 60 * 60);
                    
                    if (hoursDiff < 24) {
                        // V√©rifier si on a d√©j√† notifi√© ce devoir
                        const notificationKey = `notified_homework_${doc.id}_${child.matricule}`;
                        if (!localStorage.getItem(notificationKey)) {
                            
                            showLocalNotification(
                                'üìö Nouveau devoir assign√©',
                                `${child.fullName}: ${homework.subject} - ${homework.title}`,
                                {
                                    type: 'homework',
                                    page: 'homework',
                                    childId: child.matricule,
                                    childName: child.fullName,
                                    homeworkId: doc.id
                                }
                            );
                            
                            // Marquer comme notifi√©
                            localStorage.setItem(notificationKey, 'true');
                        }
                    }
                });
                
            } catch (error) {
                console.error(`Erreur v√©rification devoirs ${child.fullName}:`, error);
            }
        }
    }
}

// V√©rifier les nouvelles pr√©sences
async function checkNewPresences() {
    for (const child of childrenList) {
        try {
            const today = new Date().toISOString().split('T')[0];
            const presenceQuery = query(
                collection(db, 'student_attendance'),
                where('studentId', '==', child.matricule),
                where('date', '==', today)
            );
            
            const presenceSnap = await getDocs(presenceQuery);
            
            presenceSnap.forEach(doc => {
                const presence = doc.data();
                
                // V√©rifier si cette pr√©sence est nouvelle
                const notificationKey = `notified_presence_${doc.id}_${child.matricule}`;
                if (!localStorage.getItem(notificationKey) && presence.published === true) {
                    
                    let statusText = '';
                    if (presence.status === 'absent') statusText = 'est absent';
                    else if (presence.status === 'late') statusText = 'est en retard';
                    else if (presence.status === 'present') statusText = 'est pr√©sent';
                    
                    if (statusText) {
                        showLocalNotification(
                            'üìÖ Mise √† jour pr√©sence',
                            `${child.fullName} ${statusText} aujourd'hui`,
                            {
                                type: 'presence',
                                page: 'presence-incidents',
                                childId: child.matricule,
                                childName: child.fullName
                            }
                        );
                        
                        // Marquer comme notifi√©
                        localStorage.setItem(notificationKey, 'true');
                    }
                }
            });
            
        } catch (error) {
            console.error(`Erreur v√©rification pr√©sences ${child.fullName}:`, error);
        }
    }
}

// === INITIALISATION DES NOTIFICATIONS ===

async function initializeAllNotifications() {
    // 1. Demander la permission si n√©cessaire
    if (Notification.permission === 'default') {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
            showToast('Notifications activ√©es avec succ√®s!', 'success');
        }
    }
    
    // 2. Sauvegarder les donn√©es parent
    await saveParentDataToIndexedDB();
    
    // 3. Initialiser les v√©rifications p√©riodiques
    initializePeriodicNotifications();
    
    // 4. Afficher les notifications en attente
    setTimeout(showPendingNotifications, 3000);
    
    // 5. V√©rifier une premi√®re fois apr√®s 5 secondes
    setTimeout(checkForNewData, 5000);
}

// Modifiez la fonction onAuthStateChanged pour inclure l'initialisation
onAuthStateChanged(auth, async (user) => {
    if (user) {
        const q = query(collection(db, 'parents'), where('uid', '==', user.uid));
        const snap = await getDocs(q);
        if (!snap.empty) {
            currentParent = { id: snap.docs[0].id, ...snap.docs[0].data() };
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('app-root').classList.remove('hidden');
            document.getElementById('parent-name').textContent = currentParent.fullName;
            
            // Afficher la photo de profil...
            
            // Charger les donn√©es parent
            await loadParentData();
            
            // Initialiser toutes les notifications
            initializeAllNotifications();

// Initialiser les s√©lecteurs pour les communiqu√©s
initCommuniqueSelectors();
            
            // Configurer les √©couteurs en temps r√©el
            setupRealTimeNotifications();
            
        } else {
            await signOut(auth);
            showAlert("Acc√®s refus√©.", "error");
        }
    } else {
        document.getElementById('login-overlay').classList.remove('hidden');
        document.getElementById('app-root').classList.add('hidden');
    }
});

function updateNotificationCount(countChange = 0) {
    const notificationCount = document.getElementById('notification-count');
    let currentCount = parseInt(notificationCount.textContent) || 0;
    
    if (countChange !== 0) {
        currentCount += countChange;
        if (currentCount < 0) currentCount = 0;
        notificationCount.textContent = currentCount;
    }
    
    if (currentCount > 0) {
        notificationCount.classList.remove('hidden');
        // Ajouter une animation au bouton de notification
        const bell = document.getElementById('notification-bell');
        bell.style.animation = 'pulse 1.5s infinite';
    } else {
        notificationCount.classList.add('hidden');
        const bell = document.getElementById('notification-bell');
        bell.style.animation = '';
    }
}

function updateNotificationStatus(message) {
    const statusElement = document.getElementById('notification-status');
    statusElement.textContent = message;
    statusElement.style.color = 'var(--success)';
}

async function sendTestNotification(token = null) {
    if (!currentParent) {
        showToast('Veuillez vous connecter d\'abord', 'error');
        return;
    }

    try {
        const fcmToken = token || currentParent.fcmToken;
        
        if (!fcmToken) {
            showToast('Token FCM non disponible. Activez d\'abord les notifications.', 'warning');
            return;
        }

        console.log('üîî Envoi notification test √†:', fcmToken.substring(0, 20) + '...');
        
        // Option 1: Envoyer via une Cloud Function ou votre backend
        // Option 2: Utiliser Firebase Admin SDK c√¥t√© serveur
        // Pour le test, on peut utiliser une notification locale
        
        // Notification locale pour test
        const notification = {
            id: `test_${Date.now()}`,
            title: '‚úÖ Test de notification',
            body: 'Les notifications push fonctionnent correctement! Si vous voyez ce message, les notifications sont configur√©es.',
            type: 'test',
            data: {
                page: 'dashboard',
                childId: childrenList.length > 0 ? childrenList[0].matricule : null,
                childName: childrenList.length > 0 ? childrenList[0].fullName : null,
                timestamp: new Date().toISOString()
            },
            timestamp: new Date().toISOString(),
            read: false
        };

        // Ajouter √† la liste des notifications
        notifications.unshift(notification);
        updateNotificationCount(1);
        showNotificationToast(notification);
        saveNotificationsToStorage();
        
        showToast('Notification de test envoy√©e avec succ√®s', 'success');
        
        // Si vous avez un backend, d√©commentez ceci :
        /*
        const response = await fetch('https://votre-backend.com/send-test-notification', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                token: fcmToken,
                title: 'Test de notification',
                body: 'Ceci est un test de notification push!',
                data: {
                    type: 'test',
                    page: 'dashboard'
                }
            })
        });
        
        if (response.ok) {
            showToast('Notification de test envoy√©e avec succ√®s', 'success');
        } else {
            throw new Error('Erreur serveur');
        }
        */
        
    } catch (error) {
        console.error('Erreur envoi notification test:', error);
        showToast('Erreur lors de l\'envoi de la notification de test', 'error');
    }
}


async function debugNotifications() {
    console.log('üîç === D√âBOGAGE NOTIFICATIONS ===');
    
    // 1. V√©rifier Service Worker
    if (!navigator.serviceWorker) {
        console.log('‚ùå Service Worker non support√©');
        return;
    }
    
    const registration = await navigator.serviceWorker.getRegistration();
    console.log('Service Worker enregistr√©:', registration ? '‚úÖ OUI' : '‚ùå NON');
    
    if (registration) {
        console.log('Scope:', registration.scope);
        console.log('√âtat:', registration.active?.state);
        console.log('Script:', registration.active?.scriptURL);
    }
    
    // 2. V√©rifier permissions
    const permission = await Notification.permission;
    console.log('Permission:', permission);
    
    // 3. V√©rifier Firebase Messaging
    if (!messaging) {
        console.log('‚ùå Firebase Messaging non initialis√©');
    } else {
        console.log('‚úÖ Firebase Messaging initialis√©');
        
        try {
            const token = await getToken(messaging);
            console.log('Token FCM:', token ? '‚úÖ PR√âSENT' : '‚ùå ABSENT');
            if (token) {
                console.log('Token (partiel):', token.substring(0, 30) + '...');
            }
        } catch (tokenError) {
            console.error('Erreur token:', tokenError);
        }
    }
    
    // 4. V√©rifier la cl√© VAPID
    console.log('VAPID Key configur√©e:', "BFc44CIL4VykUiY8_17s_HbUm5pRqhNhlFcy35H0XKuyFIq-2472MTfMZBfKMxW81DCHTkRB4xy_WaH-f3Ik2TM");
    
    // 5. Tester une notification locale
    if (Notification.permission === 'granted') {
        console.log('üîî Test notification locale...');
        new Notification('Test local', {
            body: 'Ceci est un test de notification locale',
            icon: 'icon-192x192.png'
        });
    }
    
    console.log('=== FIN D√âBOGAGE ===');
}

// Ajoutez un bouton pour d√©boguer
document.addEventListener('DOMContentLoaded', function() {
    const debugBtn = document.createElement('button');
    debugBtn.id = 'debug-notifications-btn';
    debugBtn.className = 'btn btn-warning btn-sm';
    debugBtn.innerHTML = '<i class="fas fa-bug"></i> D√©boguer Notifications';
    debugBtn.style.position = 'fixed';
    debugBtn.style.bottom = '10px';
    debugBtn.style.right = '10px';
    debugBtn.style.zIndex = '9999';
    debugBtn.onclick = debugNotifications;
    
    document.body.appendChild(debugBtn);
});

function loadNotificationsFromStorage() {
    try {
        const saved = localStorage.getItem('parent_notifications');
        if (saved) {
            notifications = JSON.parse(saved);
            
            // Compter les notifications non lues
            const unreadCount = notifications.filter(n => !n.read).length;
            updateNotificationCount(unreadCount);
        }
    } catch (error) {
        console.error('Erreur chargement notifications:', error);
    }
}

function saveNotificationsToStorage() {
    try {
        // Garder seulement les 50 derni√®res notifications
        if (notifications.length > 50) {
            notifications = notifications.slice(0, 50);
        }
        localStorage.setItem('parent_notifications', JSON.stringify(notifications));
    } catch (error) {
        console.error('Erreur sauvegarde notifications:', error);
    }
}

function displayNotifications(filter = 'all') {
    const container = document.getElementById('notifications-list-container');
    
    let filteredNotifications = notifications;
    if (filter !== 'all') {
        filteredNotifications = notifications.filter(n => n.type === filter);
    }
    
    // Filtrer pour n'afficher que les notifications des enfants de ce parent
    filteredNotifications = filteredNotifications.filter(notification => {
        if (!notification.data.childId) {
            // Notification g√©n√©rale (annonces, etc.) - on l'affiche
            return true;
        }
        // V√©rifier que l'enfant appartient bien √† ce parent
        return childrenList.some(child => child.matricule === notification.data.childId);
    });
    
    if (filteredNotifications.length === 0) {
        container.innerHTML = `
            <div class="no-data">
                <i class="fas fa-bell-slash"></i>
                <h3>Aucune notification</h3>
                <p>Vous n'avez aucune notification pour le moment.</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    filteredNotifications.forEach(notification => {
        const date = new Date(notification.timestamp).toLocaleDateString('fr-FR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        const badgeClass = getBadgeClassForType(notification.type);
        const icon = getIconForType(notification.type);
        
        // Ajouter le nom de l'enfant si pr√©sent
        const childInfo = notification.data.childName ? 
            `<span style="color: var(--primary); margin-left: 5px;">(${notification.data.childName})</span>` : '';
        
        html += `
            <div class="notification-item ${notification.read ? 'read' : 'unread'}" data-id="${notification.id}">
                <div class="notification-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="${icon}" style="color: var(--${badgeClass});"></i>
                        <strong>${notification.title}</strong>
                        ${childInfo}
                        <span class="badge badge-${badgeClass}">${getTypeLabel(notification.type)}</span>
                    </div>
                    <div>
                        ${!notification.read ? '<span class="badge badge-danger" style="font-size: 0.7rem;">Nouveau</span>' : ''}
                        <small style="color: #666; margin-left: 10px;">${date}</small>
                    </div>
                </div>
                <div style="margin-left: 30px;">
                    <p>${notification.body}</p>
                    <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
                        ${!notification.read ? `
                            <button class="btn btn-success btn-sm" onclick="markNotificationAsRead('${notification.id}')">
                                <i class="fas fa-check"></i> Marquer comme lu
                            </button>
                        ` : ''}
                        <button class="btn btn-info btn-sm" onclick="viewNotification('${notification.id}')">
                            <i class="fas fa-eye"></i> Voir
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteNotification('${notification.id}')">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function getBadgeClassForType(type) {
    const typeMap = {
        'grades': 'success',
        'homework': 'warning',
        'incidents': 'danger',
        'payments': 'info',
        'messages': 'primary',
        'announcements': 'secondary',
        'test': 'info'
    };
    return typeMap[type] || 'primary';
}

function getIconForType(type) {
    const iconMap = {
        'grades': 'fas fa-chart-line',
        'homework': 'fas fa-book',
        'incidents': 'fas fa-exclamation-triangle',
        'payments': 'fas fa-money-bill',
        'messages': 'fas fa-envelope',
        'announcements': 'fas fa-bullhorn',
        'test': 'fas fa-bell'
    };
    return iconMap[type] || 'fas fa-bell';
}

function getTypeLabel(type) {
    const labelMap = {
        'grades': 'Nouvelle note',
        'homework': 'Devoir',
        'incidents': 'Incident',
        'payments': 'Paiement',
        'messages': 'Message',
        'announcements': 'Annonce',
        'test': 'Test'
    };
    return labelMap[type] || 'Notification';
}

// Fonctions expos√©es globalement pour les boutons
window.markNotificationAsRead = function(id) {
    const notification = notifications.find(n => n.id === id);
    if (notification && !notification.read) {
        notification.read = true;
        updateNotificationCount(-1);
        saveNotificationsToStorage();
        
        // Mettre √† jour l'affichage
        if (document.getElementById('notifications-page').classList.contains('active')) {
            displayNotifications(document.getElementById('notification-filter').value);
        }
        
        showToast('Notification marqu√©e comme lue', 'success');
    }
};

window.viewNotification = function(id) {
    const notification = notifications.find(n => n.id === id);
    if (notification) {
        // Marquer comme lu
        if (!notification.read) {
            window.markNotificationAsRead(id);
        }
        
        // Naviguer vers la page appropri√©e
        if (notification.data && notification.data.page) {
            const link = document.querySelector(`.nav-menu a[data-page="${notification.data.page}"]`);
            if (link) link.click();
        }
        
        showToast('Ouverture de la notification', 'info');
    }
};

window.deleteNotification = function(id) {
    const index = notifications.findIndex(n => n.id === id);
    if (index !== -1) {
        const wasUnread = !notifications[index].read;
        notifications.splice(index, 1);
        
        if (wasUnread) {
            updateNotificationCount(-1);
        }
        
        saveNotificationsToStorage();
        
        // Mettre √† jour l'affichage
        if (document.getElementById('notifications-page').classList.contains('active')) {
            displayNotifications(document.getElementById('notification-filter').value);
        }
        
        showToast('Notification supprim√©e', 'success');
    }
};

window.openNotification = function(id) {
    window.viewNotification(id);
};

function clearAllNotifications() {
    if (notifications.length === 0) {
        showToast('Aucune notification √† effacer', 'info');
        return;
    }
    
    if (confirm('Voulez-vous vraiment effacer toutes les notifications ?')) {
        const unreadCount = notifications.filter(n => !n.read).length;
        notifications = [];
        updateNotificationCount(-unreadCount);
        saveNotificationsToStorage();
        
        if (document.getElementById('notifications-page').classList.contains('active')) {
            displayNotifications();
        }
        
        showToast('Toutes les notifications ont √©t√© effac√©es', 'success');
    }
}

// Fonction pour afficher des toasts
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `notification-toast ${type}`;
    toast.innerHTML = `
        <div class="notification-header">
            <div class="notification-title">${type === 'success' ? '‚úÖ Succ√®s' : type === 'error' ? '‚ùå Erreur' : type === 'warning' ? '‚ö†Ô∏è Attention' : '‚ÑπÔ∏è Information'}</div>
            <button class="notification-close">&times;</button>
        </div>
        <div class="notification-body">${message}</div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('show');
    }, 100);
    
    // Fermer le toast
    toast.querySelector('.notification-close').addEventListener('click', () => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    });
    
    // Fermer automatiquement apr√®s 5 secondes
    setTimeout(() => {
        if (toast.parentNode) {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }
    }, 5000);
}

// --- Fonction pour g√©n√©rer le matricule parent au format P001, P002, etc. ---
async function generateParentMatricule() {
    try {
        const parentsQuery = query(collection(db, 'parents'));
        const parentsSnap = await getDocs(parentsQuery);
        
        let maxNumber = 0;
        
        parentsSnap.forEach(doc => {
            const matricule = doc.data().matricule;
            if (matricule && matricule.startsWith('P')) {
                const numberPart = matricule.substring(1);
                const number = parseInt(numberPart);
                if (!isNaN(number) && number > maxNumber) {
                    maxNumber = number;
                }
            }
        });
        
        const newNumber = maxNumber + 1;
        return 'P' + newNumber.toString().padStart(3, '0');
        
    } catch (error) {
        console.error("Erreur g√©n√©ration matricule parent:", error);
        return 'P' + Math.floor(Math.random() * 900 + 100).toString();
    }
}

// --- Authentification OBLIGATOIRE ---
onAuthStateChanged(auth, async (user) => {
    if (user) {
        const q = query(collection(db, 'parents'), where('uid', '==', user.uid));
        const snap = await getDocs(q);
        if (!snap.empty) {
            currentParent = { id: snap.docs[0].id, ...snap.docs[0].data() };
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('app-root').classList.remove('hidden');
            document.getElementById('parent-name').textContent = currentParent.fullName;
            
            // Afficher la photo de profil du parent
            const photoContainer = document.getElementById('parent-photo-container');
            if (currentParent.photoURL) {
                photoContainer.innerHTML = `<img src="${currentParent.photoURL}" class="parent-photo" alt="Photo de profil">`;
                document.getElementById('profile-photo-preview').innerHTML = `<img src="${currentParent.photoURL}" class="photo-preview">`;
            } else {
                photoContainer.innerHTML = `<div class="parent-photo-placeholder"><i class="fas fa-user"></i></div>`;
            }
            
            // Charger les notifications du stockage local
            loadNotificationsFromStorage();
            
            await loadParentData();
            // V√©rifier les notifications existantes
            checkExistingNotifications();
            // Configurer les √©couteurs en temps r√©el
            setupRealTimeNotifications();
            
            // Configurer Firebase Messaging si activ√©
            if (currentParent.notificationEnabled) {
                setupFirebaseMessaging();
            }
        } else {
            await signOut(auth);
            showAlert("Acc√®s refus√©.", "error");
        }
    } else {
        // FORCER l'affichage de la connexion
        document.getElementById('login-overlay').classList.remove('hidden');
        document.getElementById('app-root').classList.add('hidden');
    }
});

// --- FONCTIONS POUR LES NOTIFICATIONS ---
function updateNotificationBadge(page, count) {
    const navItem = document.querySelector(`.nav-menu li a[data-page="${page}"]`);
    if (navItem) {
        // Supprimer l'ancien badge s'il existe
        const existingBadge = navItem.querySelector('.notification-badge');
        if (existingBadge) {
            existingBadge.remove();
        }
        
        // Ajouter un nouveau badge si le compte est > 0
        if (count > 0) {
            const badge = document.createElement('span');
            badge.className = 'notification-badge';
            badge.textContent = count > 9 ? '9+' : count.toString();
            navItem.appendChild(badge);
        }
        
        // Mettre √† jour le compteur en m√©moire
        notificationCounts[page] = count;
    }
}

function markNotificationsAsRead(page) {
    updateNotificationBadge(page, 0);
    
    // Sauvegarder l'√©tat dans le localStorage
    const readNotifications = JSON.parse(localStorage.getItem('parent_read_notifications') || '{}');
    readNotifications[page] = new Date().toISOString();
    localStorage.setItem('parent_read_notifications', JSON.stringify(readNotifications));
}

// V√©rifier les notifications existantes
async function checkExistingNotifications() {
    if (!currentParent) return;

    try {
        const readNotifications = JSON.parse(localStorage.getItem('parent_read_notifications') || '{}');
        const now = new Date();
        
        // V√©rifier les notes non lues (Secondaire) - FILTRER PAR LES ENFANTS DU PARENT
        let newGradesCount = 0;
        for (const child of childrenList) {
            if (child.type === 'secondary') {
                const gradesQuery = query(
                    collection(db, 'published_grades'),
                    where('className', '==', child.class)
                );
                const gradesSnap = await getDocs(gradesQuery);
                
                gradesSnap.forEach(doc => {
                    const gradeData = doc.data();
                    const publishedAt = gradeData.publishedAt?.toDate() || new Date(0);
                    const lastReadTime = new Date(readNotifications.grades || 0);
                    
                    // V√©rifier si cette note concerne CET ENFANT sp√©cifique
                    const hasStudentGrade = gradeData.grades?.some(g => 
                        g.studentMatricule === child.matricule
                    );
                    
                    if (hasStudentGrade && publishedAt > lastReadTime) {
                        newGradesCount++;
                        // Cr√©er une notification POUR CET ENFANT
                        notifications.unshift({
                            id: `grade_${doc.id}_${child.matricule}_${Date.now()}`,
                            title: 'Nouvelle note publi√©e',
                            body: `Une nouvelle note a √©t√© publi√©e pour ${child.fullName} en ${gradeData.subject}`,
                            type: 'grades',
                            data: {
                                page: 'grades',
                                childId: child.matricule,
                                childName: child.fullName
                            },
                            timestamp: publishedAt.toISOString(),
                            read: false
                        });
                    }
                });
            }
        }
        
        updateNotificationBadge('grades', newGradesCount);
        
        // V√©rifier les incidents non lus - FILTRER PAR LES ENFANTS DU PARENT
        let newIncidentsCount = 0;
        for (const child of childrenList) {
            // Utiliser les diff√©rents champs possibles pour matcher
            const incidentsQuery = query(
                collection(db, 'incidents'),
                where('studentMatricule', '==', child.matricule)
            );
            
            const incidentsSnap = await getDocs(incidentsQuery);
            
            incidentsSnap.forEach(doc => {
                const incident = doc.data();
                const createdAt = incident.createdAt?.toDate() || new Date(0);
                const lastReadTime = new Date(readNotifications['presence-incidents'] || 0);
                
                if (createdAt > lastReadTime) {
                    newIncidentsCount++;
                    // Cr√©er une notification POUR CET ENFANT
                    notifications.unshift({
                        id: `incident_${doc.id}_${child.matricule}_${Date.now()}`,
                        title: 'Nouvel incident signal√©',
                        body: `Un incident a √©t√© signal√© pour ${child.fullName}: ${incident.type}`,
                        type: 'incidents',
                        data: {
                            page: 'presence-incidents',
                            childId: child.matricule,
                            childName: child.fullName
                        },
                        timestamp: createdAt.toISOString(),
                        read: false
                    });
                }
            });
        }
        
        updateNotificationBadge('presence-incidents', newIncidentsCount);
        
        // V√©rifier les devoirs non lus - FILTRER PAR LES CLASSES DES ENFANTS DU PARENT
        let newHomeworkCount = 0;
        for (const child of childrenList) {
            if (child.type === 'secondary') {
                const homeworkQuery = query(
                    collection(db, 'homework'),
                    where('className', '==', child.class)
                );
                const homeworkSnap = await getDocs(homeworkQuery);
                
                homeworkSnap.forEach(doc => {
                    const homework = doc.data();
                    const createdAt = homework.createdAt?.toDate() || new Date(0);
                    const lastReadTime = new Date(readNotifications.homework || 0);
                    
                    if (createdAt > lastReadTime) {
                        newHomeworkCount++;
                        // Cr√©er une notification POUR CET ENFANT
                        notifications.unshift({
                            id: `homework_${doc.id}_${child.matricule}_${Date.now()}`,
                            title: 'Nouveau devoir assign√©',
                            body: `${child.fullName} a un nouveau devoir en ${homework.subject}: ${homework.title}`,
                            type: 'homework',
                            data: {
                                page: 'homework',
                                childId: child.matricule,
                                childName: child.fullName
                            },
                            timestamp: createdAt.toISOString(),
                            read: false
                        });
                    }
                });
            }
        }
        
        updateNotificationBadge('homework', newHomeworkCount);
        
        // Mettre √† jour le compteur total
        const totalUnread = newGradesCount + newHomeworkCount + newIncidentsCount;
        updateNotificationCount(totalUnread);
        
        // Sauvegarder les notifications
        saveNotificationsToStorage();

    } catch (error) {
        console.error('Erreur v√©rification notifications existantes:', error);
    }
}

// Configurer les √©couteurs en temps r√©el
function setupRealTimeNotifications() {
    if (!currentParent) return;

    try {
        // √âcouter les nouvelles notes publi√©es (Secondaire) - UNIQUEMENT POUR LES ENFANTS DU PARENT
        for (const child of childrenList) {
            if (child.type === 'secondary') {
                const gradesQuery = query(
                    collection(db, 'published_grades'),
                    where('className', '==', child.class)
                );
                
                onSnapshot(gradesQuery, (snapshot) => {
                    const readNotifications = JSON.parse(localStorage.getItem('parent_read_notifications') || '{}');
                    const lastReadTime = new Date(readNotifications.grades || 0);
                    
                    let newGradesCount = 0;
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const gradeData = change.doc.data();
                            const publishedAt = gradeData.publishedAt?.toDate() || new Date();
                            
                            // V√©rifier si cette note concerne CET ENFANT
                            const hasStudentGrade = gradeData.grades?.some(g => 
                                g.studentMatricule === child.matricule
                            );
                            
                            if (hasStudentGrade && publishedAt > lastReadTime) {
                                newGradesCount++;
                                
                                // Cr√©er une notification UNIQUEMENT POUR CET ENFANT
                                const notification = {
                                    id: `realtime_grade_${change.doc.id}_${child.matricule}_${Date.now()}`,
                                    title: 'üìä Nouvelle note publi√©e',
                                    body: `${child.fullName} a re√ßu une nouvelle note en ${gradeData.subject}: ${gradeData.gradeType}`,
                                    type: 'grades',
                                    data: {
                                        page: 'grades',
                                        childId: child.matricule,
                                        childName: child.fullName,
                                        gradeId: change.doc.id
                                    },
                                    timestamp: publishedAt.toISOString(),
                                    read: false
                                };
                                
                                notifications.unshift(notification);
                                updateNotificationCount(1);
                                showNotificationToast(notification);
                                saveNotificationsToStorage();
                            }
                        }
                    });
                    
                    if (newGradesCount > 0) {
                        updateNotificationBadge('grades', notificationCounts.grades + newGradesCount);
                    }
                });
            }
        }

        // √âcouter les nouveaux incidents - UNIQUEMENT POUR LES ENFANTS DU PARENT
        for (const child of childrenList) {
            const incidentsQuery = query(
                collection(db, 'incidents'),
                where('studentMatricule', '==', child.matricule)
            );
            
            onSnapshot(incidentsQuery, (snapshot) => {
                const readNotifications = JSON.parse(localStorage.getItem('parent_read_notifications') || '{}');
                const lastReadTime = new Date(readNotifications['presence-incidents'] || 0);
                
                let newIncidentsCount = 0;
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const incident = change.doc.data();
                        const createdAt = incident.createdAt?.toDate() || new Date();
                        
                        if (createdAt > lastReadTime) {
                            newIncidentsCount++;
                            
                            // Cr√©er une notification UNIQUEMENT POUR CET ENFANT
                            const notification = {
                                id: `realtime_incident_${change.doc.id}_${child.matricule}_${Date.now()}`,
                                title: '‚ö†Ô∏è Nouvel incident signal√©',
                                body: `Un incident a √©t√© signal√© pour ${child.fullName}: ${incident.type}`,
                                type: 'incidents',
                                data: {
                                    page: 'presence-incidents',
                                    childId: child.matricule,
                                    childName: child.fullName,
                                    incidentId: change.doc.id
                                },
                                timestamp: createdAt.toISOString(),
                                read: false
                            };
                            
                            notifications.unshift(notification);
                            updateNotificationCount(1);
                            showNotificationToast(notification);
                            saveNotificationsToStorage();
                        }
                    }
                });
                
                if (newIncidentsCount > 0) {
                    updateNotificationBadge('presence-incidents', notificationCounts['presence-incidents'] + newIncidentsCount);
                }
            });
        }

        // √âcouter les nouveaux devoirs - UNIQUEMENT POUR LES ENFANTS DU PARENT
        for (const child of childrenList) {
            if (child.type === 'secondary') {
                const homeworkQuery = query(
                    collection(db, 'homework'),
                    where('className', '==', child.class)
                );
                
                onSnapshot(homeworkQuery, (snapshot) => {
                    const readNotifications = JSON.parse(localStorage.getItem('parent_read_notifications') || '{}');
                    const lastReadTime = new Date(readNotifications.homework || 0);
                    
                    let newHomeworkCount = 0;
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const homework = change.doc.data();
                            const createdAt = homework.createdAt?.toDate() || new Date();
                            
                            if (createdAt > lastReadTime) {
                                newHomeworkCount++;
                                
                                // Cr√©er une notification UNIQUEMENT POUR CET ENFANT
                                const notification = {
                                    id: `realtime_homework_${change.doc.id}_${child.matricule}_${Date.now()}`,
                                    title: 'üìö Nouveau devoir assign√©',
                                    body: `${child.fullName} a un nouveau devoir en ${homework.subject}: ${homework.title}`,
                                    type: 'homework',
                                    data: {
                                        page: 'homework',
                                        childId: child.matricule,
                                        childName: child.fullName,
                                        homeworkId: change.doc.id
                                    },
                                    timestamp: createdAt.toISOString(),
                                    read: false
                                };
                                
                                notifications.unshift(notification);
                                updateNotificationCount(1);
                                showNotificationToast(notification);
                                saveNotificationsToStorage();
                            }
                        }
                    });
                    
                    if (newHomeworkCount > 0) {
                        updateNotificationBadge('homework', notificationCounts.homework + newHomeworkCount);
                    }
                });
            }
        }

        // √âcouter les nouvelles cotes primaires - UNIQUEMENT POUR LES ENFANTS DU PARENT
        for (const child of childrenList) {
            if (child.type === 'primary') {
                const primaryGradesQuery = query(
                    collection(db, 'primary_published_grades'),
                    where('studentId', '==', child.matricule)
                );
                
                onSnapshot(primaryGradesQuery, (snapshot) => {
                    const readNotifications = JSON.parse(localStorage.getItem('parent_read_notifications') || '{}');
                    const lastReadTime = new Date(readNotifications['grades'] || 0);
                    
                    let newPrimaryGradesCount = 0;
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const gradeData = change.doc.data();
                            const publishedAt = gradeData.publishedAt?.toDate() || new Date();
                            
                            if (publishedAt > lastReadTime) {
                                newPrimaryGradesCount++;
                                
                                // Cr√©er une notification UNIQUEMENT POUR CET ENFANT
                                const notification = {
                                    id: `realtime_primary_grade_${change.doc.id}_${child.matricule}_${Date.now()}`,
                                    title: 'üìà Nouvelle cote primaire',
                                    body: `Une nouvelle cote a √©t√© publi√©e pour ${child.fullName} (Primaire)`,
                                    type: 'grades',
                                    data: {
                                        page: 'grades',
                                        childId: child.matricule,
                                        childName: child.fullName,
                                        gradeId: change.doc.id
                                    },
                                    timestamp: publishedAt.toISOString(),
                                    read: false
                                };
                                
                                notifications.unshift(notification);
                                updateNotificationCount(1);
                                showNotificationToast(notification);
                                saveNotificationsToStorage();
                            }
                        }
                    });
                    
                    if (newPrimaryGradesCount > 0) {
                        updateNotificationBadge('grades', notificationCounts['grades'] + newPrimaryGradesCount);
                    }
                });
            }
        }

    } catch (error) {
        console.error('Erreur notifications temps r√©el:', error);
    }
}

// --- Fonctions utilitaires ---
function showAlert(message, type = 'info') {
    const alertBox = document.getElementById('global-alert');
    alertBox.textContent = message;
    alertBox.className = `alert alert-${type}`;
    alertBox.classList.remove('hidden');
    setTimeout(() => alertBox.classList.add('hidden'), 6000);
}

// Code de paiement simplifi√©
function generatePaymentCode() {
    return 'PAY' + Math.random().toString(36).substring(2, 6).toUpperCase();
}

// --- Gestion du menu mobile ---
document.getElementById('menu-toggle').addEventListener('click', () => {
    document.querySelector('.sidebar').classList.toggle('collapsed');
});

// Fermer le menu en cliquant √† l'ext√©rieur (mobile)
document.addEventListener('click', (e) => {
    const sidebar = document.querySelector('.sidebar');
    const menuToggle = document.getElementById('menu-toggle');
    
    if (!sidebar.contains(e.target) && !menuToggle.contains(e.target) && window.innerWidth <= 768) {
        sidebar.classList.add('collapsed');
    }
});

// --- Gestion des photos de profil ---
document.getElementById('profile-photo').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        if (file.size > 5 * 1024 * 1024) {
            showAlert("La photo ne doit pas d√©passer 5MB", "error");
            return;
        }
        if (!file.type.startsWith('image/')) {
            showAlert("Veuillez s√©lectionner une image valide", "error");
            return;
        }
        parentPhotoFile = file;
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('profile-photo-preview').innerHTML = `<img src="${e.target.result}" class="photo-preview">`;
        }
        reader.readAsDataURL(file);
    }
});

// --- Bouton notification dans le header ---
document.getElementById('notification-bell').addEventListener('click', () => {
    const link = document.querySelector('.nav-menu a[data-page="notifications"]');
    if (link) link.click();
});

// --- Activation de compte ---
document.getElementById('show-activation-link').addEventListener('click', (e) => {
    e.preventDefault();
    document.getElementById('login-form').closest('.login-card').classList.add('hidden');
    document.getElementById('activation-card').classList.remove('hidden');
});

document.getElementById('show-login-link').addEventListener('click', (e) => {
    e.preventDefault();
    document.getElementById('activation-card').classList.add('hidden');
    document.getElementById('login-form').closest('.login-card').classList.remove('hidden');
    resetActivationForm();
});

document.getElementById('back-to-step1').addEventListener('click', (e) => {
    e.preventDefault();
    goToActivationStep(1);
});

document.getElementById('go-to-login-btn').addEventListener('click', () => {
    document.getElementById('activation-card').classList.add('hidden');
    document.getElementById('login-form').closest('.login-card').classList.remove('hidden');
    resetActivationForm();
});

let verifiedChildren = [];

// √âtape 1: V√©rification du premier matricule
document.getElementById('activation-form-step1').addEventListener('submit', async (e) => {
    e.preventDefault();
    const childMatricule = document.getElementById('child-matricule').value;
    
    if (!childMatricule) {
        showAlert("Veuillez entrer un matricule d'√©l√®ve", "error");
        return;
    }
    
    try {
        // Recherche dans les trois collections d'√©l√®ves
        let studentData = null;
        let studentType = null;
        
        // 1. Recherche dans les √©l√®ves secondaires
        let studentDoc = await getDoc(doc(db, 'students', childMatricule));
        if (studentDoc.exists()) {
            studentData = studentDoc.data();
            studentType = 'secondary';
        } else {
            // 2. Recherche dans les √©l√®ves primaires
            studentDoc = await getDoc(doc(db, 'primary_students', childMatricule));
            if (studentDoc.exists()) {
                studentData = studentDoc.data();
                studentType = 'primary';
            } else {
                // 3. Recherche dans les √©l√®ves maternelles - CORRECTION ICI
                studentDoc = await getDoc(doc(db, 'kindergarten_students', childMatricule));
                if (studentDoc.exists()) {
                    studentData = studentDoc.data();
                    studentType = 'kindergarten';
                }
            }
        }
        
        if (!studentData) {
            showAlert("Aucun √©l√®ve trouv√© avec ce matricule", "error");
            return;
        }
        
        if (studentData.parentId) {
            showAlert("Cet √©l√®ve est d√©j√† associ√© √† un compte parent", "error");
            return;
        }
        
        verifiedChildren = [{
            matricule: childMatricule,
            name: studentData.fullName,
            class: studentData.class,
            type: studentType
        }];
        
        document.getElementById('child-name').textContent = studentData.fullName;
        document.getElementById('child-class').textContent = studentData.class;
        updateChildrenList();
        goToActivationStep(2);
        
    } catch (error) {
        console.error("Erreur v√©rification matricule:", error);
        showAlert("Erreur lors de la v√©rification du matricule: " + error.message, "error");
    }
});

// Ajouter un autre enfant
document.getElementById('add-child-btn').addEventListener('click', async () => {
    const matricule = document.getElementById('additional-matricule').value;
    
    if (!matricule) {
        showAlert("Veuillez entrer un matricule", "error");
        return;
    }
    
    try {
        // Recherche dans les trois collections d'√©l√®ves
        let studentData = null;
        let studentType = null;
        
        // 1. Recherche dans les √©l√®ves secondaires
        let studentDoc = await getDoc(doc(db, 'students', matricule));
        if (studentDoc.exists()) {
            studentData = studentDoc.data();
            studentType = 'secondary';
        } else {
            // 2. Recherche dans les √©l√®ves primaires
            studentDoc = await getDoc(doc(db, 'primary_students', matricule));
            if (studentDoc.exists()) {
                studentData = studentDoc.data();
                studentType = 'primary';
            } else {
                // 3. Recherche dans les √©l√®ves maternelles - CORRECTION ICI
                studentDoc = await getDoc(doc(db, 'kindergarten_students', matricule));
                if (studentDoc.exists()) {
                    studentData = studentDoc.data();
                    studentType = 'kindergarten';
                }
            }
        }
        
        if (!studentData) {
            showAlert("Aucun √©l√®ve trouv√© avec ce matricule", "error");
            return;
        }
        
        if (studentData.parentId) {
            showAlert("Cet √©l√®ve est d√©j√† associ√© √† un compte parent", "error");
            return;
        }
        
        if (verifiedChildren.find(child => child.matricule === matricule)) {
            showAlert("Cet √©l√®ve est d√©j√† dans la liste", "error");
            return;
        }
        
        verifiedChildren.push({
            matricule: matricule,
            name: studentData.fullName,
            class: studentData.class,
            type: studentType
        });
        
        updateChildrenList();
        document.getElementById('additional-matricule').value = '';
        showAlert("Enfant ajout√© avec succ√®s", "success");
        
    } catch (error) {
        console.error("Erreur ajout enfant:", error);
        showAlert("Erreur lors de l'ajout de l'enfant: " + error.message, "error");
    }
});

// Cr√©ation du compte parent
document.getElementById('create-account-btn').addEventListener('click', async () => {
    const fullName = document.getElementById('parent-fullname').value;
    const email = document.getElementById('parent-email').value;
    const phone = document.getElementById('parent-phone').value;
    const password = document.getElementById('parent-password').value;
    const confirmPassword = document.getElementById('parent-password-confirm').value;
    
    if (!fullName || !email || !phone || !password) {
        showAlert("Veuillez remplir tous les champs obligatoires", "error");
        return;
    }
    
    if (password !== confirmPassword) {
        showAlert("Les mots de passe ne correspondent pas", "error");
        return;
    }
    
    if (password.length < 6) {
        showAlert("Le mot de passe doit contenir au moins 6 caract√®res", "error");
        return;
    }
    
    if (verifiedChildren.length === 0) {
        showAlert("Veuillez ajouter au moins un enfant", "error");
        return;
    }
    
    try {
        const parentMatricule = await generateParentMatricule();
        const parentEmail = `parent.${parentMatricule}@cs-lacolombe.edu`;
        const userCredential = await createUserWithEmailAndPassword(auth, parentEmail, password);
        const user = userCredential.user;
        
        const parentData = {
            matricule: parentMatricule,
            fullName: fullName,
            email: email,
            phone: phone,
            authEmail: parentEmail,
            uid: user.uid,
            children: verifiedChildren.map(child => ({
                matricule: child.matricule,
                type: child.type
            })),
            notificationEnabled: false,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
        };
        
        const parentRef = doc(db, 'parents', parentMatricule);
        await setDoc(parentRef, parentData);
        
        for (const child of verifiedChildren) {
            let studentRef;
            if (child.type === 'secondary') {
                studentRef = doc(db, 'students', child.matricule);
            } else if (child.type === 'primary') {
                studentRef = doc(db, 'primary_students', child.matricule);
            } else {
                // CORRECTION ICI : collection kindergarten_students
                studentRef = doc(db, 'kindergarten_students', child.matricule);
            }
            
            await updateDoc(studentRef, {
                parentId: parentMatricule,
                parentName: fullName,
                parentEmail: email,
                parentPhone: phone,
                updatedAt: serverTimestamp()
            });
        }
        
        document.getElementById('created-parent-matricule').textContent = parentMatricule;
        document.getElementById('created-parent-name').textContent = fullName;
        document.getElementById('created-parent-email').textContent = email;
        document.getElementById('created-children-count').textContent = verifiedChildren.length;
        goToActivationStep(3);
        
    } catch (error) {
        console.error("Erreur cr√©ation compte:", error);
        showAlert("Erreur lors de la cr√©ation du compte: " + error.message, "error");
    }
});

// Connexion avec matricule parent
document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const matricule = document.getElementById('login-matricule').value;
    const password = document.getElementById('login-password').value;
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Connexion...';
    submitBtn.disabled = true;

    try {
        const parentDoc = await getDoc(doc(db, 'parents', matricule));
        if (!parentDoc.exists()) {
            showAlert("Matricule parent incorrect", "error");
            return;
        }
        
        const parentData = parentDoc.data();
        const authEmail = parentData.authEmail;
        
        await signInWithEmailAndPassword(auth, authEmail, password);
        
    } catch (error) {
        console.error("Erreur connexion:", error);
        showAlert("Matricule ou mot de passe incorrect", "error");
    } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    }
});

document.getElementById('logout-btn').addEventListener('click', () => {
    signOut(auth);
    showAlert("D√©connexion r√©ussie", "success");
});

// --- Fonctions pour l'activation de compte ---
function goToActivationStep(step) {
    document.querySelectorAll('.step').forEach((el, index) => {
        if (index + 1 < step) {
            el.classList.add('completed');
            el.classList.remove('active');
        } else if (index + 1 === step) {
            el.classList.add('active');
            el.classList.remove('completed');
        } else {
            el.classList.remove('active', 'completed');
        }
    });
    
    document.getElementById('activation-step-1').classList.toggle('hidden', step !== 1);
    document.getElementById('activation-step-2').classList.toggle('hidden', step !== 2);
    document.getElementById('activation-step-3').classList.toggle('hidden', step !== 3);
}

function resetActivationForm() {
    document.getElementById('activation-form-step1').reset();
    document.getElementById('activation-step-2').classList.add('hidden');
    document.getElementById('activation-step-3').classList.add('hidden');
    document.getElementById('additional-matricule').value = '';
    verifiedChildren = [];
    updateChildrenList();
    goToActivationStep(1);
}

function updateChildrenList() {
    const container = document.getElementById('children-container');
    container.innerHTML = '';
    
    if (verifiedChildren.length === 0) {
        container.innerHTML = '<p>Aucun enfant ajout√©</p>';
        return;
    }
    
    verifiedChildren.forEach((child, index) => {
        const childElement = document.createElement('div');
        childElement.className = 'child-item';
        childElement.innerHTML = `
            <div class="child-header">
                <strong>${child.name}</strong>
                <div class="child-actions">
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeChild(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div>Matricule: ${child.matricule}</div>
            <div>Classe: ${child.class}</div>
            <div>Type: ${child.type === 'secondary' ? 'Secondaire' : child.type === 'primary' ? 'Primaire' : 'Maternelle'}</div>
        `;
        container.appendChild(childElement);
    });
}

window.removeChild = (index) => {
    verifiedChildren.splice(index, 1);
    updateChildrenList();
};

// --- Chargement des donn√©es parent ---
async function loadParentData() {
    const childSelectors = [
        document.getElementById('child-selector'), 
        document.getElementById('presence-child-selector'),
        document.getElementById('payment-child-selector'),
        document.getElementById('timetable-child-selector')
    ];
    
    // Initialiser les s√©lecteurs sp√©cifiques aux niveaux
    const secondarySelectors = [
        document.getElementById('secondary-grades-child-selector'),
        document.getElementById('secondary-homework-child-selector')
    ];
    
    const primarySelectors = [
        document.getElementById('primary-grades-child-selector'),
        document.getElementById('primary-homework-child-selector')
    ];
    
    const kindergartenSelectors = [
        document.getElementById('kindergarten-grades-child-selector'),
        document.getElementById('kindergarten-homework-child-selector')
    ];
    
    // Initialiser tous les s√©lecteurs
    childSelectors.forEach(s => s.innerHTML = '<option value="">-- S√©lectionner un enfant --</option>');
    secondarySelectors.forEach(s => s.innerHTML = '<option value="">-- S√©lectionner un enfant du secondaire --</option>');
    primarySelectors.forEach(s => s.innerHTML = '<option value="">-- S√©lectionner un enfant du primaire --</option>');
    kindergartenSelectors.forEach(s => s.innerHTML = '<option value="">-- S√©lectionner un enfant de la maternelle --</option>');

    if (currentParent && currentParent.children) {
        childrenList = [];
        
        for (const childData of currentParent.children) {
            const childMatricule = childData.matricule || childData;
            const childType = childData.type || 'secondary';
            
            let childDoc;
            if (childType === 'secondary') {
                childDoc = await getDoc(doc(db, 'students', childMatricule));
            } else if (childType === 'primary') {
                childDoc = await getDoc(doc(db, 'primary_students', childMatricule));
            } else {
                // CORRECTION ICI : collection kindergarten_students
                childDoc = await getDoc(doc(db, 'kindergarten_students', childMatricule));
            }
            
            if (childDoc.exists()) {
                const childInfo = childDoc.data();
                const childObj = {
                    matricule: childMatricule,
                    type: childType,
                    ...childInfo
                };
                childrenList.push(childObj);
                
                const displayText = `${childInfo.fullName} - ${childInfo.class} (${childType === 'secondary' ? 'Secondaire' : childType === 'primary' ? 'Primaire' : 'Maternelle'})`;
                
                // Ajouter √† tous les s√©lecteurs g√©n√©raux
                childSelectors.forEach(s => s.innerHTML += `<option value="${childMatricule}">${displayText}</option>`);
                
                // Ajouter aux s√©lecteurs sp√©cifiques selon le type
                if (childType === 'secondary') {
                    secondarySelectors.forEach(s => s.innerHTML += `<option value="${childMatricule}">${childInfo.fullName} - ${childInfo.class}</option>`);
                } else if (childType === 'primary') {
                    primarySelectors.forEach(s => s.innerHTML += `<option value="${childMatricule}">${childInfo.fullName} - ${childInfo.class}</option>`);
                } else {
                    kindergartenSelectors.forEach(s => s.innerHTML += `<option value="${childMatricule}">${childInfo.fullName} - ${childInfo.class}</option>`);
                }
            }
        }
        
        updateChildrenPage();
        updateProfileForm();
        loadYearSelectors();
        
        // Initialiser les onglets devoirs
        setupHomeworkTabs();
        
        // Initialiser la gestion des p√©riodes pour les cotes primaires
        setupPrimaryPeriods();

// Initialiser le syst√®me de cotes secondaires
setupSecondaryGradesPeriods();
        
        // Initialiser les sous-onglets
        setupSubTabs();
    }
}

function updateChildrenPage() {
    const container = document.getElementById('children-list-container');
    container.innerHTML = '';
    
    if (childrenList.length === 0) {
        container.innerHTML = '<p>Aucun enfant associ√© √† votre compte</p>';
        return;
    }
    
    childrenList.forEach(child => {
        const childElement = document.createElement('div');
        childElement.className = 'child-item';
        childElement.innerHTML = `
            <div class="child-header">
                <strong>${child.fullName}</strong>
            </div>
            <div>Matricule: ${child.matricule}</div>
            <div>Classe: ${child.class}</div>
            <div>Type: ${child.type === 'secondary' ? 'Secondaire' : child.type === 'primary' ? 'Primaire' : 'Maternelle'}</div>
            <div>Date de naissance: ${child.birthdate || 'Non sp√©cifi√©e'}</div>
        `;
        container.appendChild(childElement);
    });
}

function updateProfileForm() {
    if (currentParent) {
        document.getElementById('profile-matricule').value = currentParent.matricule;
        document.getElementById('profile-fullname').value = currentParent.fullName;
        document.getElementById('profile-email').value = currentParent.email;
        document.getElementById('profile-phone').value = currentParent.phone;
        
        // Mettre √† jour le statut des notifications
        const statusElement = document.getElementById('notification-status');
        if (currentParent.notificationEnabled) {
            statusElement.textContent = '‚úÖ Notifications activ√©es';
            statusElement.style.color = 'var(--success)';
        } else {
            statusElement.textContent = '‚ùå Notifications d√©sactiv√©es';
            statusElement.style.color = 'var(--danger)';
        }
    }
}

// --- Gestion des boutons de notification dans le profil ---
document.getElementById('enable-notifications-btn').addEventListener('click', async () => {
    const granted = await requestNotificationPermission();
    if (granted) {
        // Mettre √† jour le statut dans Firestore
        await updateDoc(doc(db, 'parents', currentParent.matricule), {
            notificationEnabled: true,
            notificationEnabledAt: serverTimestamp()
        });
        
        currentParent.notificationEnabled = true;
        updateProfileForm();
    }
});

document.getElementById('test-notification-btn').addEventListener('click', sendTestNotification);

// --- Chargement des s√©lecteurs d'ann√©e ---
function loadYearSelectors() {
    const currentYear = new Date().getFullYear();
    const yearSelectors = document.querySelectorAll('#presence-year');
    
    yearSelectors.forEach(select => {
        select.innerHTML = '';
        for (let year = currentYear - 1; year <= currentYear + 1; year++) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            if (year === currentYear) option.selected = true;
            select.appendChild(option);
        }
    });
    
    const currentMonth = new Date().getMonth();
    document.getElementById('presence-month').value = currentMonth;
    
    // Initialiser le mois pour l'horaire
    const today = new Date();
    const year = today.getFullYear();
    const month = (today.getMonth() + 1).toString().padStart(2, '0');
    const monthString = `${year}-${month}`;
    document.getElementById('timetable-month').value = monthString;
}

// --- Tableau de bord ---
document.getElementById('child-selector').addEventListener('change', (e) => {
    const studentId = e.target.value;
    const dashboardContent = document.getElementById('child-dashboard-content');
    if (!studentId) {
        dashboardContent.classList.add('hidden');
        return;
    }
    dashboardContent.classList.remove('hidden');
    loadChildDashboard(studentId);
});

// --- Page: Cotes et Notes - Gestion des sous-onglets ---
function setupSubTabs() {
    // Gestion des sous-onglets pour les cotes
    document.querySelectorAll('#grades-page .sub-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const subTabId = tab.getAttribute('data-sub-tab');
            
            // D√©sactiver tous les sous-onglets
            document.querySelectorAll('#grades-page .sub-tab, #grades-page .sub-tab-content').forEach(el => el.classList.remove('active'));
            
            // Activer le sous-onglet s√©lectionn√©
            tab.classList.add('active');
            document.getElementById(`${subTabId}-tab`).classList.add('active');
            
            // R√©initialiser les s√©lecteurs d'enfant
            document.getElementById('secondary-grades-child-selector').value = '';
            document.getElementById('secondary-grades-content').classList.add('hidden');
            document.getElementById('primary-grades-child-selector').value = '';
            document.getElementById('primary-grades-content').classList.add('hidden');
            document.getElementById('kindergarten-grades-child-selector').value = '';
            document.getElementById('kindergarten-grades-content').classList.add('hidden');
        });
    });
    
    // Gestion des sous-onglets pour les devoirs
    document.querySelectorAll('#homework-page .sub-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const subTabId = tab.getAttribute('data-sub-tab');
            
            // D√©sactiver tous les sous-onglets
            document.querySelectorAll('#homework-page .sub-tab, #homework-page .sub-tab-content').forEach(el => el.classList.remove('active'));
            
            // Activer le sous-onglet s√©lectionn√©
            tab.classList.add('active');
            document.getElementById(`${subTabId}-tab`).classList.add('active');
            
            // R√©initialiser les s√©lecteurs d'enfant
            document.getElementById('secondary-homework-child-selector').value = '';
            document.getElementById('secondary-homework-content').classList.add('hidden');
            document.getElementById('primary-homework-child-selector').value = '';
            document.getElementById('primary-homework-content').classList.add('hidden');
            document.getElementById('kindergarten-homework-child-selector').value = '';
            document.getElementById('kindergarten-homework-content').classList.add('hidden');
        });
    });
}

// --- Sous-onglet: Notes Secondaire ---
document.getElementById('secondary-grades-child-selector').addEventListener('change', (e) => {
    const studentId = e.target.value;
    const gradesContent = document.getElementById('secondary-grades-content');
    if (!studentId) {
        gradesContent.classList.add('hidden');
        return;
    }
    gradesContent.classList.remove('hidden');
    loadSecondaryGrades(studentId);
});

async function loadSecondaryGrades(studentId) {
    showLoading('secondary-grades-loading');
    const tableBody = document.getElementById('secondary-grades-table-body');
    
    try {
        // R√©cup√©rer toutes les notes publi√©es dans published_grades
        const gradesQuery = query(
            collection(db, 'published_grades'),
            orderBy('publishedAt', 'desc')
        );
        const gradesSnap = await getDocs(gradesQuery);
        
        if (gradesSnap.empty) {
            tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Aucune note disponible pour le moment.</td></tr>';
            hideLoading('secondary-grades-loading');
            return;
        }
        
        let allGrades = [];
        
        gradesSnap.forEach(doc => {
            const gradeData = doc.data();
            
            // V√©rifier si cette √©valuation concerne la classe de l'enfant
            // Trouver la note sp√©cifique de cet enfant
            const studentGrade = gradeData.grades?.find(g => g.studentMatricule === studentId);
            
            if (studentGrade) {
                const percentage = (studentGrade.grade / gradeData.maxPoints) * 100;
                allGrades.push({
                    subject: gradeData.subject,
                    gradeType: gradeData.gradeType,
                    maxPoints: gradeData.maxPoints,
                    grade: studentGrade.grade,
                    percentage: percentage,
                    teacherName: gradeData.teacherName,
                    evaluationDate: gradeData.evaluationDate,
                    publishedAt: gradeData.publishedAt
                });
            }
        });
        
        if (allGrades.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Aucune note trouv√©e pour cet enfant.</td></tr>';
            hideLoading('secondary-grades-loading');
            return;
        }
        
        // Trier les notes par date (plus r√©centes d'abord)
        allGrades.sort((a, b) => {
            const dateA = a.publishedAt ? a.publishedAt.toDate() : new Date(0);
            const dateB = b.publishedAt ? b.publishedAt.toDate() : new Date(0);
            return dateB - dateA;
        });
        
        // Afficher les notes dans le tableau
        let html = '';
        allGrades.forEach((grade, index) => {
            const isGoodGrade = grade.grade >= (grade.maxPoints / 2);
            const gradeClass = isGoodGrade ? 'grade-green' : 'grade-red';
            const evaluationDate = grade.evaluationDate ? 
                grade.evaluationDate.toDate().toLocaleDateString('fr-FR') : 
                'Non sp√©cifi√©e';
            
            html += `
                <tr>
                    <td>${index + 1}</td>
                    <td><strong>${grade.subject}</strong></td>
                    <td>${grade.gradeType}</td>
                    <td>${grade.maxPoints}</td>
                    <td class="${gradeClass}"><strong>${grade.grade}</strong></td>
                    <td>${grade.percentage.toFixed(1)}%</td>
                    <td>${grade.teacherName}</td>
                    <td>${evaluationDate}</td>
                </tr>
            `;
        });
        
        tableBody.innerHTML = html;
        hideLoading('secondary-grades-loading');
        
        // Marquer les notifications comme lues
        markNotificationsAsRead('grades');
        
    } catch (error) {
        console.error('Erreur chargement notes secondaire:', error);
        tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Erreur de chargement des notes.</td></tr>';
        hideLoading('secondary-grades-loading');
    }
}

// --- Sous-onglet: Cotes Primaire ---
document.getElementById('primary-grades-child-selector').addEventListener('change', (e) => {
    const studentId = e.target.value;
    const gradesContent = document.getElementById('primary-grades-content');
    if (!studentId) {
        gradesContent.classList.add('hidden');
        return;
    }
    gradesContent.classList.remove('hidden');
    loadPrimaryGrades(studentId, currentPrimaryPeriod);
});

function setupPrimaryPeriods() {
    document.querySelectorAll('.period-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            currentPrimaryPeriod = this.getAttribute('data-period');
            
            const studentId = document.getElementById('primary-grades-child-selector').value;
            if (studentId) {
                loadPrimaryGrades(studentId, currentPrimaryPeriod);
            }
        });
    });
}
// === NOUVELLE GESTION DES COTES SECONDARIES (SYST√àME PAR P√âRIODE) ===

// Variables pour le syst√®me de cotes
let currentChildGrades = null;
let currentGradesPeriod = 'P1';
let childGradesData = {};

// Initialiser les p√©riodes pour les cotes secondaires
function setupSecondaryGradesPeriods() {
    document.querySelectorAll('#secondary-grades-content .period-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('#secondary-grades-content .period-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            currentGradesPeriod = this.getAttribute('data-period');
            
            const studentId = document.getElementById('secondary-grades-child-selector').value;
            if (studentId) {
                loadChildProclamationData(studentId, currentGradesPeriod);
            }
        });
    });
}

async function loadChildProclamationData(studentId, period) {
    showLoading('secondary-grades-loading');
    const tableContainer = document.getElementById('grades-table-container');
    const noGradesMessage = document.getElementById('no-grades-message');
    const periodInfoCard = document.getElementById('period-info-card');
    const selectedPeriodName = document.getElementById('selected-period-name');
    const periodCalculationInfo = document.getElementById('period-calculation-info');
    
    tableContainer.classList.add('hidden');
    noGradesMessage.classList.add('hidden');
    periodInfoCard.classList.add('hidden');
    
    try {
        const child = childrenList.find(c => c.matricule === studentId);
        if (!child || child.type !== 'secondary') {
            throw new Error('Enfant non trouv√© ou non du secondaire');
        }
        
        // Afficher les informations sur la p√©riode
        periodInfoCard.classList.remove('hidden');
        selectedPeriodName.textContent = getPeriodNameForParent(period);
        periodCalculationInfo.textContent = getPeriodCalculationInfoForParent(period);
        
        // V√©rifier si c'est un total √† calculer automatiquement
        if (period === 'TOTAL_S1' || period === 'TOTAL_S2' || period === 'TOTAL_GENERAL') {
            // Calcul automatique des totaux
            const calculatedData = await calculateAutomaticTotals(studentId, period);

          // Dans la section o√π vous v√©rifiez les totaux √† calculer
if (period === 'TOTAL_S1' || period === 'TOTAL_S2' || period === 'TOTAL_GENERAL') {
    document.getElementById('period-auto-calc-info').classList.remove('hidden');
} else {
    document.getElementById('period-auto-calc-info').classList.add('hidden');
}
            
            if (!calculatedData || Object.keys(calculatedData.coursesData).length === 0) {
                hideLoading('secondary-grades-loading');
                noGradesMessage.classList.remove('hidden');
                return;
            }
            
            // Stocker les donn√©es pour l'export
            childGradesData = calculatedData;
            
            // Afficher le tableau avec les totaux calcul√©s
            displayChildProclamationTableWithTotals(child, calculatedData, period);
            
            hideLoading('secondary-grades-loading');
            tableContainer.classList.remove('hidden');
            document.getElementById('child-name-header').textContent = child.fullName;
            
            return;
        }
        
        // Pour les p√©riodes normales, r√©cup√©rer les cotes publi√©es
        const gradesQuery = query(
            collection(db, 'parent_grades'),
            where('className', '==', child.class),
            where('period', '==', period)
        );
        
        const gradesSnap = await getDocs(gradesQuery);
        
        if (gradesSnap.empty) {
            hideLoading('secondary-grades-loading');
            noGradesMessage.classList.remove('hidden');
            return;
        }
        
        // Organiser les donn√©es par cours
        const coursesData = {};
        let childFound = false;
        
        gradesSnap.forEach(doc => {
            const gradeData = doc.data();
            const courseName = gradeData.subject;
            
            const studentGrade = gradeData.grades.find(g => g.studentMatricule === studentId);
            
            if (studentGrade) {
                childFound = true;
                
                if (!coursesData[courseName]) {
                    coursesData[courseName] = {
                        teacherName: gradeData.teacherName,
                        maxPoints: gradeData.maxPoints,
                        evaluationDate: gradeData.evaluationDate,
                        grades: {}
                    };
                }
                
                const cm = gradeData.maxPoints;
                const co = studentGrade.grade;
                
                coursesData[courseName].grades[studentId] = {
                    studentName: studentGrade.studentName,
                    cm: cm,
                    co: co,
                    remark: studentGrade.remark || ''
                };
            }
        });
        
        if (!childFound) {
            hideLoading('secondary-grades-loading');
            noGradesMessage.classList.remove('hidden');
            return;
        }
        
        // Stocker les donn√©es pour l'export
        childGradesData = {
            childName: child.fullName,
            className: child.class,
            period: period,
            coursesData: coursesData
        };
        
        // Afficher le tableau
        displayChildProclamationTable(child, coursesData, period);
        
        hideLoading('secondary-grades-loading');
        tableContainer.classList.remove('hidden');
        document.getElementById('child-name-header').textContent = child.fullName;
        
    } catch (error) {
        console.error('Erreur chargement proclamation enfant:', error);
        hideLoading('secondary-grades-loading');
        
        const container = document.getElementById('grades-proclamation-table-container');
        container.innerHTML = `
            <div class="no-data">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Erreur de chargement</h3>
                <p>${error.message}</p>
            </div>
        `;
        tableContainer.classList.remove('hidden');
    }
}

// Afficher le tableau avec les totaux calcul√©s automatiquement
function displayChildProclamationTableWithTotals(child, calculatedData, period) {
    const container = document.getElementById('grades-proclamation-table-container');
    const courseNames = Object.keys(calculatedData.coursesData);
    
    if (courseNames.length === 0) {
        container.innerHTML = '<p>Aucune donn√©e disponible pour cette p√©riode.</p>';
        return;
    }
    
    // Cr√©er le tableau avec les d√©tails du calcul
    let html = `
        <div class="grades-summary">
            <div class="summary-card">
                <h5>Cours √âvalu√©s</h5>
                <div class="value">${courseNames.length}</div>
            </div>
    `;
    
    // Informations sp√©cifiques selon la p√©riode
    if (period === 'TOTAL_S1') {
        html += `
            <div class="summary-card">
                <h5>Total Semestre 1</h5>
                <div class="value">${calculatedData.calculatedTotals.average.toFixed(2)}</div>
                <div class="sub-value">P1 + P2 + EXAM_S1</div>
            </div>
        `;
    } else if (period === 'TOTAL_S2') {
        html += `
            <div class="summary-card">
                <h5>Total Semestre 2</h5>
                <div class="value">${calculatedData.calculatedTotals.average.toFixed(2)}</div>
                <div class="sub-value">P3 + P4 + EXAM_S2</div>
            </div>
        `;
    } else if (period === 'TOTAL_GENERAL') {
        html += `
            <div class="summary-card">
                <h5>Total G√©n√©ral</h5>
                <div class="value">${calculatedData.calculatedTotals.average.toFixed(2)}</div>
                <div class="sub-value">Moyenne(TOTAL_S1, TOTAL_S2)</div>
            </div>
            <div class="summary-card">
                <h5>Semestre 1</h5>
                <div class="value">${calculatedData.calculatedTotals.semester1.average.toFixed(2)}</div>
            </div>
            <div class="summary-card">
                <h5>Semestre 2</h5>
                <div class="value">${calculatedData.calculatedTotals.semester2.average.toFixed(2)}</div>
            </div>
        `;
    }
    
    html += `
        </div>
        
        <table class="parent-proclamation-table">
            <thead>
                <tr>
                    <th rowspan="2">N¬∞</th>
                    <th rowspan="2">Cours</th>
                    <th rowspan="2">Enseignant</th>
    `;
    
    // Colonnes sp√©cifiques selon la p√©riode
    if (period === 'TOTAL_GENERAL') {
        html += `
                    <th colspan="2">Semestre 1</th>
                    <th colspan="2">Semestre 2</th>
                    <th colspan="2">Total G√©n√©ral</th>
                </tr>
                <tr>
                    <th class="sub-header">CM</th>
                    <th class="sub-header">CO</th>
                    <th class="sub-header">CM</th>
                    <th class="sub-header">CO</th>
                    <th class="sub-header">CM</th>
                    <th class="sub-header">CO</th>
                </tr>
        `;
    } else if (period === 'TOTAL_S1' || period === 'TOTAL_S2') {
        html += `
                    <th colspan="3">Composition</th>
                    <th colspan="2">Total</th>
                </tr>
                <tr>
                    <th class="sub-header">P√©riodes</th>
                    <th class="sub-header">CM</th>
                    <th class="sub-header">CO</th>
                    <th class="sub-header">CM Total</th>
                    <th class="sub-header">CO Total</th>
                </tr>
        `;
    }
    
    html += `
            </thead>
            <tbody>
    `;
    
    // Trier les cours par ordre alphab√©tique
    courseNames.sort();
    
    courseNames.forEach((courseName, index) => {
        const course = calculatedData.coursesData[courseName];
        
        // D√©terminer la classe CSS pour la note
        let gradeClass = 'grade-average';
        const average = course.average || (course.totalCM > 0 ? course.totalCO / course.totalCM : 0);
        
        if (average >= 0.75) gradeClass = 'grade-good';
        else if (average >= 0.5) gradeClass = 'grade-average';
        else gradeClass = 'grade-poor';
        
        if (period === 'TOTAL_GENERAL') {
            // Affichage pour Total G√©n√©ral
            const s1 = course.semester1;
            const s2 = course.semester2;
            
            html += `
                <tr>
                    <td>${index + 1}</td>
                    <td><strong>${courseName}</strong></td>
                    <td>${course.teacherName}</td>
                    <td>${s1 ? s1.cm.toFixed(2) : '0.00'}</td>
                    <td>${s1 ? s1.co.toFixed(2) : '0.00'}</td>
                    <td>${s2 ? s2.cm.toFixed(2) : '0.00'}</td>
                    <td>${s2 ? s2.co.toFixed(2) : '0.00'}</td>
                    <td>${course.totalCM.toFixed(2)}</td>
                    <td class="${gradeClass}">${course.totalCO.toFixed(2)}</td>
                </tr>
            `;
        } else if (period === 'TOTAL_S1' || period === 'TOTAL_S2') {
            // Affichage pour Total Semestre
            const periods = course.periods ? Object.keys(course.periods) : [];
            const periodDetails = periods.map(p => 
                `${p}: ${course.periods[p].co.toFixed(2)}/${course.periods[p].cm.toFixed(2)}`
            ).join('<br>');
            
            html += `
                <tr>
                    <td>${index + 1}</td>
                    <td><strong>${courseName}</strong></td>
                    <td>${course.teacherName}</td>
                    <td>${periodDetails || '-'}</td>
                    <td>${course.totalCM.toFixed(2)}</td>
                    <td class="${gradeClass}">${course.totalCO.toFixed(2)}</td>
                </tr>
            `;
        }
    });
    
    // Ligne des totaux finaux
    html += `
            <tr class="total-row">
                <td colspan="${period === 'TOTAL_GENERAL' ? 3 : 4}"><strong>TOTAUX FINAUX</strong></td>
    `;
    
    if (period === 'TOTAL_GENERAL') {
        html += `
                <td><strong>${calculatedData.calculatedTotals.semester1.totalCM.toFixed(2)}</strong></td>
                <td><strong>${calculatedData.calculatedTotals.semester1.totalCO.toFixed(2)}</strong></td>
                <td><strong>${calculatedData.calculatedTotals.semester2.totalCM.toFixed(2)}</strong></td>
                <td><strong>${calculatedData.calculatedTotals.semester2.totalCO.toFixed(2)}</strong></td>
                <td><strong>${calculatedData.calculatedTotals.totalCM.toFixed(2)}</strong></td>
                <td class="grade-${calculatedData.calculatedTotals.average >= 0.5 ? 'good' : 'poor'}">
                    <strong>${calculatedData.calculatedTotals.totalCO.toFixed(2)}</strong>
                </td>
        `;
    } else {
        html += `
                <td><strong>${calculatedData.calculatedTotals.totalCM.toFixed(2)}</strong></td>
                <td class="grade-${calculatedData.calculatedTotals.average >= 0.5 ? 'good' : 'poor'}">
                    <strong>${calculatedData.calculatedTotals.totalCO.toFixed(2)}</strong>
                </td>
        `;
    }
    
    html += `
            </tr>
            <tr class="total-row">
                <td colspan="${period === 'TOTAL_GENERAL' ? 9 : 6}" style="text-align: center;">
                    <strong>MOYENNE G√âN√âRALE: ${calculatedData.calculatedTotals.average.toFixed(2)}</strong>
                    <br><small>${getPeriodCalculationInfoForParent(period)}</small>
                </td>
            </tr>
        </tbody>
    </table>
    `;
    
    container.innerHTML = html;
}

// === FONCTIONS DE CALCUL AUTOMATIQUE POUR LES TOTAUX ===

// Fonction pour calculer automatiquement les totaux des semestres
async function calculateAutomaticTotals(childId, period) {
    const child = childrenList.find(c => c.matricule === childId);
    if (!child || child.type !== 'secondary') return null;
    
    try {
        let totalData = {
            childName: child.fullName,
            className: child.class,
            period: period,
            coursesData: {},
            calculatedTotals: {
                totalCM: 0,
                totalCO: 0,
                average: 0
            }
        };
        
        // Calcul selon la p√©riode s√©lectionn√©e
        if (period === 'TOTAL_S1') {
            // Total Semestre 1 = P1 + P2 + EXAM_S1
            await calculateSemesterTotal(childId, 'TOTAL_S1', ['P1', 'P2', 'EXAM_S1'], totalData);
        } 
        else if (period === 'TOTAL_S2') {
            // Total Semestre 2 = P3 + P4 + EXAM_S2
            await calculateSemesterTotal(childId, 'TOTAL_S2', ['P3', 'P4', 'EXAM_S2'], totalData);
        } 
        else if (period === 'TOTAL_GENERAL') {
            // Total G√©n√©ral = Moyenne(TOTAL_S1, TOTAL_S2)
            await calculateGeneralTotal(childId, totalData);
        }
        
        return totalData;
        
    } catch (error) {
        console.error('Erreur calcul automatique:', error);
        return null;
    }
}

// Calculer le total d'un semestre
async function calculateSemesterTotal(childId, targetPeriod, sourcePeriods, totalData) {
    const child = childrenList.find(c => c.matricule === childId);
    
    // R√©cup√©rer toutes les cotes des p√©riodes sources
    for (const sourcePeriod of sourcePeriods) {
        const gradesQuery = query(
            collection(db, 'parent_grades'),
            where('className', '==', child.class),
            where('period', '==', sourcePeriod)
        );
        
        const gradesSnap = await getDocs(gradesQuery);
        
        gradesSnap.forEach(doc => {
            const gradeData = doc.data();
            const courseName = gradeData.subject;
            
            // Chercher la note de cet enfant sp√©cifique
            const studentGrade = gradeData.grades.find(g => g.studentMatricule === childId);
            
            if (studentGrade) {
                if (!totalData.coursesData[courseName]) {
                    totalData.coursesData[courseName] = {
                        teacherName: gradeData.teacherName,
                        maxPoints: gradeData.maxPoints,
                        periods: {},
                        totalCM: 0,
                        totalCO: 0
                    };
                }
                
                // Stocker les donn√©es par p√©riode
                totalData.coursesData[courseName].periods[sourcePeriod] = {
                    cm: gradeData.maxPoints,
                    co: studentGrade.grade,
                    percentage: studentGrade.percentage || 0
                };
                
                // Ajouter aux totaux du cours
                totalData.coursesData[courseName].totalCM += gradeData.maxPoints;
                totalData.coursesData[courseName].totalCO += studentGrade.grade;
            }
        });
    }
    
    // Calculer les totaux g√©n√©raux
    let generalTotalCM = 0;
    let generalTotalCO = 0;
    
    Object.values(totalData.coursesData).forEach(course => {
        generalTotalCM += course.totalCM;
        generalTotalCO += course.totalCO;
    });
    
    totalData.calculatedTotals = {
        totalCM: generalTotalCM,
        totalCO: generalTotalCO,
        average: generalTotalCM > 0 ? (generalTotalCO / generalTotalCM) : 0
    };
}

// Calculer le total g√©n√©ral (moyenne des deux semestres)
async function calculateGeneralTotal(childId, totalData) {
    // Calculer d'abord les totaux des semestres
    const semester1Data = await calculateSemesterTotal(childId, 'TOTAL_S1', ['P1', 'P2', 'EXAM_S1'], { 
        coursesData: {},
        calculatedTotals: { totalCM: 0, totalCO: 0, average: 0 }
    });
    
    const semester2Data = await calculateSemesterTotal(childId, 'TOTAL_S2', ['P3', 'P4', 'EXAM_S2'], { 
        coursesData: {},
        calculatedTotals: { totalCM: 0, totalCO: 0, average: 0 }
    });
    
    // Fusionner les donn√©es des deux semestres
    const allCourses = new Set([
        ...Object.keys(semester1Data.coursesData || {}),
        ...Object.keys(semester2Data.coursesData || {})
    ]);
    
    allCourses.forEach(courseName => {
        const course1 = semester1Data.coursesData[courseName];
        const course2 = semester2Data.coursesData[courseName];
        
        totalData.coursesData[courseName] = {
            teacherName: course1?.teacherName || course2?.teacherName || 'Non sp√©cifi√©',
            totalCM: ((course1?.totalCM || 0) + (course2?.totalCM || 0)) / 2,
            totalCO: ((course1?.totalCO || 0) + (course2?.totalCO || 0)) / 2,
            semester1: course1 ? {
                cm: course1.totalCM,
                co: course1.totalCO,
                average: course1.totalCM > 0 ? (course1.totalCO / course1.totalCM) : 0
            } : null,
            semester2: course2 ? {
                cm: course2.totalCM,
                co: course2.totalCO,
                average: course2.totalCM > 0 ? (course2.totalCO / course2.totalCM) : 0
            } : null
        };
        
        // Calculer la moyenne du cours
        const course = totalData.coursesData[courseName];
        course.average = course.totalCM > 0 ? (course.totalCO / course.totalCM) : 0;
    });
    
    // Calculer les totaux g√©n√©raux
    const semester1Total = semester1Data.calculatedTotals;
    const semester2Total = semester2Data.calculatedTotals;
    
    totalData.calculatedTotals = {
        semester1: semester1Total,
        semester2: semester2Total,
        totalCM: (semester1Total.totalCM + semester2Total.totalCM) / 2,
        totalCO: (semester1Total.totalCO + semester2Total.totalCO) / 2,
        average: ((semester1Total.average + semester2Total.average) / 2)
    };
}

// Afficher le tableau de proclamation pour l'enfant
function displayChildProclamationTable(child, coursesData, period) {
    const container = document.getElementById('grades-proclamation-table-container');
    const courseNames = Object.keys(coursesData);
    
    if (courseNames.length === 0) {
        container.innerHTML = '<p>Aucune donn√©e disponible pour cette p√©riode.</p>';
        return;
    }
    
    // Calculer les totaux
    let totalCM = 0;
    let totalCO = 0;
    
    courseNames.forEach(courseName => {
        const course = coursesData[courseName];
        const childGrade = course.grades[child.matricule];
        
        if (childGrade) {
            totalCM += childGrade.cm;
            totalCO += childGrade.co;
        }
    });
    
    // Cr√©er le tableau
    let html = `
        <div class="grades-summary">
            <div class="summary-card">
                <h5>Cours √âvalu√©s</h5>
                <div class="value">${courseNames.length}</div>
            </div>
            <div class="summary-card">
                <h5>Total CM</h5>
                <div class="value">${totalCM.toFixed(2)}</div>
            </div>
            <div class="summary-card">
                <h5>Total CO</h5>
                <div class="value">${totalCO.toFixed(2)}</div>
            </div>
            <div class="summary-card">
                <h5>Moyenne G√©n√©rale</h5>
                <div class="value">${totalCM > 0 ? (totalCO / totalCM).toFixed(2) : '0.00'}</div>
                <div class="sub-value">Sans pourcentage</div>
            </div>
        </div>
        
        <table class="parent-proclamation-table">
            <thead>
                <tr>
                    <th rowspan="2">N¬∞</th>
                    <th rowspan="2">Cours</th>
                    <th rowspan="2">Enseignant</th>
                    <th colspan="2">Cotes</th>
                    <th rowspan="2">Date</th>
                    <th rowspan="2">Remarques</th>
                </tr>
                <tr>
                    <th class="sub-header">CM</th>
                    <th class="sub-header">CO</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    // Trier les cours par ordre alphab√©tique
    courseNames.sort();
    
    courseNames.forEach((courseName, index) => {
        const course = coursesData[courseName];
        const childGrade = course.grades[child.matricule];
        
        if (!childGrade) return;
        
        const evaluationDate = course.evaluationDate ? 
            new Date(course.evaluationDate.toDate()).toLocaleDateString('fr-FR') : 
            'Non sp√©cifi√©e';
        
        // D√©terminer la classe CSS pour la note
        let gradeClass = 'grade-average';
        const ratio = childGrade.cm > 0 ? childGrade.co / childGrade.cm : 0;
        
        if (ratio >= 0.75) gradeClass = 'grade-good';
        else if (ratio >= 0.5) gradeClass = 'grade-average';
        else gradeClass = 'grade-poor';
        
        html += `
            <tr>
                <td>${index + 1}</td>
                <td><strong>${courseName}</strong></td>
                <td>${course.teacherName}</td>
                <td>${childGrade.cm.toFixed(2)}</td>
                <td class="${gradeClass}">${childGrade.co.toFixed(2)}</td>
                <td>${evaluationDate}</td>
                <td>${childGrade.remark || '-'}</td>
            </tr>
        `;
    });
    
    // Ligne des totaux
    html += `
            <tr class="total-row">
                <td colspan="3"><strong>TOTAUX</strong></td>
                <td><strong>${totalCM.toFixed(2)}</strong></td>
                <td><strong>${totalCO.toFixed(2)}</strong></td>
                <td colspan="2">
                    <strong>Moyenne: ${totalCM > 0 ? (totalCO / totalCM).toFixed(2) : '0.00'}</strong>
                </td>
            </tr>
        </tbody>
    </table>
    `;
    
    container.innerHTML = html;
}

// Obtenir le nom de la p√©riode pour affichage
function getPeriodNameForParent(period) {
    const periodNames = {
        'P1': 'Premi√®re P√©riode',
        'P2': 'Deuxi√®me P√©riode',
        'EXAM_S1': 'Examen Semestre 1',
        'TOTAL_S1': 'Total Semestre 1',
        'P3': 'Troisi√®me P√©riode',
        'P4': 'Quatri√®me P√©riode',
        'EXAM_S2': 'Examen Semestre 2',
        'TOTAL_S2': 'Total Semestre 2',
        'TOTAL_GENERAL': 'Total G√©n√©ral'
    };
    return periodNames[period] || period;
}

function getPeriodCalculationInfoForParent(period) {
    switch(period) {
        case 'TOTAL_S1':
            return 'Calcul: Total S1 = P1 + P2 + EXAM_S1 | Sommation des cotes par cours';
        case 'TOTAL_S2':
            return 'Calcul: Total S2 = P3 + P4 + EXAM_S2 | Sommation des cotes par cours';
        case 'TOTAL_GENERAL':
            return 'Calcul: Total G√©n√©ral = Moyenne(Total S1, Total S2) | Moyenne des deux semestres';
        default:
            return 'Cotes directes pour cette p√©riode';
    }
}

document.getElementById('download-grades-excel-btn').addEventListener('click', async () => {
    if (!childGradesData) {
        showAlert('Veuillez d\'abord charger les cotes', 'error');
        return;
    }
    
    try {
        const { childName, className, period, coursesData, calculatedTotals } = childGradesData;
        const courseNames = Object.keys(coursesData);
        
        // Pr√©parer les donn√©es pour Excel
        const excelData = [];
        
        // En-t√™te principal
        excelData.push([`COTES DE ${childName.toUpperCase()} - ${className}`]);
        excelData.push([`P√©riode: ${getPeriodNameForParent(period)}`]);
        excelData.push([`Date d'export: ${new Date().toLocaleDateString('fr-FR')}`]);
        excelData.push([`Mode de calcul: ${getPeriodCalculationInfoForParent(period)}`]);
        excelData.push([]);
        
        // Structure diff√©rente selon la p√©riode
        if (period === 'TOTAL_GENERAL' && calculatedTotals) {
            excelData.push(['Moyenne Semestre 1:', calculatedTotals.semester1.average.toFixed(2)]);
            excelData.push(['Moyenne Semestre 2:', calculatedTotals.semester2.average.toFixed(2)]);
            excelData.push(['Moyenne G√©n√©rale:', calculatedTotals.average.toFixed(2)]);
            excelData.push([]);
        }
        
    
        
        // En-t√™tes de colonnes
        excelData.push(['N¬∞', 'Cours', 'Enseignant', 'CM', 'CO', 'Date d\'√©valuation', 'Remarques']);
        
        // Donn√©es des cours
        let totalCM = 0;
        let totalCO = 0;
        let index = 1;
        
        courseNames.sort().forEach(courseName => {
            const course = coursesData[courseName];
            const childGrade = course.grades[Object.keys(course.grades)[0]];
            
            if (childGrade) {
                const evaluationDate = course.evaluationDate ? 
                    new Date(course.evaluationDate.toDate()).toLocaleDateString('fr-FR') : 
                    'Non sp√©cifi√©e';
                
                excelData.push([
                    index,
                    courseName,
                    course.teacherName,
                    childGrade.cm.toFixed(2),
                    childGrade.co.toFixed(2),
                    evaluationDate,
                    childGrade.remark || '-'
                ]);
                
                totalCM += childGrade.cm;
                totalCO += childGrade.co;
                index++;
            }
        });
        
        // Ligne de totaux
        excelData.push([]);
        excelData.push(['TOTAUX', '', '', totalCM.toFixed(2), totalCO.toFixed(2), '', '']);
        excelData.push(['MOYENNE G√âN√âRALE', '', '', '', (totalCM > 0 ? (totalCO / totalCM).toFixed(2) : '0.00'), '', '']);
        
        // Cr√©er le workbook
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(excelData);
        
        // Appliquer des styles
        const range = XLSX.utils.decode_range(ws['!ref']);
        for (let R = 0; R <= range.e.r; ++R) {
            for (let C = 0; C <= range.e.c; ++C) {
                const cell_address = {c: C, r: R};
                const cell_ref = XLSX.utils.encode_cell(cell_address);
                
                if (R === 0) {
                    ws[cell_ref].s = {
                        font: { bold: true, sz: 16 },
                        alignment: { horizontal: 'center' }
                    };
                } else if (R >= 1 && R <= 2) {
                    ws[cell_ref].s = {
                        font: { bold: true, sz: 12 },
                        alignment: { horizontal: 'center' }
                    };
                } else if (R === 4) {
                    ws[cell_ref].s = {
                        font: { bold: true, color: { rgb: "FFFFFF" } },
                        fill: { fgColor: { rgb: "2C3E50" } },
                        alignment: { horizontal: 'center' }
                    };
                } else if (R >= excelData.length - 3 && R <= excelData.length - 1) {
                    ws[cell_ref].s = {
                        font: { bold: true },
                        fill: { fgColor: { rgb: "E3F2FD" } }
                    };
                }
            }
        }
        
        // Ajuster la largeur des colonnes
        const colWidths = [];
        for (let C = 0; C < excelData[4].length; ++C) {
            let maxLength = excelData[4][C].length;
            for (let R = 5; R < excelData.length - 3; ++R) {
                const cellValue = excelData[R][C];
                if (cellValue && cellValue.toString().length > maxLength) {
                    maxLength = cellValue.toString().length;
                }
            }
            colWidths.push({ wch: Math.min(maxLength + 2, 50) });
        }
        ws['!cols'] = colWidths;
        
        XLSX.utils.book_append_sheet(wb, ws, 'Cotes');
        
        // T√©l√©charger
        const fileName = `Cotes_${childName}_${className}_${period}_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        showAlert('Fichier Excel t√©l√©charg√© avec succ√®s', 'success');
        
    } catch (error) {
        console.error('Erreur export Excel:', error);
        showAlert('Erreur lors de l\'export Excel: ' + error.message, 'error');
    }
});

// Exporter en PDF
document.getElementById('download-grades-pdf-btn').addEventListener('click', async () => {
    if (!childGradesData || !childGradesData.coursesData) {
        showAlert('Veuillez d\'abord charger les cotes', 'error');
        return;
    }
    
    try {
        const { childName, className, period, coursesData } = childGradesData;
        const courseNames = Object.keys(coursesData);
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('portrait');
        
        // Titre
        doc.setFontSize(16);
        doc.setTextColor(40, 40, 40);
        doc.text(`COTES DE ${childName.toUpperCase()}`, 15, 15);
        doc.setFontSize(12);
        doc.text(`Classe: ${className} | P√©riode: ${getPeriodNameForParent(period)}`, 15, 22);
        doc.text(`Date d'export: ${new Date().toLocaleDateString('fr-FR')}`, 15, 29);
        
        // Tableau
        const headers = ['N¬∞', 'Cours', 'Enseignant', 'CM', 'CO', 'Date', 'Remarques'];
        
        const data = [];
        let totalCM = 0;
        let totalCO = 0;
        let index = 1;
        
        courseNames.sort().forEach(courseName => {
            const course = coursesData[courseName];
            const childGrade = course.grades[Object.keys(course.grades)[0]];
            
            if (childGrade) {
                const evaluationDate = course.evaluationDate ? 
                    new Date(course.evaluationDate.toDate()).toLocaleDateString('fr-FR') : 
                    'Non sp√©cifi√©e';
                
                data.push([
                    index.toString(),
                    courseName,
                    course.teacherName,
                    childGrade.cm.toFixed(2),
                    childGrade.co.toFixed(2),
                    evaluationDate,
                    childGrade.remark || '-'
                ]);
                
                totalCM += childGrade.cm;
                totalCO += childGrade.co;
                index++;
            }
        });
        
        // Configuration du tableau
        doc.autoTable({
            head: [headers],
            body: data,
            startY: 35,
            theme: 'grid',
            styles: {
                fontSize: 8,
                cellPadding: 2,
                overflow: 'linebreak'
            },
            headStyles: {
                fillColor: [44, 62, 80],
                textColor: [255, 255, 255],
                fontStyle: 'bold'
            },
            columnStyles: {
                0: { cellWidth: 10 },
                1: { cellWidth: 40 },
                2: { cellWidth: 30 },
                3: { cellWidth: 15 },
                4: { cellWidth: 15 },
                5: { cellWidth: 25 },
                6: { cellWidth: 30 }
            },
            willDrawCell: function(data) {
                // Mettre en √©vidence les cotes
                if (data.column.index === 4) {
                    const value = parseFloat(data.cell.raw);
                    const cm = parseFloat(data.table.body[data.row.index][3]);
                    
                    if (!isNaN(value) && !isNaN(cm)) {
                        const ratio = cm > 0 ? value / cm : 0;
                        
                        if (ratio >= 0.75) {
                            data.cell.styles.textColor = [46, 125, 50];
                        } else if (ratio < 0.5) {
                            data.cell.styles.textColor = [198, 40, 40];
                        }
                    }
                }
            }
        });
        
        const finalY = doc.lastAutoTable.finalY || 35;
        
        // Ajouter les totaux
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.text(`Total CM: ${totalCM.toFixed(2)}`, 15, finalY + 10);
        doc.text(`Total CO: ${totalCO.toFixed(2)}`, 80, finalY + 10);
        doc.text(`Moyenne G√©n√©rale: ${totalCM > 0 ? (totalCO / totalCM).toFixed(2) : '0.00'}`, 140, finalY + 10);
        
        // Sauvegarder le PDF
        const fileName = `Cotes_${childName}_${period}_${new Date().toISOString().split('T')[0]}.pdf`;
        doc.save(fileName);
        
        showAlert('Fichier PDF t√©l√©charg√© avec succ√®s', 'success');
        
    } catch (error) {
        console.error('Erreur export PDF:', error);
        showAlert('Erreur lors de l\'export PDF: ' + error.message, 'error');
    }
});


async function loadPrimaryGrades(studentId, period) {
    showLoading('primary-grades-loading');
    const tableBody = document.getElementById('primary-grades-table-body');
    const summaryContainer = document.getElementById('primary-grades-summary');
    const statsContainer = document.getElementById('primary-grades-stats');
    
    tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Chargement des cotes...</td></tr>';
    summaryContainer.classList.add('hidden');
    
    try {
        const child = childrenList.find(c => c.matricule === studentId);
        if (!child || child.type !== 'primary') {
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Enfant non trouv√© ou non du primaire</td></tr>';
            hideLoading('primary-grades-loading');
            return;
        }
        
        const gradesQuery = query(
            collection(db, 'primary_published_grades'),
            where('studentId', '==', studentId),
            where('period', '==', period)
        );
        
        const gradesSnap = await getDocs(gradesQuery);
        
        if (gradesSnap.empty) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center;">
                        <div class="no-data">
                            <i class="fas fa-chart-bar"></i>
                            <p>Aucune cote publi√©e pour la ${period}</p>
                        </div>
                    </td>
                </tr>
            `;
            hideLoading('primary-grades-loading');
            return;
        }
        
        let allGrades = [];
        let totalMax = 0;
        let totalObtained = 0;
        
        gradesSnap.forEach(doc => {
            const gradeData = doc.data();
            const publishedDate = gradeData.publishedAt ? 
                new Date(gradeData.publishedAt.toDate()).toLocaleDateString('fr-FR') : 'Non sp√©cifi√©e';
            
            gradeData.grades.forEach(courseGrade => {
                allGrades.push({
                    courseName: courseGrade.courseName,
                    maxGrade: courseGrade.maxGrade,
                    obtainedGrade: courseGrade.obtainedGrade,
                    teacherName: courseGrade.teacherName,
                    publishedDate: publishedDate
                });
                
                totalMax += courseGrade.maxGrade;
                totalObtained += courseGrade.obtainedGrade;
            });
        });
        
        if (allGrades.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Aucune cote trouv√©e</td></tr>';
            hideLoading('primary-grades-loading');
            return;
        }
        
        let html = '';
        allGrades.forEach((grade, index) => {
            const percentage = (grade.obtainedGrade / grade.maxGrade) * 100;
            const gradeClass = percentage >= 50 ? 'grade-green' : 'grade-red';
            
            html += `
                <tr>
                    <td>${index + 1}</td>
                    <td>${grade.courseName}</td>
                    <td>${grade.maxGrade}</td>
                    <td class="${gradeClass}">${grade.obtainedGrade}</td>
                    <td>${grade.publishedDate}</td>
                    <td>${grade.teacherName}</td>
                </tr>
            `;
        });
        
        tableBody.innerHTML = html;
        
        // Afficher le r√©sum√©
        const overallPercentage = totalMax > 0 ? (totalObtained / totalMax * 100).toFixed(2) : 0;
        const averagePerCourse = allGrades.length > 0 ? (totalObtained / allGrades.length).toFixed(2) : 0;
        
        statsContainer.innerHTML = `
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number">${allGrades.length}</div>
                    <div class="stat-label">Cours √©valu√©s</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${totalObtained.toFixed(2)}/${totalMax}</div>
                    <div class="stat-label">Total Points</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${overallPercentage}%</div>
                    <div class="stat-label">Pourcentage</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${averagePerCourse}</div>
                    <div class="stat-label">Moyenne/Cours</div>
                </div>
            </div>
        `;
        
        summaryContainer.classList.remove('hidden');
        hideLoading('primary-grades-loading');
        
        // Marquer les notifications comme lues
        markNotificationsAsRead('grades');
        
    } catch (error) {
        console.error('Erreur chargement cotes primaire:', error);
        tableBody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center;">
                    <div class="no-data">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Erreur de chargement des cotes</p>
                    </div>
                </td>
            </tr>
        `;
        hideLoading('primary-grades-loading');
    }
}

// --- Sous-onglet: Cotes Maternelle ---
document.getElementById('kindergarten-grades-child-selector').addEventListener('change', (e) => {
    const studentId = e.target.value;
    const gradesContent = document.getElementById('kindergarten-grades-content');
    if (!studentId) {
        gradesContent.classList.add('hidden');
        return;
    }
    gradesContent.classList.remove('hidden');
    loadKindergartenGrades(studentId);
});

async function loadKindergartenGrades(studentId) {
    showLoading('kindergarten-grades-loading');
    const tableBody = document.getElementById('kindergarten-grades-table-body');
    
    try {
        const child = childrenList.find(c => c.matricule === studentId);
        if (!child || child.type !== 'kindergarten') {
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Enfant non trouv√© ou non de la maternelle</td></tr>';
            hideLoading('kindergarten-grades-loading');
            return;
        }
        
        const gradesQuery = query(
            collection(db, 'kindergarten_grades'),
            where('studentId', '==', studentId),
            orderBy('evaluationDate', 'desc')
        );
        
        const gradesSnap = await getDocs(gradesQuery);
        
        if (gradesSnap.empty) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center;">
                        <div class="no-data">
                            <i class="fas fa-baby"></i>
                            <p>Aucune cote publi√©e pour cet enfant</p>
                        </div>
                    </td>
                </tr>
            `;
            hideLoading('kindergarten-grades-loading');
            return;
        }
        
        let html = '';
        let index = 1;
        
        gradesSnap.forEach(doc => {
            const gradeData = doc.data();
            const evaluationDate = gradeData.evaluationDate ? 
                new Date(gradeData.evaluationDate.toDate()).toLocaleDateString('fr-FR') : 'Non sp√©cifi√©e';
            
            // Niveaux possibles
            const levels = {
                'excellent': 'Excellent',
                'tres_bien': 'Tr√®s bien',
                'bien': 'Bien',
                'suffisant': 'Suffisant',
                'insuffisant': 'Insuffisant'
            };
            
            const levelText = levels[gradeData.level] || gradeData.level;
            const levelClass = gradeData.level === 'excellent' || gradeData.level === 'tres_bien' ? 'grade-green' : 
                             gradeData.level === 'insuffisant' ? 'grade-red' : '';
            
            html += `
                <tr>
                    <td>${index}</td>
                    <td>${gradeData.competence || 'Comp√©tence'}</td>
                    <td class="${levelClass}">${levelText}</td>
                    <td>${gradeData.appreciation || 'Non sp√©cifi√©e'}</td>
                    <td>${evaluationDate}</td>
                    <td>${gradeData.teacherName || 'Non sp√©cifi√©'}</td>
                </tr>
            `;
            index++;
        });
        
        tableBody.innerHTML = html;
        hideLoading('kindergarten-grades-loading');
        
        // Marquer les notifications comme lues
        markNotificationsAsRead('grades');
        
    } catch (error) {
        console.error('Erreur chargement cotes maternelle:', error);
        tableBody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center;">
                    <div class="no-data">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Erreur de chargement des cotes</p>
                    </div>
                </td>
            </tr>
        `;
        hideLoading('kindergarten-grades-loading');
    }
}

async function loadChildDashboard(studentId) {
    const child = childrenList.find(c => c.matricule === studentId);
    if (!child) return;
    
    // Pour le tableau de bord, charger les cotes de la premi√®re p√©riode
    if (child.type === 'secondary') {
        // Utiliser le nouveau syst√®me
        await loadChildProclamationData(studentId, 'P1');
    } else if (child.type === 'primary') {
        // Pour le primaire, charger la premi√®re p√©riode
        await loadPrimaryGradesForDashboard(studentId, '1√®re p√©riode');
    } else {
        // Pour la maternelle, charger les cotes
        await loadKindergartenGradesForDashboard(studentId);
    }
    
    // ... reste du code existant pour les pr√©sences et devoirs ...

    
    const attendanceContainer = document.getElementById('attendance-container');
    attendanceContainer.innerHTML = "Chargement...";
    
    // Charger les pr√©sences
    const attQuery = query(collection(db, 'student_attendance'), where('studentId', '==', studentId));
    const attSnap = await getDocs(attQuery);
    
    let presentCount = 0;
    let totalCount = 0;
    
    attSnap.forEach(doc => {
        const attendanceData = doc.data();
        if (attendanceData.published === true) {
            totalCount++;
            if (attendanceData.status === 'present') {
                presentCount++;
            }
        }
    });
    
    const attendanceRate = totalCount > 0 ? (presentCount / totalCount * 100).toFixed(0) : 0;
    attendanceContainer.innerHTML = `
        <p>Taux de pr√©sence: <strong>${attendanceRate}%</strong></p>
        <p>Pr√©sences: ${presentCount} / ${totalCount}</p>
    `;
    
    // Charger les devoirs selon le type d'enfant
    const homeworkContainer = document.getElementById('homework-container');
    homeworkContainer.innerHTML = "Chargement...";
    
    if (child.type === 'secondary') {
        const hwQuery = query(collection(db, 'homework'), where('className', '==', child.class), orderBy('dueDate', 'desc'), limit(5));
        const hwSnap = await getDocs(hwQuery);
        
        if (hwSnap.empty) {
            homeworkContainer.innerHTML = "<p>Aucun devoir r√©cent.</p>";
        } else {
            let html = '<ul>';
            hwSnap.forEach(doc => {
                const hw = doc.data();
                const dueDate = hw.dueDate ? new Date(hw.dueDate.toDate()).toLocaleDateString('fr-FR') : 'Non sp√©cifi√©e';
                html += `<li><strong>${hw.subject}:</strong> ${hw.title} (√† rendre le ${dueDate})</li>`;
            });
            html += '</ul>';
            homeworkContainer.innerHTML = html;
        }
    } else if (child.type === 'primary') {
        const hwQuery = query(collection(db, 'homework'), where('className', '==', child.class), orderBy('createdAt', 'desc'), limit(5));
        const hwSnap = await getDocs(hwQuery);
        
        if (hwSnap.empty) {
            homeworkContainer.innerHTML = "<p>Aucun devoir r√©cent.</p>";
        } else {
            let html = '<ul>';
            hwSnap.forEach(doc => {
                const hw = doc.data();
                const dueDate = hw.dueDate ? new Date(hw.dueDate.toDate()).toLocaleDateString('fr-FR') : 'Non sp√©cifi√©e';
                html += `<li><strong>${hw.subject}:</strong> ${hw.title} (pour le ${dueDate})</li>`;
            });
            html += '</ul>';
            homeworkContainer.innerHTML = html;
        }
    } else {
        homeworkContainer.innerHTML = "<p>Les devoirs de la maternelle ne sont pas encore disponibles.</p>";
    }
}

// Charger les notes secondaires pour le tableau de bord
async function loadSecondaryGradesForDashboard(studentId) {
    const tableBody = document.getElementById('child-grades-table-body');
    
    try {
        // R√©cup√©rer les notes publi√©es
        const gradesQuery = query(
            collection(db, 'published_grades'),
            orderBy('publishedAt', 'desc')
        );
        const gradesSnap = await getDocs(gradesQuery);
        
        if (gradesSnap.empty) {
            tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Aucune note disponible.</td></tr>';
            return;
        }
        
        let allGrades = [];
        
        gradesSnap.forEach(doc => {
            const gradeData = doc.data();
            const studentGrade = gradeData.grades?.find(g => g.studentMatricule === studentId);
            
            if (studentGrade) {
                allGrades.push({
                    subject: gradeData.subject,
                    maxPoints: gradeData.maxPoints,
                    grade: studentGrade.grade,
                    teacherName: gradeData.teacherName,
                    gradeType: gradeData.gradeType,
                    evaluationDate: gradeData.evaluationDate
                });
            }
        });
        
        if (allGrades.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Aucune note trouv√©e.</td></tr>';
            return;
        }
        
        allGrades.sort((a, b) => {
            const dateA = a.evaluationDate ? a.evaluationDate.toDate() : new Date(0);
            const dateB = b.evaluationDate ? b.evaluationDate.toDate() : new Date(0);
            return dateB - dateA;
        });
        
        allGrades = allGrades.slice(0, 10); // Limiter √† 10 notes
        
        let html = '';
        allGrades.forEach((grade, index) => {
            const isGoodGrade = grade.grade >= (grade.maxPoints / 2);
            const gradeClass = isGoodGrade ? 'grade-green' : 'grade-red';
            const evaluationDate = grade.evaluationDate ? 
                grade.evaluationDate.toDate().toLocaleDateString('fr-FR') : 'Non sp√©cifi√©e';
            
            html += `
                <tr>
                    <td>${index + 1}</td>
                    <td>${grade.subject} (${grade.gradeType})</td>
                    <td>${grade.maxPoints}</td>
                    <td class="${gradeClass}">${grade.grade}</td>
                    <td>${grade.teacherName}</td>
                    <td>${evaluationDate}</td>
                </tr>
            `;
        });
        
        tableBody.innerHTML = html;
        
    } catch (error) {
        console.error('Erreur chargement notes tableau de bord:', error);
        tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Erreur de chargement.</td></tr>';
    }
}

// Charger les cotes primaires pour le tableau de bord
async function loadPrimaryGradesForDashboard(studentId, period) {
    const tableBody = document.getElementById('child-grades-table-body');
    
    try {
        const child = childrenList.find(c => c.matricule === studentId);
        if (!child || child.type !== 'primary') {
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Enfant non du primaire</td></tr>';
            return;
        }
        
        const gradesQuery = query(
            collection(db, 'primary_published_grades'),
            where('studentId', '==', studentId),
            where('period', '==', period)
        );
        
        const gradesSnap = await getDocs(gradesQuery);
        
        if (gradesSnap.empty) {
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Aucune cote disponible.</td></tr>';
            return;
        }
        
        let allGrades = [];
        
        gradesSnap.forEach(doc => {
            const gradeData = doc.data();
            gradeData.grades.forEach(courseGrade => {
                allGrades.push({
                    courseName: courseGrade.courseName,
                    maxGrade: courseGrade.maxGrade,
                    obtainedGrade: courseGrade.obtainedGrade,
                    teacherName: courseGrade.teacherName
                });
            });
        });
        
        if (allGrades.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Aucune cote trouv√©e.</td></tr>';
            return;
        }
        
        allGrades = allGrades.slice(0, 10); // Limiter √† 10 cotes
        
        let html = '';
        allGrades.forEach((grade, index) => {
            const percentage = (grade.obtainedGrade / grade.maxGrade) * 100;
            const gradeClass = percentage >= 50 ? 'grade-green' : 'grade-red';
            
            html += `
                <tr>
                    <td>${index + 1}</td>
                    <td>${grade.courseName}</td>
                    <td>${grade.maxGrade}</td>
                    <td class="${gradeClass}">${grade.obtainedGrade}</td>
                    <td>${grade.teacherName}</td>
                    <td>Primaire</td>
                </tr>
            `;
        });
        
        tableBody.innerHTML = html;
        
    } catch (error) {
        console.error('Erreur chargement cotes tableau de bord:', error);
        tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Erreur de chargement.</td></tr>';
    }
}

// Charger les cotes maternelles pour le tableau de bord
async function loadKindergartenGradesForDashboard(studentId) {
    const tableBody = document.getElementById('child-grades-table-body');
    
    try {
        const child = childrenList.find(c => c.matricule === studentId);
        if (!child || child.type !== 'kindergarten') {
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Enfant non de la maternelle</td></tr>';
            return;
        }
        
        const gradesQuery = query(
            collection(db, 'kindergarten_grades'),
            where('studentId', '==', studentId),
            orderBy('evaluationDate', 'desc'),
            limit(10)
        );
        
        const gradesSnap = await getDocs(gradesQuery);
        
        if (gradesSnap.empty) {
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Aucune cote disponible.</td></tr>';
            return;
        }
        
        let html = '';
        let index = 1;
        
        gradesSnap.forEach(doc => {
            const gradeData = doc.data();
            const evaluationDate = gradeData.evaluationDate ? 
                new Date(gradeData.evaluationDate.toDate()).toLocaleDateString('fr-FR') : 'Non sp√©cifi√©e';
            
            // Niveaux possibles
            const levels = {
                'excellent': 'Excellent',
                'tres_bien': 'Tr√®s bien',
                'bien': 'Bien',
                'suffisant': 'Suffisant',
                'insuffisant': 'Insuffisant'
            };
            
            const levelText = levels[gradeData.level] || gradeData.level;
            const levelClass = gradeData.level === 'excellent' || gradeData.level === 'tres_bien' ? 'grade-green' : 
                             gradeData.level === 'insuffisant' ? 'grade-red' : '';
            
            html += `
                <tr>
                    <td>${index}</td>
                    <td>${gradeData.competence || 'Comp√©tence'}</td>
                    <td class="${levelClass}">${levelText}</td>
                    <td>${gradeData.appreciation || ''}</td>
                    <td>${gradeData.teacherName || ''}</td>
                    <td>${evaluationDate}</td>
                </tr>
            `;
            index++;
        });
        
        tableBody.innerHTML = html;
        
    } catch (error) {
        console.error('Erreur chargement cotes maternelle tableau de bord:', error);
        tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Erreur de chargement.</td></tr>';
    }
}

function showLoading(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.classList.remove('hidden');
    }
}

function hideLoading(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.classList.add('hidden');
    }
}

// --- Pr√©sences et Incidents ---
document.getElementById('presence-child-selector').addEventListener('change', (e) => {
    const studentId = e.target.value;
    const content = document.getElementById('presence-incidents-content');
    if (!studentId) {
        content.classList.add('hidden');
        return;
    }
    content.classList.remove('hidden');
    loadChildIncidents(studentId);
});

document.getElementById('load-presence-btn').addEventListener('click', () => {
    const studentId = document.getElementById('presence-child-selector').value;
    const month = parseInt(document.getElementById('presence-month').value);
    const year = parseInt(document.getElementById('presence-year').value);
    
    if (!studentId) {
        showAlert("Veuillez s√©lectionner un enfant", "error");
        return;
    }
    
    loadChildMonthlyPresence(studentId, month, year);
});

// Charger les pr√©sences mensuelles d'un enfant
async function loadChildMonthlyPresence(studentId, month, year) {
    const container = document.getElementById('monthly-presence-container');
    container.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i><p>Chargement des pr√©sences...</p></div>';
    
    try {
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        
        const startDate = firstDay.toISOString().split('T')[0];
        const endDate = lastDay.toISOString().split('T')[0];
        
        // R√©cup√©rer les pr√©sences de l'√©l√®ve
        const allAttendanceSnap = await getDocs(collection(db, 'student_attendance'));
        const monthlyPresence = {};
        
        allAttendanceSnap.forEach(doc => {
            const data = doc.data();
            if (data.date >= startDate && data.date <= endDate && 
                data.studentId === studentId && data.published === true) {
                monthlyPresence[data.date] = data.status;
            }
        });
        
        // Calculer les statistiques
        let presentCount = 0;
        let absentCount = 0;
        let lateCount = 0;
        let totalDays = 0;
        
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
            const status = monthlyPresence[dateStr];
            
            if (status) {
                totalDays++;
                if (status === 'present') presentCount++;
                else if (status === 'absent') absentCount++;
                else if (status === 'late') lateCount++;
            }
        }
        
        // Afficher les statistiques
        const statsContainer = document.getElementById('presence-stats');
        const presenceRate = totalDays > 0 ? ((presentCount / totalDays) * 100).toFixed(1) : 0;
        
        statsContainer.innerHTML = `
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" style="color: #2e7d32;">${presentCount}</div>
                    <div class="stat-label">Pr√©sences</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #c62828;">${absentCount}</div>
                    <div class="stat-label">Absences</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #ef6c00;">${lateCount}</div>
                    <div class="stat-label">Retards</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #1565c0;">${presenceRate}%</div>
                    <div class="stat-label">Taux de pr√©sence</div>
                </div>
            </div>
        `;
        
        // Afficher le calendrier des pr√©sences
        let calendarHTML = `
            <h4 style="margin-bottom: 1rem;">Calendrier des pr√©sences - ${getMonthName(month)} ${year}</h4>
            <div class="attendance-grid">
        `;
        
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
            const status = monthlyPresence[dateStr];
            
            let statusClass = 'attendance-empty';
            let statusText = day.toString();
            let title = `${day} ${getMonthName(month)} ${year}`;
            
            if (status === 'present') {
                statusClass = 'attendance-present';
                statusText = '‚úì';
                title += ' - Pr√©sent';
            } else if (status === 'absent') {
                statusClass = 'attendance-absent';
                statusText = '‚úó';
                title += ' - Absent';
            } else if (status === 'late') {
                statusClass = 'attendance-late';
                statusText = '‚åö';
                title += ' - Retard';
            } else {
                title += ' - Non renseign√©';
            }
            
            calendarHTML += `
                <div class="attendance-day ${statusClass}" title="${title}">
                    ${statusText}
                </div>
            `;
        }
        
        calendarHTML += '</div>';
        
        // L√©gende
        calendarHTML += `
            <div style="margin-top: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div class="attendance-day attendance-present" style="width: 20px; height: 20px; padding: 0;">‚úì</div>
                    <span>Pr√©sent</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div class="attendance-day attendance-absent" style="width: 20px; height: 20px; padding: 0;">‚úó</div>
                    <span>Absent</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div class="attendance-day attendance-late" style="width: 20px; height: 20px; padding: 0;">‚åö</div>
                    <span>Retard</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div class="attendance-day attendance-empty" style="width: 20px; height: 20px; padding: 0; font-size: 0.7rem;">1</div>
                    <span>Non renseign√©</span>
                </div>
            </div>
        `;
        
        container.innerHTML = calendarHTML;
        
    } catch (error) {
        console.error('Erreur chargement pr√©sences mensuelles:', error);
        container.innerHTML = '<div class="no-data"><i class="fas fa-exclamation-triangle"></i><p>Erreur de chargement des pr√©sences.</p></div>';
    }
}

function getMonthName(monthIndex) {
    const months = [
        'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
        'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'
    ];
    return months[monthIndex];
}

// Charger les incidents d'un enfant
async function loadChildIncidents(studentId) {
    const container = document.getElementById('incidents-list-container');
    container.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i><p>Chargement des incidents...</p></div>';
    
    try {
        // ESSAYEZ LES DIFF√âRENTS NOMS DE CHAMPS POSSIBLES
        const incidentsQuery = query(
            collection(db, 'incidents'),
            orderBy('createdAt', 'desc')
        );
        
        const incidentsSnap = await getDocs(incidentsQuery);
        
        if (incidentsSnap.empty) {
            container.innerHTML = `
                <div class="no-data">
                    <i class="fas fa-check-circle"></i>
                    <p>Aucun incident signal√© pour cet enfant.</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        let incidentsFound = false;
        
        incidentsSnap.forEach(doc => {
            const incident = { id: doc.id, ...doc.data() };
            
            // V√©rifiez les diff√©rents noms de champs possibles
            const isChildIncident = 
                incident.studentMatricule === studentId || 
                incident.studentId === studentId ||
                incident.matricule === studentId ||
                (incident.student && incident.student.matricule === studentId);
            
            if (isChildIncident) {
                incidentsFound = true;
                const date = incident.createdAt ? new Date(incident.createdAt.toDate()).toLocaleDateString('fr-FR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : 'Date inconnue';
                
                const severityClass = `severity-${incident.severity}`;
                
                html += `
                    <div class="incident-item ${severityClass}">
                        <div class="incident-header">
                            <span class="incident-type">${getIncidentTypeLabel(incident.type)}</span>
                            <span class="incident-date">${date}</span>
                        </div>
                        <div class="incident-description">
                            ${incident.description || 'Aucune description fournie.'}
                        </div>
                        <div>
                            <span class="incident-severity ${severityClass}">
                                ${getSeverityLabel(incident.severity)}
                            </span>
                        </div>
                    </div>
                `;
            }
        });
        
        if (!incidentsFound) {
            container.innerHTML = `
                <div class="no-data">
                    <i class="fas fa-check-circle"></i>
                    <p>Aucun incident signal√© pour cet enfant.</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = html;
        
        // Marquer les notifications comme lues
        markNotificationsAsRead('presence-incidents');
        
    } catch (error) {
        console.error('Erreur chargement incidents:', error);
        container.innerHTML = `
            <div class="no-data">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Erreur de chargement des incidents: ${error.message}</p>
                <p style="font-size: 0.8rem; margin-top: 0.5rem;">
                    Si le probl√®me persiste, veuillez contacter l'administration.
                </p>
            </div>
        `;
    }
}

function getIncidentTypeLabel(type) {
    const types = {
        'retard': 'Retard',
        'absenteisme': 'Absent√©isme',
        'comportement': 'Probl√®me de comportement',
        'autre': 'Autre incident'
    };
    return types[type] || type;
}

function getSeverityLabel(severity) {
    const severities = {
        'faible': 'Faible',
        'moyen': 'Moyen',
        'eleve': '√âlev√©'
    };
    return severities[severity] || severity;
}

// --- Paiements ---
document.getElementById('payment-child-selector').addEventListener('change', (e) => {
    const studentId = e.target.value;
    const paymentContent = document.getElementById('payment-content');
    if (!studentId) {
        paymentContent.classList.add('hidden');
        return;
    }
    paymentContent.classList.remove('hidden');
    loadPaymentStatus(studentId);
    setupPaymentForm(studentId);
});

async function loadPaymentStatus(studentId) {
    const statusContainer = document.getElementById('payment-status-container');
    statusContainer.innerHTML = "Chargement...";

    const paymentsQuery = query(collection(db, 'payments'), where('studentId', '==', studentId));
    const paymentsSnap = await getDocs(paymentsQuery);
    const paidMonths = paymentsSnap.docs.map(d => d.data().month);

    statusContainer.innerHTML = paidMonths.length > 0 
        ? `<p>Mois pay√©s : <strong>${paidMonths.join(', ')}</strong></p>` 
        : "<p>Aucun paiement enregistr√©.</p>";
}

function setupPaymentForm(studentId) {
    const student = childrenList.find(c => c.matricule === studentId);
    if (student) {
        document.getElementById('payment-student-id').value = student.matricule;
        document.getElementById('payment-student-name').value = student.fullName;
        document.getElementById('payment-student-class').value = student.class;
    }
}

document.getElementById('online-payment-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const studentId = document.getElementById('payment-student-id').value;
    const studentName = document.getElementById('payment-student-name').value;
    const month = document.getElementById('payment-month').value;
    const amount = parseInt(document.getElementById('payment-amount').value);
    
    if (!studentId || !studentName || !month || !amount) {
        showAlert("Veuillez remplir tous les champs", "error");
        return;
    }
    
    try {
        const paymentCode = generatePaymentCode();
        
        await addDoc(collection(db, 'payment_requests'), {
            studentId: studentId,
            studentName: studentName,
            parentId: currentParent.matricule,
            months: [month],
            amount: amount,
            paymentCode: paymentCode,
            status: 'pending',
            createdAt: serverTimestamp()
        });

        document.getElementById('generated-code').textContent = paymentCode;
        
        const receiptPreview = document.getElementById('receipt-preview');
        receiptPreview.innerHTML = `
            <div class="receipt">
                <div class="receipt-header">
                    <div class="receipt-logo">
                        <h2>CS LA COLOMBE</h2>
                    </div>
                    <div class="receipt-title">DEMANDE DE PAIEMENT</div>
                    <div>Complexe Scolaire la Colombe</div>
                    <div>Code: ${paymentCode}</div>
                </div>
                
                <div class="receipt-details">
                    <div class="receipt-row">
                        <span>√âl√®ve:</span>
                        <span>${studentName}</span>
                    </div>
                    <div class="receipt-row">
                        <span>Mois:</span>
                        <span>${month}</span>
                    </div>
                    <div class="receipt-row">
                        <span>Montant:</span>
                        <span>${amount.toLocaleString()} FCFA</span>
                    </div>
                    <div class="receipt-divider"></div>
                    <div class="receipt-row">
                        <span>Date:</span>
                        <span>${new Date().toLocaleDateString('fr-FR')}</span>
                    </div>
                    <div class="receipt-row">
                        <span>Parent:</span>
                        <span>${currentParent.fullName}</span>
                    </div>
                </div>
                
                <div class="receipt-footer">
                    <p>Pr√©sentez ce document au secr√©tariat pour finaliser le paiement</p>
                    <p>Complexe Scolaire la Colombe</p>
                </div>
            </div>
        `;
        
        document.getElementById('payment-code-modal').classList.remove('hidden');
        document.getElementById('online-payment-form').reset();
        
    } catch (error) {
        showAlert('Erreur lors de la demande de paiement: ' + error.message, 'error');
    }
});

// T√©l√©chargement du re√ßu
document.getElementById('download-receipt-btn').addEventListener('click', () => {
    const receiptContent = document.getElementById('receipt-preview').innerHTML;
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Demande de Paiement</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    .receipt { max-width: 500px; margin: 0 auto; border: 1px solid #ddd; padding: 1.5rem; }
                    .receipt-header { text-align: center; margin-bottom: 1.5rem; }
                    .receipt-title { font-size: 1.2rem; font-weight: bold; margin: 10px 0; }
                    .receipt-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
                    .receipt-divider { border-top: 1px solid #ddd; margin: 15px 0; }
                    .receipt-footer { text-align: center; margin-top: 1.5rem; font-size: 0.8rem; color: #666; }
                    @media print {
                        body { margin: 0; }
                        .receipt { border: none; box-shadow: none; }
                    }
                </style>
            </head>
            <body>
                ${receiptContent}
            </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
});

// --- Page: Devoirs - Gestion des sous-onglets ---

// Sous-onglet: Devoirs Secondaire
document.getElementById('secondary-homework-child-selector').addEventListener('change', (e) => {
    const studentId = e.target.value;
    const homeworkContent = document.getElementById('secondary-homework-content');
    if (!studentId) {
        homeworkContent.classList.add('hidden');
        return;
    }
    homeworkContent.classList.remove('hidden');
    loadSecondaryHomework(studentId);
});

function setupHomeworkTabs() {
    // Gestion des onglets "en cours" / "rendus" pour le secondaire
    document.querySelectorAll('#secondary-homework-content .tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('#secondary-homework-content .tab, #secondary-homework-content .tab-content').forEach(el => el.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
            
            const studentId = document.getElementById('secondary-homework-child-selector').value;
            if (studentId) {
                if (tab.dataset.tab === 'pending') {
                    loadPendingHomework(studentId);
                } else if (tab.dataset.tab === 'submitted') {
                    loadSubmittedHomework(studentId);
                }
            }
        });
    });
}

async function loadSecondaryHomework(studentId) {
    await loadPendingHomework(studentId);
}

// Charger les devoirs en cours (Secondaire)
async function loadPendingHomework(studentId) {
    showLoading('pending-homework-loading');
    const container = document.getElementById('pending-homework-container');
    
    try {
        const child = childrenList.find(c => c.matricule === studentId);
        if (!child || child.type !== 'secondary') {
            container.innerHTML = '<p>Enfant non trouv√© ou non du secondaire</p>';
            hideLoading('pending-homework-loading');
            return;
        }
        
        const homeworkQuery = query(
            collection(db, 'homework'), 
            where('className', '==', child.class),
            orderBy('dueDate', 'asc')
        );
        const homeworkSnap = await getDocs(homeworkQuery);

        if (homeworkSnap.empty) {
            container.innerHTML = `
                <div class="no-data">
                    <i class="fas fa-book-open"></i>
                    <h3>Aucun devoir en cours</h3>
                    <p>Votre enfant n'a aucun devoir √† faire pour le moment.</p>
                </div>
            `;
            hideLoading('pending-homework-loading');
            return;
        }
        
        let html = '';
        const now = new Date();
        let hasPendingHomework = false;
        
        homeworkSnap.forEach(doc => {
            const hw = doc.data();
            
            const dueDate = hw.dueDate ? new Date(hw.dueDate.toDate()) : null;
            const dueDateStr = dueDate ? dueDate.toLocaleDateString('fr-FR') : 'Non sp√©cifi√©e';
            
            // V√©rifier si le devoir est en retard
            const isOverdue = dueDate && dueDate < now;
            const isDueSoon = dueDate && (dueDate - now) < (2 * 24 * 60 * 60 * 1000); // 2 jours
            
            // V√©rifier si l'√©l√®ve a d√©j√† soumis ce devoir
            const hasSubmitted = hw.submissions && hw.submissions.some(
                submission => submission.studentMatricule === studentId
            );

            // Si d√©j√† soumis, ne pas afficher dans "Devoirs en cours"
            if (hasSubmitted) {
                return;
            }

            hasPendingHomework = true;
            
            // D√©terminer la classe CSS selon le statut
            let itemClass = 'homework-item';
            if (isOverdue) itemClass += ' overdue';
            else if (isDueSoon) itemClass += ' due-soon';
            
            const fileLink = hw.fileURL ? 
                `<a href="${hw.fileURL}" target="_blank" class="btn btn-primary btn-sm">
                    <i class="fas fa-download"></i> T√©l√©charger ${hw.fileName || 'le fichier'}
                 </a>` : 
                '<p><em>Aucun fichier joint</em></p>';
            
            html += `
                <div class="${itemClass}">
                    <div class="homework-header">
                        <div>
                            <div class="homework-title">${hw.title || 'Devoir sans titre'}</div>
                            <div class="homework-meta">
                                <strong>Mati√®re:</strong> ${hw.subject || 'Non sp√©cifi√©'} | 
                                <strong>Enseignant:</strong> ${hw.teacherName || 'Non sp√©cifi√©'} | 
                                <strong>Date de rendu:</strong> ${dueDateStr}
                            </div>
                        </div>
                        <div>
                            ${isOverdue ? 
                                '<span class="submission-status submission-overdue">En retard</span>' : 
                                '<span class="submission-status submission-pending">√Ä rendre</span>'
                            }
                        </div>
                    </div>
                    <div class="homework-description">${hw.description || 'Aucune description'}</div>
                    ${fileLink}
                </div>
            `;
        });
        
        if (!hasPendingHomework) {
            container.innerHTML = `
                <div class="no-data">
                    <i class="fas fa-book-open"></i>
                    <h3>Aucun devoir en cours</h3>
                    <p>Votre enfant n'a aucun devoir √† faire pour le moment.</p>
                </div>
            `;
        } else {
            container.innerHTML = html;
        }
        
        hideLoading('pending-homework-loading');
        
        // Marquer les notifications comme lues
        markNotificationsAsRead('homework');
        
    } catch (error) {
        console.error('Erreur chargement devoirs en cours:', error);
        container.innerHTML = `
            <div class="no-data">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Erreur de chargement</h3>
                <p>Impossible de charger les devoirs. Veuillez r√©essayer plus tard.</p>
            </div>
        `;
        hideLoading('pending-homework-loading');
    }
}

// Charger les devoirs rendus (Secondaire)
async function loadSubmittedHomework(studentId) {
    showLoading('submitted-homework-loading');
    const container = document.getElementById('submitted-homework-container');
    
    try {
        const child = childrenList.find(c => c.matricule === studentId);
        if (!child || child.type !== 'secondary') {
            container.innerHTML = '<p>Enfant non trouv√© ou non du secondaire</p>';
            hideLoading('submitted-homework-loading');
            return;
        }
        
        const homeworkQuery = query(
            collection(db, 'homework'), 
            where('className', '==', child.class),
            orderBy('dueDate', 'desc')
        );
        const homeworkSnap = await getDocs(homeworkQuery);

        if (homeworkSnap.empty) {
            container.innerHTML = `
                <div class="no-data">
                    <i class="fas fa-book-open"></i>
                    <h3>Aucun devoir rendu</h3>
                    <p>Votre enfant n'a rendu aucun devoir pour le moment.</p>
                </div>
            `;
            hideLoading('submitted-homework-loading');
            return;
        }
        
        let html = '';
        const now = new Date();
        let hasSubmittedHomework = false;
        
        homeworkSnap.forEach(doc => {
            const hw = doc.data();
            
            // V√©rifier si l'√©l√®ve a soumis ce devoir
            const studentSubmission = hw.submissions && hw.submissions.find(
                submission => submission.studentMatricule === studentId
            );
            
            if (!studentSubmission) return; // Ignorer les devoirs non soumis
            
            hasSubmittedHomework = true;
            
            const dueDate = hw.dueDate ? new Date(hw.dueDate.toDate()) : null;
            const dueDateStr = dueDate ? dueDate.toLocaleDateString('fr-FR') : 'Non sp√©cifi√©e';
            const submissionDate = studentSubmission.submittedAt ? 
                new Date(studentSubmission.submittedAt.toDate()).toLocaleDateString('fr-FR') : 'Non sp√©cifi√©e';
            
            // V√©rifier si le devoir a √©t√© not√©
            const isGraded = studentSubmission.grade !== undefined;
            const gradeText = isGraded ? 
                `${studentSubmission.grade}/${studentSubmission.maxPoints || 20}` : 
                'Non not√©';
            
            const fileLink = hw.fileURL ? 
                `<a href="${hw.fileURL}" target="_blank" class="btn btn-primary btn-sm">
                    <i class="fas fa-download"></i> T√©l√©charger le devoir
                 </a>` : 
                '<p><em>Aucun fichier joint</em></p>';
            
            const submissionFileLink = studentSubmission.fileURL ? 
                `<a href="${studentSubmission.fileURL}" target="_blank" class="btn btn-info btn-sm">
                    <i class="fas fa-download"></i> Soumission de l'√©l√®ve
                 </a>` : 
                '<p><em>Soumission sans fichier</em></p>';
            
            html += `
                <div class="homework-item">
                    <div class="homework-header">
                        <div>
                            <div class="homework-title">${hw.title || 'Devoir sans titre'}</div>
                            <div class="homework-meta">
                                <strong>Mati√®re:</strong> ${hw.subject || 'Non sp√©cifi√©'} | 
                                <strong>Enseignant:</strong> ${hw.teacherName || 'Non sp√©cifi√©'} | 
                                <strong>Date de rendu:</strong> ${dueDateStr} |
                                <strong>Rendu le:</strong> ${submissionDate}
                            </div>
                        </div>
                        <div>
                            ${isGraded ? 
                                `<span class="submission-status submission-graded">Not√©: ${gradeText}</span>` : 
                                '<span class="submission-status submission-submitted">Rendu</span>'
                            }
                        </div>
                    </div>
                    <div class="homework-description">${hw.description || 'Aucune description'}</div>
                    ${fileLink}
                    <div style="margin-top: 1rem;">
                        <h5>Soumission de l'√©l√®ve:</h5>
                        ${studentSubmission.textAnswer ? 
                            `<p><strong>R√©ponse textuelle:</strong> ${studentSubmission.textAnswer}</p>` : 
                            ''
                        }
                        ${submissionFileLink}
                        ${studentSubmission.comments ? 
                            `<p><strong>Commentaires de l'enseignant:</strong> ${studentSubmission.comments}</p>` : 
                            ''
                        }
                    </div>
                </div>
            `;
        });
        
        if (!hasSubmittedHomework) {
            container.innerHTML = `
                <div class="no-data">
                    <i class="fas fa-book-open"></i>
                    <h3>Aucun devoir rendu</h3>
                    <p>Votre enfant n'a rendu aucun devoir pour le moment.</p>
                </div>
            `;
        } else {
            container.innerHTML = html;
        }
        
        hideLoading('submitted-homework-loading');
        
    } catch (error) {
        console.error('Erreur chargement devoirs rendus:', error);
        container.innerHTML = `
            <div class="no-data">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Erreur de chargement</h3>
                <p>Impossible de charger les devoirs rendus. Veuillez r√©essayer plus tard.</p>
            </div>
        `;
        hideLoading('submitted-homework-loading');
    }
}

// Sous-onglet: Devoirs Primaire
document.getElementById('primary-homework-child-selector').addEventListener('change', (e) => {
    const studentId = e.target.value;
    const homeworkContent = document.getElementById('primary-homework-content');
    if (!studentId) {
        homeworkContent.classList.add('hidden');
        return;
    }
    homeworkContent.classList.remove('hidden');
    loadPrimaryHomework(studentId);
});

async function loadPrimaryHomework(studentId) {
    showLoading('primary-homework-loading');
    const container = document.getElementById('primary-homework-container');
    
    try {
        const child = childrenList.find(c => c.matricule === studentId);
        if (!child || child.type !== 'primary') {
            container.innerHTML = '<p>Enfant non trouv√© ou non du primaire</p>';
            hideLoading('primary-homework-loading');
            return;
        }
        
        const homeworkQuery = query(
            collection(db, 'homework'),
            where('className', '==', child.class),
            where('published', '==', true),
            orderBy('createdAt', 'desc')
        );
        
        const homeworkSnap = await getDocs(homeworkQuery);

        if (homeworkSnap.empty) {
            container.innerHTML = `
                <div class="no-data">
                    <i class="fas fa-book"></i>
                    <h3>Aucun devoir publi√©</h3>
                    <p>Aucun devoir n'a √©t√© publi√© pour la classe de votre enfant.</p>
                </div>
            `;
            hideLoading('primary-homework-loading');
            return;
        }
        
        let html = '';
        
        homeworkSnap.forEach(doc => {
            const hw = doc.data();
            const dueDate = hw.dueDate ? new Date(hw.dueDate.toDate()).toLocaleDateString('fr-FR') : 'Non sp√©cifi√©e';
            const createdAt = hw.createdAt ? new Date(hw.createdAt.toDate()).toLocaleDateString('fr-FR') : 'Non sp√©cifi√©e';
            
            const fileLink = hw.fileURL ? 
                `<a href="${hw.fileURL}" target="_blank" class="btn btn-primary btn-sm">
                    <i class="fas fa-download"></i> T√©l√©charger ${hw.fileName || 'le fichier'}
                 </a>` : 
                '<p><em>Aucun fichier joint</em></p>';
            
            html += `
                <div class="primary-homework-item">
                    <div class="homework-header">
                        <div>
                            <div class="homework-title">${hw.title || 'Devoir sans titre'}</div>
                            <div class="homework-meta">
                                <strong>Mati√®re:</strong> ${hw.subject || 'Non sp√©cifi√©'} | 
                                <strong>Enseignant:</strong> ${hw.teacherName || 'Non sp√©cifi√©'} | 
                                <strong>Date de rendu:</strong> ${dueDate}
                            </div>
                        </div>
                    </div>
                    <div class="homework-description">${hw.description || 'Aucune description'}</div>
                    ${fileLink}
                    <div class="homework-meta" style="margin-top: 1rem;">
                        <small>Publi√© le: ${createdAt}</small>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        hideLoading('primary-homework-loading');
        
    } catch (error) {
        console.error('Erreur chargement devoirs primaire:', error);
        container.innerHTML = `
            <div class="no-data">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Erreur de chargement</h3>
                <p>Impossible de charger les devoirs. Veuillez r√©essayer plus tard.</p>
            </div>
        `;
        hideLoading('primary-homework-loading');
    }
}

// Sous-onglet: Devoirs Maternelle
document.getElementById('kindergarten-homework-child-selector').addEventListener('change', (e) => {
    const studentId = e.target.value;
    const homeworkContent = document.getElementById('kindergarten-homework-content');
    if (!studentId) {
        homeworkContent.classList.add('hidden');
        return;
    }
    homeworkContent.classList.remove('hidden');
    loadKindergartenHomework(studentId);
});

async function loadKindergartenHomework(studentId) {
    showLoading('kindergarten-homework-loading');
    const container = document.getElementById('kindergarten-homework-container');
    
    try {
        const child = childrenList.find(c => c.matricule === studentId);
        if (!child || child.type !== 'kindergarten') {
            container.innerHTML = '<p>Enfant non trouv√© ou non de la maternelle</p>';
            hideLoading('kindergarten-homework-loading');
            return;
        }
        
        const homeworkQuery = query(
            collection(db, 'kindergarten_homework'),
            where('className', '==', child.class),
            where('published', '==', true),
            orderBy('createdAt', 'desc')
        );
        
        const homeworkSnap = await getDocs(homeworkQuery);

        if (homeworkSnap.empty) {
            container.innerHTML = `
                <div class="no-data">
                    <i class="fas fa-baby"></i>
                    <h3>Aucun devoir publi√©</h3>
                    <p>Aucun devoir n'a √©t√© publi√© pour la classe de votre enfant.</p>
                </div>
            `;
            hideLoading('kindergarten-homework-loading');
            return;
        }
        
        let html = '';
        
        homeworkSnap.forEach(doc => {
            const hw = doc.data();
            const dueDate = hw.dueDate ? new Date(hw.dueDate.toDate()).toLocaleDateString('fr-FR') : 'Non sp√©cifi√©e';
            const createdAt = hw.createdAt ? new Date(hw.createdAt.toDate()).toLocaleDateString('fr-FR') : 'Non sp√©cifi√©e';
            
            const fileLink = hw.fileURL ? 
                `<a href="${hw.fileURL}" target="_blank" class="btn btn-primary btn-sm">
                    <i class="fas fa-download"></i> T√©l√©charger ${hw.fileName || 'le fichier'}
                 </a>` : 
                '<p><em>Aucun fichier joint</em></p>';
            
            html += `
                <div class="primary-homework-item">
                    <div class="homework-header">
                        <div>
                            <div class="homework-title">${hw.title || 'Devoir sans titre'}</div>
                            <div class="homework-meta">
                                <strong>Activit√©:</strong> ${hw.activity || 'Non sp√©cifi√©'} | 
                                <strong>Enseignant:</strong> ${hw.teacherName || 'Non sp√©cifi√©'} | 
                                <strong>Date de rendu:</strong> ${dueDate}
                            </div>
                        </div>
                    </div>
                    <div class="homework-description">${hw.description || 'Aucune description'}</div>
                    ${fileLink}
                    <div class="homework-meta" style="margin-top: 1rem;">
                        <small>Publi√© le: ${createdAt}</small>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        hideLoading('kindergarten-homework-loading');
        
    } catch (error) {
        console.error('Erreur chargement devoirs maternelle:', error);
        container.innerHTML = `
            <div class="no-data">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Erreur de chargement</h3>
                <p>Impossible de charger les devoirs. Veuillez r√©essayer plus tard.</p>
            </div>
        `;
        hideLoading('kindergarten-homework-loading');
    }
}

// --- Temps Horaire ---
document.getElementById('timetable-child-selector').addEventListener('change', (e) => {
    const studentId = e.target.value;
    const timetableContent = document.getElementById('timetable-content');
    if (!studentId) {
        timetableContent.classList.add('hidden');
        return;
    }
    timetableContent.classList.remove('hidden');
});

document.getElementById('load-timetable-btn').addEventListener('click', loadTimetable);

async function loadTimetable() {
    showLoading('timetable-loading');
    const container = document.getElementById('timetable-display');
    
    const studentId = document.getElementById('timetable-child-selector').value;
    if (!studentId) {
        showAlert("Veuillez s√©lectionner un enfant", "error");
        hideLoading('timetable-loading');
        return;
    }
    
    try {
        const month = document.getElementById('timetable-month').value;
        const week = document.getElementById('timetable-week').value;
        
        const child = childrenList.find(c => c.matricule === studentId);
        if (!child) {
            container.innerHTML = '<p>Enfant non trouv√©</p>';
            hideLoading('timetable-loading');
            return;
        }
        
        // Construire la requ√™te selon les filtres
        let timetableQuery;
        
        if (month && week) {
            // Filtre par mois et semaine sp√©cifiques
            timetableQuery = query(
                collection(db, 'student_schedules'),
                where('studentMatricule', '==', studentId),
                where('month', '==', month),
                where('week', '==', week),
                orderBy('publishedAt', 'desc')
            );
        } else if (month) {
            // Filtre par mois seulement
            timetableQuery = query(
                collection(db, 'student_schedules'),
                where('studentMatricule', '==', studentId),
                where('month', '==', month),
                orderBy('publishedAt', 'desc')
            );
        } else {
            // Aucun filtre, r√©cup√©rer les plus r√©cents
            timetableQuery = query(
                collection(db, 'student_schedules'),
                where('studentMatricule', '==', studentId),
                orderBy('publishedAt', 'desc')
            );
        }
        
        const timetableSnap = await getDocs(timetableQuery);
        
        if (timetableSnap.empty) {
            container.innerHTML = `
                <div class="no-schedule">
                    <i class="fas fa-calendar-times"></i>
                    <h3>Aucun horaire disponible</h3>
                    <p>L'horaire de votre enfant n'a pas encore √©t√© publi√© pour la p√©riode s√©lectionn√©e.</p>
                </div>
            `;
            hideLoading('timetable-loading');
            return;
        }
        
        let html = '';
        
        timetableSnap.forEach(doc => {
            const timetableData = doc.data();
            const publishedDate = timetableData.publishedAt.toDate().toLocaleDateString('fr-FR');
            
            html += `
                <div class="timetable-section">
                    <div class="schedule-info">
                        <h4>Horaire de la classe ${timetableData.className} - Semaine ${timetableData.week} (${timetableData.month})</h4>
                        <p>Publi√© le ${publishedDate}</p>
                    </div>
                    <div class="table-container">
                        <table class="class-schedule-table">
                            <thead>
                                <tr>
                                    <th class="hour-header">Heures</th>
                                    <th class="day-header">Lundi</th>
                                    <th class="day-header">Mardi</th>
                                    <th class="day-header">Mercredi</th>
                                    <th class="day-header">Jeudi</th>
                                    <th class="day-header">Vendredi</th>
                                    <th class="day-header">Samedi</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            // G√©n√©rer les 7 lignes pour les 7 heures de cours
            for (let hour = 1; hour <= 7; hour++) {
                html += `<tr><td class="hour-header">${hour}√®re heure</td>`;
                
                // Ajouter les cellules pour chaque jour
                const days = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                days.forEach(day => {
                    const course = timetableData.schedule.find(item => 
                        item.hour === hour && item.day === day
                    );
                    html += `<td>${course ? course.course : '-'}</td>`;
                });
                
                html += '</tr>';
            }
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        hideLoading('timetable-loading');
        
    } catch (error) {
        console.error('Erreur chargement horaire:', error);
        container.innerHTML = `
            <div class="no-schedule">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Erreur de chargement</h3>
                <p>Impossible de charger l'horaire. Veuillez r√©essayer plus tard.</p>
            </div>
        `;
        hideLoading('timetable-loading');
    }
}

// --- Gestion du profil ---
document.getElementById('profile-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const fullName = document.getElementById('profile-fullname').value;
    const email = document.getElementById('profile-email').value;
    const phone = document.getElementById('profile-phone').value;
    const newPassword = document.getElementById('profile-new-password').value;
    const confirmPassword = document.getElementById('profile-confirm-password').value;
    
    if (!fullName || !email || !phone) {
        showAlert("Veuillez remplir tous les champs obligatoires", "error");
        return;
    }
    
    if (newPassword && newPassword !== confirmPassword) {
        showAlert("Les mots de passe ne correspondent pas", "error");
        return;
    }
    
    try {
        let photoURL = currentParent.photoURL;
        
        if (parentPhotoFile) {
            photoURL = await uploadToCloudinary(parentPhotoFile, `parents/${currentParent.matricule}`);
        }
        
        const updateData = {
            fullName,
            email,
            phone,
            photoURL,
            updatedAt: serverTimestamp()
        };
        
        await updateDoc(doc(db, 'parents', currentParent.matricule), updateData);
        
        for (const child of childrenList) {
            let studentRef;
            if (child.type === 'secondary') {
                studentRef = doc(db, 'students', child.matricule);
            } else if (child.type === 'primary') {
                studentRef = doc(db, 'primary_students', child.matricule);
            } else {
                // CORRECTION ICI : collection kindergarten_students
                studentRef = doc(db, 'kindergarten_students', child.matricule);
            }
            
            await updateDoc(studentRef, {
                parentName: fullName,
                parentEmail: email,
                parentPhone: phone,
                updatedAt: serverTimestamp()
            });
        }
        
        if (newPassword) {
            showAlert("La modification du mot de passe n√©cessite une r√©initialisation. Veuillez utiliser la fonction 'Mot de passe oubli√©'.", "info");
        }
        
        currentParent = { ...currentParent, ...updateData };
        document.getElementById('parent-name').textContent = fullName;
        
        if (photoURL) {
            document.getElementById('parent-photo-container').innerHTML = `<img src="${photoURL}" class="parent-photo" alt="Photo de profil">`;
        }
        
        showAlert("Profil mis √† jour avec succ√®s", "success");
        parentPhotoFile = null;
        
    } catch (error) {
        console.error("Erreur mise √† jour profil:", error);
        showAlert("Erreur lors de la mise √† jour du profil: " + error.message, "error");
    }
});

// --- Ajout d'un enfant suppl√©mentaire ---
document.getElementById('add-child-account-btn').addEventListener('click', () => {
    document.getElementById('add-child-modal').classList.remove('hidden');
});

document.getElementById('new-child-matricule').addEventListener('blur', async () => {
    const matricule = document.getElementById('new-child-matricule').value;
    const resultEl = document.getElementById('child-verification-result');
    
    if (!matricule) {
        resultEl.classList.add('hidden');
        return;
    }
    
    try {
        // Recherche dans les trois collections d'√©l√®ves
        let studentData = null;
        let studentType = null;
        
        // 1. Recherche dans les √©l√®ves secondaires
        let studentDoc = await getDoc(doc(db, 'students', matricule));
        if (studentDoc.exists()) {
            studentData = studentDoc.data();
            studentType = 'secondary';
        } else {
            // 2. Recherche dans les √©l√®ves primaires
            studentDoc = await getDoc(doc(db, 'primary_students', matricule));
            if (studentDoc.exists()) {
                studentData = studentDoc.data();
                studentType = 'primary';
            } else {
                // 3. Recherche dans les √©l√®ves maternelles - CORRECTION ICI
                studentDoc = await getDoc(doc(db, 'kindergarten_students', matricule));
                if (studentDoc.exists()) {
                    studentData = studentDoc.data();
                    studentType = 'kindergarten';
                }
            }
        }
        
        if (!studentData) {
            resultEl.innerHTML = '<p><i class="fas fa-times-circle"></i> Aucun √©l√®ve trouv√© avec ce matricule</p>';
            resultEl.className = 'alert alert-error';
            resultEl.classList.remove('hidden');
            return;
        }
        
        if (studentData.parentId) {
            resultEl.innerHTML = `<p><i class="fas fa-times-circle"></i> Cet √©l√®ve est d√©j√† associ√© √† un compte parent</p>`;
            resultEl.className = 'alert alert-error';
            resultEl.classList.remove('hidden');
            return;
        }
        
        resultEl.innerHTML = `
            <p><i class="fas fa-check-circle"></i> √âl√®ve trouv√©: <strong>${studentData.fullName}</strong> - <strong>${studentData.class}</strong> (${studentType === 'secondary' ? 'Secondaire' : studentType === 'primary' ? 'Primaire' : 'Maternelle'})</p>
        `;
        resultEl.className = 'alert alert-success';
        resultEl.classList.remove('hidden');
        
    } catch (error) {
        console.error("Erreur v√©rification matricule:", error);
        resultEl.innerHTML = '<p><i class="fas fa-times-circle"></i> Erreur lors de la v√©rification</p>';
        resultEl.className = 'alert alert-error';
        resultEl.classList.remove('hidden');
    }
});

document.getElementById('add-child-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const matricule = document.getElementById('new-child-matricule').value;
    const relation = document.getElementById('child-relation').value;
    
    if (!matricule) {
        showAlert("Veuillez entrer un matricule", "error");
        return;
    }
    
    try {
        // Recherche dans les trois collections d'√©l√®ves
        let studentData = null;
        let studentType = null;
        
        // 1. Recherche dans les √©l√®ves secondaires
        let studentDoc = await getDoc(doc(db, 'students', matricule));
        if (studentDoc.exists()) {
            studentData = studentDoc.data();
            studentType = 'secondary';
        } else {
            // 2. Recherche dans les √©l√®ves primaires
            studentDoc = await getDoc(doc(db, 'primary_students', matricule));
            if (studentDoc.exists()) {
                studentData = studentDoc.data();
                studentType = 'primary';
            } else {
                // 3. Recherche dans les √©l√®ves maternelles - CORRECTION ICI
                studentDoc = await getDoc(doc(db, 'kindergarten_students', matricule));
                if (studentDoc.exists()) {
                    studentData = studentDoc.data();
                    studentType = 'kindergarten';
                }
            }
        }
        
        if (!studentData) {
            showAlert("Aucun √©l√®ve trouv√© avec ce matricule", "error");
            return;
        }
        
        if (studentData.parentId) {
            showAlert("Cet √©l√®ve est d√©j√† associ√© √† un compte parent", "error");
            return;
        }
        
        if (childrenList.find(child => child.matricule === matricule)) {
            showAlert("Cet √©l√®ve est d√©j√† dans votre liste", "error");
            return;
        }
        
        let studentRef;
        if (studentType === 'secondary') {
            studentRef = doc(db, 'students', matricule);
        } else if (studentType === 'primary') {
            studentRef = doc(db, 'primary_students', matricule);
        } else {
            // CORRECTION ICI : collection kindergarten_students
            studentRef = doc(db, 'kindergarten_students', matricule);
        }
        
        await updateDoc(studentRef, {
            parentId: currentParent.matricule,
            parentName: currentParent.fullName,
            parentEmail: currentParent.email,
            parentPhone: currentParent.phone,
            parentRelation: relation,
            updatedAt: serverTimestamp()
        });
        
        const updatedChildren = [...currentParent.children, {
            matricule: matricule,
            type: studentType
        }];
        await updateDoc(doc(db, 'parents', currentParent.matricule), {
            children: updatedChildren,
            updatedAt: serverTimestamp()
        });
        
        currentParent.children = updatedChildren;
        childrenList.push({
            matricule: matricule,
            type: studentType,
            ...studentData
        });
        
        // Mettre √† jour les s√©lecteurs d'enfant
        const displayText = `${studentData.fullName} - ${studentData.class} (${studentType === 'secondary' ? 'Secondaire' : studentType === 'primary' ? 'Primaire' : 'Maternelle'})`;
        
        // Mettre √† jour les s√©lecteurs g√©n√©raux
        const generalSelectors = [
            document.getElementById('child-selector'), 
            document.getElementById('presence-child-selector'),
            document.getElementById('payment-child-selector'),
            document.getElementById('timetable-child-selector')
        ];
        generalSelectors.forEach(s => s.innerHTML += `<option value="${matricule}">${displayText}</option>`);
        
        // Mettre √† jour les s√©lecteurs sp√©cifiques selon le type
        if (studentType === 'secondary') {
            const secondarySelectors = [
                document.getElementById('secondary-grades-child-selector'),
                document.getElementById('secondary-homework-child-selector')
            ];
            secondarySelectors.forEach(s => s.innerHTML += `<option value="${matricule}">${studentData.fullName} - ${studentData.class}</option>`);
        } else if (studentType === 'primary') {
            const primarySelectors = [
                document.getElementById('primary-grades-child-selector'),
                document.getElementById('primary-homework-child-selector')
            ];
            primarySelectors.forEach(s => s.innerHTML += `<option value="${matricule}">${studentData.fullName} - ${studentData.class}</option>`);
        } else {
            const kindergartenSelectors = [
                document.getElementById('kindergarten-grades-child-selector'),
                document.getElementById('kindergarten-homework-child-selector')
            ];
            kindergartenSelectors.forEach(s => s.innerHTML += `<option value="${matricule}">${studentData.fullName} - ${studentData.class}</option>`);
        }
        
        updateChildrenPage();
        
        showAlert("Enfant ajout√© avec succ√®s", "success");
        document.getElementById('add-child-modal').classList.add('hidden');
        document.getElementById('add-child-form').reset();
        document.getElementById('child-verification-result').classList.add('hidden');
        
    } catch (error) {
        console.error("Erreur ajout enfant:", error);
        showAlert("Erreur lors de l'ajout de l'enfant: " + error.message, "error");
    }
});

// --- Navigation ---
document.querySelectorAll('.nav-menu a').forEach(link => {
    link.addEventListener('click', e => {
        e.preventDefault();
        const page = link.dataset.page;
        
        // Marquer les notifications comme lues
        markNotificationsAsRead(page);
        
        const pageId = page + '-page';
        document.querySelectorAll('.nav-menu a, .page').forEach(el => el.classList.remove('active'));
        link.classList.add('active');
        document.getElementById(pageId).classList.add('active');
        document.getElementById('page-title').textContent = link.textContent;
        
        // Fermer le menu sur mobile apr√®s clic
        if (window.innerWidth <= 768) {
            document.querySelector('.sidebar').classList.add('collapsed');
        }
        
        // Charger les donn√©es sp√©cifiques √† la page
        if (page === 'dashboard') {
            // R√©initialiser le s√©lecteur d'enfant
            document.getElementById('child-selector').value = '';
            document.getElementById('child-dashboard-content').classList.add('hidden');





      
        } else if (page === 'presence-incidents') {
            document.getElementById('presence-child-selector').value = '';
            document.getElementById('presence-incidents-content').classList.add('hidden');
        } else if (page === 'payments') {
            document.getElementById('payment-child-selector').value = '';
            document.getElementById('payment-content').classList.add('hidden');
        } else if (page === 'timetable') {
            document.getElementById('timetable-child-selector').value = '';
            document.getElementById('timetable-content').classList.add('hidden');
        } else if (page === 'notifications') {
            // Charger et afficher les notifications
            displayNotifications(document.getElementById('notification-filter').value);
        }
    });
});

// --- Gestion du filtre de notifications ---
document.getElementById('notification-filter').addEventListener('change', (e) => {
    displayNotifications(e.target.value);
});

// --- Gestion du bouton "Tout effacer" pour les notifications ---
document.getElementById('clear-all-notifications-btn').addEventListener('click', clearAllNotifications);

// Fermer les modals
document.querySelectorAll('.close-modal').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.modal').forEach(modal => modal.classList.add('hidden'));
    });
});

// Fermer les modals en cliquant √† l'ext√©rieur
document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.classList.add('hidden');
        }
    });
});

window.closeModal = (modalId) => document.getElementById(modalId).classList.add('hidden');

// === INSTALLATION ET MISE √Ä JOUR DE L'APPLICATION ===

// V√©rifier si le service worker est support√©
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try {
      // Enregistrer le service worker
      const registration = await navigator.serviceWorker.register('./sw.js');
      console.log('‚úÖ Service Worker enregistr√© avec succ√®s:', registration);

      // V√©rifier l'installation de l'application
      checkAppInstallation();
      
      // √âcouter les messages du service worker
      navigator.serviceWorker.addEventListener('message', (event) => {
        if (event.data.type === 'NEW_VERSION_DETECTED') {
          showUpdateNotification(event.data.version, event.data.previousVersion);
        }
        
        if (event.data.type === 'UPDATE_AVAILABLE') {
          showMandatoryUpdateNotification(
            event.data.newVersion, 
            event.data.currentVersion,
            event.data.updateUrl
          );
        }
      });
      
      // V√©rifier les mises √† jour p√©riodiquement
      setInterval(() => {
        checkForUpdates();
      }, 3600000); // Toutes les heures
      
    } catch (error) {
      console.error('‚ùå Erreur lors de l\'enregistrement du Service Worker:', error);
    }
  });
}

// V√©rifier si l'application est install√©e
function checkAppInstallation() {
  // V√©rifier si l'application peut √™tre install√©e
  window.addEventListener('beforeinstallprompt', (event) => {
    // Emp√™cher l'affichage automatique du prompt
    event.preventDefault();
    
    // Stocker l'√©v√©nement pour plus tard
    window.deferredPrompt = event;
    
    // Afficher une notification pour l'installation
    showInstallNotification();
  });

  // V√©rifier si l'application est d√©j√† install√©e
  if (window.matchMedia('(display-mode: standalone)').matches || 
      window.navigator.standalone === true) {
    console.log('‚úÖ Application d√©j√† install√©e');
  } else {
    console.log('üì± Application non install√©e');
  }
}

// Afficher une notification pour l'installation
function showInstallNotification() {
  // V√©rifier si on n'a pas d√©j√† montr√© la notification aujourd'hui
  const lastInstallPrompt = localStorage.getItem('last_install_prompt');
  const today = new Date().toDateString();
  
  if (lastInstallPrompt === today) {
    return; // Ne pas montrer plus d'une fois par jour
  }
  
  // Sauvegarder la date du prompt
  localStorage.setItem('last_install_prompt', today);
  
  // Afficher une notification toast
  const installToast = document.createElement('div');
  installToast.className = 'notification-toast info';
  installToast.innerHTML = `
    <div class="notification-header">
      <div class="notification-title">
        <i class="fas fa-download"></i> Installer l'application
      </div>
      <button class="notification-close">&times;</button>
    </div>
    <div class="notification-body">
      <p>Installez l'application pour un acc√®s plus rapide et une utilisation hors ligne.</p>
      <div class="notification-actions" style="margin-top: 10px;">
        <button class="btn btn-success btn-sm" id="install-app-btn">
          <i class="fas fa-download"></i> Installer
        </button>
        <button class="btn btn-secondary btn-sm" id="later-install-btn">
          Plus tard
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(installToast);
  
  setTimeout(() => {
    installToast.classList.add('show');
  }, 1000);
  
  // G√©rer le bouton d'installation
  document.getElementById('install-app-btn').addEventListener('click', async () => {
    installToast.classList.remove('show');
    setTimeout(() => installToast.remove(), 300);
    
    if (window.deferredPrompt) {
      window.deferredPrompt.prompt();
      const { outcome } = await window.deferredPrompt.userChoice;
      console.log(`R√©sultat de l'installation: ${outcome}`);
      window.deferredPrompt = null;
    }
  });
  
  // G√©rer le bouton "Plus tard"
  document.getElementById('later-install-btn').addEventListener('click', () => {
    installToast.classList.remove('show');
    setTimeout(() => installToast.remove(), 300);
  });
  
  // Fermer le toast
  installToast.querySelector('.notification-close').addEventListener('click', () => {
    installToast.classList.remove('show');
    setTimeout(() => installToast.remove(), 300);
  });
  
  // Fermer automatiquement apr√®s 15 secondes
  setTimeout(() => {
    if (installToast.parentNode) {
      installToast.classList.remove('show');
      setTimeout(() => installToast.remove(), 300);
    }
  }, 15000);
}

// Afficher une notification de mise √† jour
function showUpdateNotification(newVersion, previousVersion) {
  const updateToast = document.createElement('div');
  updateToast.className = 'notification-toast success';
  updateToast.innerHTML = `
    <div class="notification-header">
      <div class="notification-title">
        <i class="fas fa-sync-alt"></i> Mise √† jour disponible
      </div>
      <button class="notification-close">&times;</button>
    </div>
    <div class="notification-body">
      <p>Une nouvelle version (${newVersion}) de l'application est disponible !</p>
      <p><small>Version pr√©c√©dente: ${previousVersion || 'inconnue'}</small></p>
      <div class="notification-actions" style="margin-top: 10px;">
        <button class="btn btn-primary btn-sm" id="update-app-btn">
          <i class="fas fa-redo"></i> Mettre √† jour
        </button>
        <button class="btn btn-secondary btn-sm" id="later-update-btn">
          Plus tard
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(updateToast);
  
  setTimeout(() => {
    updateToast.classList.add('show');
  }, 1000);
  
  // G√©rer le bouton de mise √† jour
  document.getElementById('update-app-btn').addEventListener('click', () => {
    updateToast.classList.remove('show');
    setTimeout(() => updateToast.remove(), 300);
    
    // Recharger la page pour activer la nouvelle version
    window.location.reload();
  });
  
  // G√©rer le bouton "Plus tard"
  document.getElementById('later-update-btn').addEventListener('click', () => {
    updateToast.classList.remove('show');
    setTimeout(() => updateToast.remove(), 300);
  });
  
  // Fermer le toast
  updateToast.querySelector('.notification-close').addEventListener('click', () => {
    updateToast.classList.remove('show');
    setTimeout(() => updateToast.remove(), 300);
  });
}

// Afficher une notification de mise √† jour obligatoire
function showMandatoryUpdateNotification(newVersion, currentVersion, updateUrl) {
  const mandatoryToast = document.createElement('div');
  mandatoryToast.className = 'notification-toast danger';
  mandatoryToast.style.zIndex = '99999'; // Assurez-vous qu'il est au-dessus de tout
  mandatoryToast.innerHTML = `
    <div class="notification-header">
      <div class="notification-title">
        <i class="fas fa-exclamation-triangle"></i> Mise √† jour REQUISE
      </div>
      <button class="notification-close" disabled>&times;</button>
    </div>
    <div class="notification-body">
      <p><strong>Mise √† jour obligatoire !</strong></p>
      <p>La version ${newVersion} est requise pour continuer √† utiliser l'application.</p>
      <p><small>Votre version actuelle: ${currentVersion}</small></p>
      <div class="notification-actions" style="margin-top: 10px;">
        <button class="btn btn-warning btn-sm" id="mandatory-update-btn">
          <i class="fas fa-download"></i> Mettre √† jour maintenant
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(mandatoryToast);
  
  setTimeout(() => {
    mandatoryToast.classList.add('show');
    
    // Bloquer l'interface utilisateur
    const overlay = document.createElement('div');
    overlay.style.position = 'fixed';
    overlay.style.top = '0';
    overlay.style.left = '0';
    overlay.style.width = '100%';
    overlay.style.height = '100%';
    overlay.style.backgroundColor = 'rgba(0,0,0,0.7)';
    overlay.style.zIndex = '99998';
    overlay.id = 'update-overlay';
    document.body.appendChild(overlay);
  }, 500);
  
  // G√©rer le bouton de mise √† jour obligatoire
  document.getElementById('mandatory-update-btn').addEventListener('click', () => {
    // Rediriger vers l'URL de mise √† jour
    window.location.href = updateUrl;
  });
  
  // Emp√™cher la fermeture
  mandatoryToast.querySelector('.notification-close').addEventListener('click', (e) => {
    e.preventDefault();
    showToast('Cette mise √† jour est obligatoire pour continuer √† utiliser l\'application', 'warning');
  });
}

// V√©rifier les mises √† jour manuellement
async function checkForUpdates() {
  try {
    const response = await fetch(`/version-check.json?t=${Date.now()}`);
    const data = await response.json();
    
    // V√©rifier la version actuelle depuis le service worker
    if (navigator.serviceWorker.controller) {
      navigator.serviceWorker.controller.postMessage({
        type: 'GET_VERSION'
      });
    }
    
    // Comparer avec la version stock√©e localement
    const currentVersion = localStorage.getItem('app_version');
    
    if (currentVersion !== data.version) {
      // Nouvelle version disponible
      showUpdateNotification(data.version, currentVersion);
      localStorage.setItem('app_version', data.version);
      
      // Si la mise √† jour est obligatoire
      if (data.mandatory === true) {
        showMandatoryUpdateNotification(data.version, currentVersion, data.updateUrl);
      }
    }
    
  } catch (error) {
    console.error('Erreur lors de la v√©rification des mises √† jour:', error);
  }
}

// V√©rifier la version au chargement
window.addEventListener('load', () => {
  // Stocker la version actuelle
  if (!localStorage.getItem('app_version')) {
    localStorage.setItem('app_version', '1.0.0');
  }
  
  // V√©rifier les mises √† jour apr√®s 5 secondes
  setTimeout(() => {
    checkForUpdates();
  }, 5000);
});

// √âcouter les √©v√©nements de mise √† jour du service worker
let refreshing = false;
navigator.serviceWorker.addEventListener('controllerchange', () => {
  if (!refreshing) {
    refreshing = true;
    window.location.reload();
  }
});

</script>
<script>

// === FONCTIONS DE COMMUNICATION AVEC LE SERVICE WORKER ===

// Envoyer les donn√©es au Service Worker
async function sendDataToServiceWorker() {
    if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
        const parentData = {
            matricule: currentParent?.matricule,
            fullName: currentParent?.fullName,
            children: childrenList.map(child => ({
                matricule: child.matricule,
                fullName: child.fullName,
                class: child.class,
                type: child.type
            }))
        };
        
        navigator.serviceWorker.controller.postMessage({
            type: 'SAVE_PARENT_DATA',
            data: parentData
        });
    }
}

// Demander une v√©rification imm√©diate
function triggerImmediateCheck() {
    if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage({
            type: 'CHECK_NOW'
        });
    }
}

// Afficher une notification via le Service Worker
function showServiceWorkerNotification(title, body, data = {}) {
    if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage({
            type: 'SHOW_NOTIFICATION',
            data: {
                title: title,
                body: body,
                options: {
                    data: data
                }
            }
        });
    }
}

// √âcouter les messages du Service Worker
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.addEventListener('message', (event) => {
        console.log('üì® Message du Service Worker:', event.data);
        
        if (event.data.type === 'NAVIGATE_TO_PAGE') {
            // Naviguer vers la page demand√©e
            const { page, data } = event.data;
            const link = document.querySelector(`.nav-menu a[data-page="${page}"]`);
            if (link) {
                link.click();
                
                // Si un enfant est sp√©cifi√©, le s√©lectionner
                if (data.childId) {
                    setTimeout(() => {
                        if (page === 'grades') {
                            const selector = document.getElementById('secondary-grades-child-selector');
                            if (selector) selector.value = data.childId;
                        } else if (page === 'presence-incidents') {
                            const selector = document.getElementById('presence-child-selector');
                            if (selector) selector.value = data.childId;
                        }
                    }, 1000);
                }
            }
        }
    });
}

// === MODIFICATIONS FINALES ===

// Modifiez votre fonction initializeAllNotifications pour inclure:
async function initializeAllNotifications() {
    // ... code existant ...
    
    // Ajouter:
    // 6. Envoyer les donn√©es au Service Worker
    await sendDataToServiceWorker();
    
    // 7. Inclure le script de background sync
    const script = document.createElement('script');
    script.src = 'background-sync.js';
    document.head.appendChild(script);
}

// Modifiez setupRealTimeNotifications pour utiliser showServiceWorkerNotification
function setupRealTimeNotifications() {
    // ... code existant ...
    
    // Dans chaque onSnapshot, remplacer les notifications locales par:
// Dans setupRealTimeNotifications(), ajoutez cet √©couteur :
for (const child of childrenList) {
    if (child.type === 'secondary') {
        const parentGradesQuery = query(
            collection(db, 'parent_grades'),
            where('className', '==', child.class)
        );
        
        onSnapshot(parentGradesQuery, (snapshot) => {
            snapshot.docChanges().forEach(async (change) => {
                if (change.type === 'added') {
                    const gradeData = change.doc.data();
                    const hasStudentGrade = gradeData.grades?.some(g => 
                        g.studentMatricule === child.matricule
                    );
                    
                    if (hasStudentGrade) {
                        // Cr√©er une notification
                        const notification = {
                            id: `parent_grade_${change.doc.id}_${child.matricule}_${Date.now()}`,
                            title: 'üìä Nouvelles cotes publi√©es',
                            body: `De nouvelles cotes en ${gradeData.subject} ont √©t√© publi√©es pour ${child.fullName}`,
                            type: 'grades',
                            data: {
                                page: 'grades',
                                childId: child.matricule,
                                childName: child.fullName,
                                period: gradeData.period
                            },
                            timestamp: gradeData.publishedAt?.toDate().toISOString() || new Date().toISOString(),
                            read: false
                        };
                        
                        notifications.unshift(notification);
                        updateNotificationCount(1);
                        showNotificationToast(notification);
                        saveNotificationsToStorage();
                    }
                }
            });
        });
    }
}

// Initialiser au chargement
document.addEventListener('DOMContentLoaded', function() {
    // V√©rifier les notifications en attente m√™me sans connexion
    setTimeout(() => {
        if ('Notification' in window && Notification.permission === 'granted') {
            showPendingNotifications();
        }
    }, 3000);
});

</script>


<script>
// Ajoutez ce script apr√®s le modal
document.addEventListener('DOMContentLoaded', function() {
    // Gestionnaire pour le bouton d'impression dans le modal
    document.getElementById('print-communique-btn').addEventListener('click', function() {
        if (window.currentCommuniqueForPrint) {
            printCommuniqueForParent(window.currentCommuniqueForPrint.id);
        }
    });
});

// Fonction pour fermer le modal
function closeModal(modalId) {
    document.getElementById(modalId).classList.add('hidden');
}

</script>

<script>

// Forcer l'affichage des notifications m√™me avec connexion
setInterval(() => {
  if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
    navigator.serviceWorker.controller.postMessage({
      type: 'PING',
      timestamp: Date.now()
    });
  }
}, 30000); // Toutes les 30 secondes
</script>



<script>
// Initialisation imm√©diate
(function() {
  // V√©rifier si Service Worker est support√©
  if ('serviceWorker' in navigator) {
    // Enregistrer le Service Worker imm√©diatement
    window.addEventListener('load', async () => {
      try {
        const registration = await navigator.serviceWorker.register('./sw.js');
        console.log('‚úÖ Service Worker enregistr√© avec succ√®s');
        
        // V√©rifier les mises √† jour toutes les 15 minutes
        setInterval(() => {
          registration.update();
        }, 15 * 60 * 1000);
        
        // V√©rifier maintenant
        setTimeout(() => {
          registration.update();
        }, 10000);
        
      } catch (error) {
        console.error('‚ùå Erreur Service Worker:', error);
      }
    });
  }
  
  // Afficher la version dans la console
  console.log('%cüöÄ CS La Colombe - Espace Parent', 'color: #3498db; font-size: 16px; font-weight: bold;');
  console.log('%cSyst√®me de mise √† jour en temps r√©el activ√©', 'color: #2ecc71;');
  
})();

// Fonctions utilitaires
window.reloadApp = function() {
  window.location.reload();
};

window.clearAppCache = function() {
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(registrations => {
      registrations.forEach(registration => {
        registration.unregister();
      });
    });
  }
  
  caches.keys().then(cacheNames => {
    cacheNames.forEach(cacheName => {
      caches.delete(cacheName);
    });
  });
  
  localStorage.clear();
  sessionStorage.clear();
  
  setTimeout(() => {
    window.location.reload();
  }, 1000);
};
</script>

<script>

// === GESTION DES BADGES D'APPLICATION ===
async function updateAppBadge(count) {
  if (!('setAppBadge' in navigator)) {
    console.log('‚ö†Ô∏è Badges d\'application non support√©s');
    return;
  }
  
  try {
    if (count > 0) {
      await navigator.setAppBadge(count);
      console.log(`‚úÖ Badge mis √† jour: ${count}`);
    } else {
      await navigator.clearAppBadge();
      console.log('‚úÖ Badge effac√©');
    }
    
    // Synchroniser avec le Service Worker
    if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
      navigator.serviceWorker.controller.postMessage({
        type: 'UPDATE_BADGE',
        data: { count }
      });
    }
  } catch (error) {
    console.error('‚ùå Erreur badge:', error);
  }
}

// === FONCTION POUR LES NOTIFICATIONS EN TEMPS R√âEL ===
async function setupRealTimeBackgroundNotifications() {
  if (!currentParent || childrenList.length === 0) return;
  
  console.log('üîî Configuration notifications arri√®re-plan...');
  
  // 1. √âcouter les nouvelles notes
  for (const child of childrenList) {
    if (child.type === 'secondary') {
      const gradesQuery = query(
        collection(db, 'published_grades'),
        where('className', '==', child.class)
      );
      
      onSnapshot(gradesQuery, (snapshot) => {
        snapshot.docChanges().forEach(async (change) => {
          if (change.type === 'added') {
            const gradeData = change.doc.data();
            const hasStudentGrade = gradeData.grades?.some(g => 
              g.studentMatricule === child.matricule
            );
            
            if (hasStudentGrade) {
              await sendBackgroundNotification(
                'üìä Nouvelle note',
                `${child.fullName} a une note en ${gradeData.subject}`,
                {
                  type: 'grades',
                  page: 'grades',
                  childId: child.matricule,
                  childName: child.fullName
                }
              );
              
              // Mettre √† jour le badge
              const currentCount = parseInt(document.getElementById('notification-count').textContent) || 0;
              updateAppBadge(currentCount + 1);
            }
          }
        });
      });
    }
  }
  
  // 2. √âcouter les incidents
  for (const child of childrenList) {
    const incidentsQuery = query(
      collection(db, 'incidents'),
      where('studentMatricule', '==', child.matricule)
    );
    
    onSnapshot(incidentsQuery, (snapshot) => {
      snapshot.docChanges().forEach(async (change) => {
        if (change.type === 'added') {
          await sendBackgroundNotification(
            '‚ö†Ô∏è Nouvel incident',
            `Incident signal√© pour ${child.fullName}`,
            {
              type: 'incidents',
              page: 'presence-incidents',
              childId: child.matricule,
              childName: child.fullName
            }
          );
          
          updateAppBadge(1);
        }
      });
    });
  }
  
  // 3. √âcouter les devoirs
  for (const child of childrenList) {
    if (child.type === 'secondary') {
      const homeworkQuery = query(
        collection(db, 'homework'),
        where('className', '==', child.class)
      );
      
      onSnapshot(homeworkQuery, (snapshot) => {
        snapshot.docChanges().forEach(async (change) => {
          if (change.type === 'added') {
            await sendBackgroundNotification(
              'üìö Nouveau devoir',
              `${child.fullName} a un nouveau devoir`,
              {
                type: 'homework',
                page: 'homework',
                childId: child.matricule,
                childName: child.fullName
              }
            );
            
            updateAppBadge(1);
          }
        });
      });
    }
  }
  
  // 4. √âcouter les communiqu√©s
  if (currentParent) {
    const communiquesQuery = query(
      collection(db, 'parent_communique_relations'),
      where('parentId', '==', currentParent.matricule)
    );
    
    onSnapshot(communiquesQuery, (snapshot) => {
      snapshot.docChanges().forEach(async (change) => {
        if (change.type === 'added') {
          await sendBackgroundNotification(
            'üìÑ Nouveau communiqu√©',
            'Nouveau communiqu√© de paiement disponible',
            {
              type: 'communiques',
              page: 'communiques'
            }
          );
          
          updateAppBadge(1);
        }
      });
    });
  }
}

// === ENVOYER NOTIFICATION ARRI√àRE-PLAN ===
async function sendBackgroundNotification(title, body, data = {}) {
  try {
    // 1. Mettre √† jour le compteur de notifications
    const notificationCount = document.getElementById('notification-count');
    let currentCount = parseInt(notificationCount.textContent) || 0;
    notificationCount.textContent = currentCount + 1;
    notificationCount.classList.remove('hidden');
    
    // 2. Sauvegarder la notification localement
    const notification = {
      id: `notif_${Date.now()}`,
      title,
      body,
      type: data.type || 'general',
      data,
      timestamp: new Date().toISOString(),
      read: false
    };
    
    // 3. Envoyer au Service Worker (m√™me si app ferm√©e)
    if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
      navigator.serviceWorker.controller.postMessage({
        type: 'BACKGROUND_NOTIFICATION',
        data: notification
      });
    }
    
    // 4. Notification locale (si app ouverte)
    if (Notification.permission === 'granted' && !document.hidden) {
      showLocalNotification(title, body, data);
    }
    
    // 5. Mettre √† jour la liste des notifications
    notifications.unshift(notification);
    saveNotificationsToStorage();
    
  } catch (error) {
    console.error('‚ùå Erreur notification arri√®re-plan:', error);
  }
}

// === INITIALISATION COMPL√àTE ===
function initializeCompleteNotificationSystem() {
  // 1. Demander les permissions
  requestNotificationPermission();
  
  // 2. Configurer Firebase Messaging
  setupFirebaseMessaging();
  
  // 3. Lancer les √©couteurs temps r√©el
  setupRealTimeBackgroundNotifications();
  
  // 4. V√©rifier p√©riodiquement
  setInterval(checkForNewData, 5 * 60 * 1000); // Toutes les 5 minutes
  
  // 5. V√©rifier au retour en ligne
  window.addEventListener('online', () => {
    checkForNewData();
    setupRealTimeBackgroundNotifications();
  });
}

// Appeler cette fonction apr√®s la connexion
// Dans onAuthStateChanged, apr√®s currentParent = {...}
initializeCompleteNotificationSystem();</script>

<script>

// background-sync.js - Gestionnaire de synchronisation arri√®re-plan
class BackgroundSyncManager {
    constructor() {
        this.syncInterval = null;
        this.isSyncing = false;
        this.lastSync = localStorage.getItem('last_background_sync') || 0;
        this.syncEnabled = true;
    }
    
    // Initialiser la synchronisation
    async initialize() {
        console.log('üîÑ BackgroundSyncManager: Initialisation');
        
        if (!('serviceWorker' in navigator)) {
            console.log('‚ùå Service Worker non support√©');
            return;
        }
        
        try {
            const registration = await navigator.serviceWorker.ready;
            
            // 1. Enregistrer la synchronisation p√©riodique
            await this.registerPeriodicSync(registration);
            
            // 2. Programmer des v√©rifications
            this.scheduleRegularChecks();
            
            // 3. Premi√®re v√©rification
            setTimeout(() => this.checkForUpdates(), 15000);
            
            console.log('‚úÖ BackgroundSyncManager initialis√©');
            
        } catch (error) {
            console.error('‚ùå Erreur initialisation BackgroundSync:', error);
        }
    }
    
    // Enregistrer la synchronisation p√©riodique
    async registerPeriodicSync(registration) {
        if ('periodicSync' in registration) {
            try {
                const status = await navigator.permissions.query({
                    name: 'periodic-background-sync'
                });
                
                if (status.state === 'granted') {
                    await registration.periodicSync.register('periodic-background-sync', {
                        minInterval: 15 * 60 * 1000, // 15 minutes
                    });
                    console.log('‚úÖ Synchronisation p√©riodique enregistr√©e');
                }
            } catch (error) {
                console.log('‚ö†Ô∏è PeriodicSync non disponible:', error);
            }
        }
    }
    
    // Programmer des v√©rifications
    scheduleRegularChecks() {
        // Toutes les 30 minutes
        this.syncInterval = setInterval(() => {
            this.checkForUpdates();
        }, 30 * 60 * 1000);
        
        // Quand on revient en ligne
        window.addEventListener('online', () => {
            this.checkForUpdates();
        });
        
        // Quand l'app reprend le focus
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                this.checkForUpdates();
            }
        });
    }
    
    // V√©rifier les mises √† jour
    async checkForUpdates() {
        if (this.isSyncing || !navigator.onLine || !this.syncEnabled) {
            return;
        }
        
        this.isSyncing = true;
        
        try {
            console.log('üîç BackgroundSync: V√©rification des mises √† jour...');
            
            // Signaler au Service Worker
            if (navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({
                    type: 'CHECK_NOW',
                    timestamp: Date.now()
                });
            }
            
            this.lastSync = Date.now();
            localStorage.setItem('last_background_sync', this.lastSync);
            
            console.log('‚úÖ BackgroundSync: V√©rification termin√©e');
            
        } catch (error) {
            console.error('‚ùå BackgroundSync: Erreur v√©rification:', error);
        } finally {
            this.isSyncing = false;
        }
    }
    
    // Sauvegarder les donn√©es parent
    async saveParentData(parentData) {
        if (!navigator.serviceWorker.controller) {
            return false;
        }
        
        try {
            navigator.serviceWorker.controller.postMessage({
                type: 'SAVE_PARENT_DATA',
                data: parentData
            });
            
            // Sauvegarder dans IndexedDB
            await this.saveToIndexedDB(parentData);
            
            return true;
            
        } catch (error) {
            console.error('‚ùå Erreur sauvegarde donn√©es:', error);
            return false;
        }
    }
    
    // Sauvegarder dans IndexedDB
    async saveToIndexedDB(data) {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open('ParentBackgroundData', 1);
            
            request.onupgradeneeded = function(event) {
                const db = event.target.result;
                
                if (!db.objectStoreNames.contains('parent')) {
                    db.createObjectStore('parent', { keyPath: 'id' });
                }
                
                if (!db.objectStoreNames.contains('notifications')) {
                    const store = db.createObjectStore('notifications', { keyPath: 'id' });
                    store.createIndex('timestamp', 'timestamp');
                    store.createIndex('read', 'read');
                    store.createIndex('type', 'type');
                }
            };
            
            request.onsuccess = function(event) {
                const db = event.target.result;
                const transaction = db.transaction(['parent'], 'readwrite');
                const store = transaction.objectStore('parent');
                
                store.put({
                    id: 'current',
                    ...data,
                    savedAt: new Date().toISOString()
                });
                
                transaction.oncomplete = function() {
                    console.log('üíæ Donn√©es sauvegard√©es dans IndexedDB');
                    resolve();
                };
                
                transaction.onerror = function(event) {
                    reject(event.target.error);
                };
            };
            
            request.onerror = function(event) {
                reject(event.target.error);
            };
        });
    }
    
    // Activer/d√©sactiver la synchronisation
    setSyncEnabled(enabled) {
        this.syncEnabled = enabled;
        localStorage.setItem('background_sync_enabled', enabled.toString());
        
        if (enabled) {
            this.checkForUpdates();
        }
    }
    
    // Obtenir le statut
    getStatus() {
        return {
            enabled: this.syncEnabled,
            lastSync: this.lastSync,
            isSyncing: this.isSyncing,
            online: navigator.onLine
        };
    }
}

// Exporter l'instance
window.backgroundSyncManager = new BackgroundSyncManager();</script>
<!-- Dans votre index.html, MODIFIEZ ces sections -->

<!-- Service Worker UNIQUE et PRIORITAIRE -->
<script>
// REMPLACER votre bloc d'initialisation actuel par :
if ('serviceWorker' in navigator) {
  // Enregistrer IMM√âDIATEMENT au chargement
  window.addEventListener('load', async () => {
    try {
      // ENREGISTRER DEUX Service Workers pour la redondance
      const [mainSW, firebaseSW] = await Promise.all([
        navigator.serviceWorker.register('sw-immediate.js', {
          scope: '/',
          updateViaCache: 'none' // TOUJOURS v√©rifier les mises √† jour
        }),
        navigator.serviceWorker.register('firebase-sw-immediate.js', {
          scope: '/firebase-cloud-messaging-push-scope'
        })
      ]);
      
      console.log('‚úÖ Service Workers enregistr√©s:', {
        main: mainSW,
        firebase: firebaseSW
      });
      
      // FORCER l'activation
      if (mainSW.active) {
        mainSW.active.postMessage({ type: 'ACTIVATE_NOW' });
      }
      
      // V√©rifier l'√©tat toutes les 10 secondes
      setInterval(() => {
        checkServiceWorkerStatus();
      }, 10000);
      
    } catch (error) {
      console.error('‚ùå Erreur Service Worker:', error);
      // Fallback: essayer le SW de base
      navigator.serviceWorker.register('fallback-sw.js');
    }
  });
  
  // V√©rifier l'√©tat du Service Worker
  async function checkServiceWorkerStatus() {
    const registration = await navigator.serviceWorker.getRegistration();
    if (registration && registration.active) {
      console.log('‚úÖ Service Worker actif - Notifications pr√™tes');
      // Envoyer un ping pour maintenir actif
      registration.active.postMessage({ type: 'PING', timestamp: Date.now() });
    }
  }
  
  // √âcouter les messages du Service Worker
  navigator.serviceWorker.addEventListener('message', (event) => {
    if (event.data.type === 'READY') {
      console.log('üöÄ Service Worker pr√™t pour notifications');
    }
  });
}
</script>
    <script>
        // Bouton d'assistant dans le header
const assistantBtn = document.createElement('button');
assistantBtn.innerHTML = 'ü§ñ Assistant IA';
assistantBtn.onclick = () => openAIAssistant();

function openAIAssistant() {
  const question = prompt('Posez votre question sur la scolarit√©...');
  const assistant = new AIEducationalAssistant();
  const response = assistant.answerQuestion(question, {
    studentId: currentChild.matricule,
    context: 'parent'
  });
  
  showAIDialog(response);
}
    </script>
<!-- Script pour les badges d'application -->
<script>
// Fonction pour mettre √† jour le badge PWA
function updatePwaBadge(count) {
  if (!('setAppBadge' in navigator)) {
    console.log('‚ö†Ô∏è Badges PWA non support√©s');
    return;
  }
  
  try {
    if (count > 0) {
      navigator.setAppBadge(count).then(() => {
        console.log(`‚úÖ Badge PWA: ${count}`);
      }).catch(error => {
        console.error('‚ùå Erreur badge:', error);
      });
    } else {
      navigator.clearAppBadge().then(() => {
        console.log('‚úÖ Badge PWA effac√©');
      }).catch(error => {
        console.error('‚ùå Erreur effacement badge:', error);
      });
    }
  } catch (error) {
    console.error('‚ùå Erreur badge PWA:', error);
  }
}

// Initialiser les badges au chargement
document.addEventListener('DOMContentLoaded', function() {
  // V√©rifier si les badges sont support√©s
  if ('setAppBadge' in navigator) {
    console.log('‚úÖ Badges PWA support√©s');
    
    // Restaurer le badge depuis localStorage
    const savedBadgeCount = localStorage.getItem('pwa_badge_count');
    if (savedBadgeCount && parseInt(savedBadgeCount) > 0) {
      updatePwaBadge(parseInt(savedBadgeCount));
    }
    
    // Synchroniser toutes les 30 secondes
    setInterval(syncPwaBadge, 30000);
  }
});

// Synchroniser le badge PWA
async function syncPwaBadge() {
  if (!window.currentParent || !navigator.onLine) return;
  
  try {
    // R√©cup√©rer le compteur de notifications non lues
    let badgeCount = 0;
    
    // Compter les notifications non lues
    if (window.notificationManager) {
      badgeCount = window.notificationManager.unreadCount;
    }
    
    // Mettre √† jour le badge PWA
    updatePwaBadge(badgeCount);
    
    // Sauvegarder dans localStorage
    localStorage.setItem('pwa_badge_count', badgeCount.toString());
    
  } catch (error) {
    console.error('‚ùå Erreur synchronisation badge:', error);
  }
}

// Effacer le badge quand on visite la page des notifications
function clearPwaBadgeOnView() {
  if ('clearAppBadge' in navigator) {
    navigator.clearAppBadge().catch(console.error);
    localStorage.setItem('pwa_badge_count', '0');
  }
}

// √âcouteur pour la page des notifications
document.addEventListener('DOMContentLoaded', function() {
  const notificationsLink = document.querySelector('[data-page="notifications"]');
  if (notificationsLink) {
    notificationsLink.addEventListener('click', function() {
      setTimeout(clearPwaBadgeOnView, 1000);
    });
  }
});

// Fonction de test pour les badges
window.testBadges = function() {
  if ('setAppBadge' in navigator) {
    // Ajouter un badge de test
    navigator.setAppBadge(5).then(() => {
      console.log('‚úÖ Badge de test ajout√© (5)');
      
      // Effacer apr√®s 5 secondes
      setTimeout(() => {
        navigator.clearAppBadge();
        console.log('‚úÖ Badge effac√©');
      }, 5000);
    });
  } else {
    alert('Les badges ne sont pas support√©s sur ce navigateur');
  }
};
</script>

<!-- Ajoutez un bouton de test dans votre interface -->
<button onclick="testBadges()" style="position: fixed; bottom: 60px; right: 20px; z-index: 9999;">
  Test Badges
</button>
</body>
</html>    
    
    

      
